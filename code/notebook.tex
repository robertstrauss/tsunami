
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{shallowwater019--working-Copy2}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \hypertarget{introduction}{%
\subsection{Introduction}\label{introduction}}

\hypertarget{simulation-of-th-palu-region-tsunami}{%
\subsection{Simulation of th Palu region
Tsunami}\label{simulation-of-th-palu-region-tsunami}}

The following code simulates the Indonesia Palu area Tsunami. To do this
the following steps are required * Define the simulation code * Open
Bathymetry database and extract the ocean depth and land heights for the
region of interest near palu * Set up parameters for finite element grid
* Create Disk Memory Map to Virtual memory to allow processing of arrays
larger than RAM memory during animation * Iterate differential
equations, and periodically generate animation frames Additionally prior
to executing various unit test verifications are run * Define code for
unit test on simple 1-D and 2D problems with well known results *
validate assertions that simulation is correct. * Simulate Palu event
and other hypothetical events over time * plot animations and maximum
height distributions of Tsunami for various initial conditions.

\hypertarget{user-interface}{%
\subsection{User Interface}\label{user-interface}}

\hypertarget{this-is-not-just-an-annotated-program-listing-but-an-interactive-notebook}{%
\subsubsection{This is not just an annotated program listing but an
interactive
notebook}\label{this-is-not-just-an-annotated-program-listing-but-an-interactive-notebook}}

This is Jupyter Notebook intereactive environment. Like a Matalb or
Mathematica Notebook, code is divided into input cells, and if there is
output from a cell it is displayed below it. The entrire notebook can be
run from start to finish like a traditional program or onne can
interactively edit cells (to change parameters or logic) then re-execute
cells out of order.\\
\#\#\# Coding styles for massively parallel computation In the code you
will see a mixture of different styles of code idioms that suited for
different kinds of computing. In places the same basic function is
re-implemented several ways since it's easier to include debugging,
validation code, and \textbf{avoid global variables} in the less
restrictive slower syntaxes. * ``pure'' Python. Strictly scalar
effectively single threaded but allows rich object types * Numpy
(typically \textasciitilde{}20x faster) Rich Matrix Operations.
``Matlab'' copycat syntax, allows operator level multi-processing and
SIMD. * Numba (Can be 100x faster) Fuses arbitrary scalar code and
compiles ``pure'' python into kernels. These become fast complex matrix
operations for Numpy. Restricited syntax and no rich object types. *
Cuda (can be 1000x faster) massively threaded SIMT streaming processors
on GPU. Millions of threads running on thousands of cores. Very
constrained syntax, strong resource constraints. Benefit occurs when
code can thread easily. \#\#\#\# Massively parallel GPU Tsunami
simulation 28 X faster than real time on large ocean grids. Benchmarking
algorithms that depend strongly and non-linearlry on the size and
``parallel-ness'' of the problem doesn't provide a simple picture.
Taking a practical case: On a 50 meter resolution grid, covering
80,000KM\^{}2, the GPU simulation ran 28x real time. For the eight
million point grid, my massively parallel (\textasciitilde{}25,000
threads on thousands of cores) GPU code was 66 times faster than the CPU
code running SIMD and fully parallel, after compilation by Numba. The
Numpy was 40\% real time. The Numpy code was about 4\% real time. It was
too long to make comparable measurements at the same scale in the pure
python, as it would have taken a week. At smaller scales, where the
python code can be benched, the GPU is actually slower than the Numpy
code and so can't be compared. My test hardware is my personal computer:
- CPU: i7-9700K CPU @ 3.60GHz 16GB, 8 core 128bit SIMD per core - GPU:
Nvidia RTX 2070 GPU @ 1.4GHz 8GB (\textasciitilde{}2500 cores,
\textasciitilde{}32000 threads)

Faster than real-time is useful not just for convenience and cost but
also because when seismic events occur in unexpected locations the
hazard zones can be forecasted before the wave arrives.

    \hypertarget{import-libraries}{%
\section{import libraries}\label{import-libraries}}

libraries for math, plotting, user interface, database connnection, GPU
connection, and compiling.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}1}]:} \PY{o}{\PYZpc{}}\PY{k}{matplotlib} notebook
        
        \PY{c+c1}{\PYZsh{} \PYZpc{}env}
        \PY{c+c1}{\PYZsh{} \PYZpc{}env NUMBA\PYZus{}ENABLE\PYZus{}CUDASIM=1}
        \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{k+kn}{import} \PY{n+nn}{numba} \PY{k}{as} \PY{n+nn}{nb}
        \PY{k+kn}{from} \PY{n+nn}{numba} \PY{k}{import} \PY{n}{cuda}
        \PY{k+kn}{import} \PY{n+nn}{operator} \PY{k}{as} \PY{n+nn}{op}
        \PY{k+kn}{import} \PY{n+nn}{time}
        \PY{k+kn}{import} \PY{n+nn}{matplotlib} \PY{k}{as} \PY{n+nn}{mpl}
        \PY{k+kn}{import} \PY{n+nn}{pandas} \PY{k}{as} \PY{n+nn}{pd}
        \PY{k+kn}{from} \PY{n+nn}{pandas} \PY{k}{import} \PY{n}{HDFStore}\PY{p}{,} \PY{n}{DataFrame}
        \PY{k+kn}{from} \PY{n+nn}{matplotlib} \PY{k}{import} \PY{n}{animation}\PY{p}{,} \PY{n}{rc}
        \PY{k+kn}{from} \PY{n+nn}{mpl\PYZus{}toolkits}\PY{n+nn}{.}\PY{n+nn}{mplot3d} \PY{k}{import} \PY{n}{axes3d}
        \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
        \PY{k+kn}{import} \PY{n+nn}{ipywidgets} \PY{k}{as} \PY{n+nn}{widgets}
        \PY{k+kn}{from} \PY{n+nn}{ipywidgets} \PY{k}{import} \PY{n}{interactive}\PY{p}{,} \PY{n}{Button}
        \PY{k+kn}{from} \PY{n+nn}{IPython}\PY{n+nn}{.}\PY{n+nn}{display} \PY{k}{import} \PY{n}{display}\PY{p}{,} \PY{n}{HTML}
        \PY{k+kn}{import} \PY{n+nn}{netCDF4} \PY{k}{as} \PY{n+nn}{nc}
        \PY{k+kn}{from} \PY{n+nn}{math} \PY{k}{import} \PY{n}{sqrt}
        \PY{n}{mysqrt}\PY{o}{=} \PY{n}{sqrt} \PY{c+c1}{\PYZsh{} numba replacement for np.sqrt}
\end{Verbatim}


    \hypertarget{reader-tutorial}{%
\section{Reader Tutorial:}\label{reader-tutorial}}

\hypertarget{examples-of-the-four-coding-styles-from-single-threaded-scalars-to-massiviely-parallel-vectors.}{%
\subsection{Examples of the four coding styles from single threaded
scalars to massiviely parallel
vectors.}\label{examples-of-the-four-coding-styles-from-single-threaded-scalars-to-massiviely-parallel-vectors.}}

So the reader can recognize these in the main code, and not get
confused, here's a trivial example for a scalar times a vector
implemented in the four numerical approaches described above.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{c+c1}{\PYZsh{} just some setup for this demo tutorial}
        
        \PY{n}{N}\PY{o}{=}\PY{l+m+mi}{1000} \PY{c+c1}{\PYZsh{} parameter to set size}
        \PY{n}{X} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{n}{N}\PY{p}{,}\PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)} \PY{c+c1}{\PYZsh{} make a vector of ones, size N, of 4 byte floats}
        \PY{n}{Out} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{empty}\PY{p}{(}\PY{n}{N}\PY{p}{,}\PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)} \PY{c+c1}{\PYZsh{} allocate space to put result}
        \PY{n}{a} \PY{o}{=} \PY{l+m+mi}{2}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{c+c1}{\PYZsh{} numpy vector style (very compact notation for linear algebra)}
        
        \PY{n}{Out}\PY{p}{[}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{a}\PY{o}{*}\PY{n}{X}
        
        \PY{c+c1}{\PYZsh{}\PYZpc{}timeit Out[:]=a*X}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{c+c1}{\PYZsh{} Pure python style with explicit loops}
        
        \PY{k}{def} \PY{n+nf}{pyScale}\PY{p}{(}\PY{n}{a}\PY{p}{,}\PY{n}{X}\PY{p}{,}\PY{n}{Out}\PY{p}{)}\PY{p}{:} 
            \PY{n}{dot} \PY{o}{=} \PY{l+m+mf}{0.0}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{n}{X}\PY{o}{.}\PY{n}{size}\PY{p}{)}\PY{p}{:}
                \PY{n}{Out}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{=}\PY{n}{X}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{*}\PY{n}{a}
        
        \PY{c+c1}{\PYZsh{}\PYZpc{}timeit pyScale(a,X,Out)}
            
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{c+c1}{\PYZsh{} numba style to compile python into a parallel CPU kernel}
        
        \PY{n}{numbaScale} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{njit}\PY{p}{(}\PY{n}{pyScale}\PY{p}{,}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{n}{parallel}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} execute it}
        \PY{n}{numbaScale}\PY{p}{(}\PY{n}{a}\PY{p}{,}\PY{n}{X}\PY{p}{,}\PY{n}{Out}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{}\PYZpc{}timeit numbaScale(a,X,Out)}
\end{Verbatim}


    Lastly, the Cuda code for the GPU.\\
This requires a lot of set up to define the memory management on the GPU
and how the threads will be divided up on the processors on the GPU. The
final function that results is called like other python functions but
uses the GPU memory. The kinds of calculations one can do on a GPU are
more limited than python. So one uses these functions for speed inside
python.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}6}]:} \PY{c+c1}{\PYZsh{}Cuda GPU style.  }
        \PY{c+c1}{\PYZsh{} Limited to on\PYZhy{}device memory and only useful for SIMT vector ops.}
        
        \PY{c+c1}{\PYZsh{} move arrays to dedicated GPU memory}
        \PY{n}{d\PYZus{}X} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{X}\PY{p}{)}
        \PY{n}{d\PYZus{}Out} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{Out}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} kernel for a single thread}
        \PY{k}{def} \PY{n+nf}{pykernel\PYZus{}scale}\PY{p}{(}\PY{n}{a}\PY{p}{,}\PY{n}{X}\PY{p}{,}\PY{n}{Out}\PY{p}{)}\PY{p}{:}
            \PY{n}{i} \PY{o}{=} \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{} thread index}
            \PY{k}{if} \PY{n}{i}\PY{o}{\PYZlt{}}\PY{n}{X}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{:}
                \PY{n}{Out}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{o}{=}\PY{n}{a}\PY{o}{*}\PY{n}{X}\PY{p}{[}\PY{n}{i}\PY{p}{]}
        
        \PY{c+c1}{\PYZsh{} compile the python kernel to GPU code}
        \PY{n}{cuda\PYZus{}scale\PYZus{}kernel} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{n}{pykernel\PYZus{}scale}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} set up array of streaming multiprocessor threads precisely tuned to array size}
        \PY{n}{blockDim} \PY{o}{=} \PY{l+m+mi}{256}  \PY{c+c1}{\PYZsh{} number of threads per streaming multi\PYZhy{}processor}
        \PY{n}{gridDim} \PY{o}{=} \PY{p}{(}\PY{n}{X}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{blockDim}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{blockDim}  \PY{c+c1}{\PYZsh{} number of thread blocks}
        
        \PY{c+c1}{\PYZsh{} Assign streaming multiprocessors and threads}
        \PY{n}{cuda\PYZus{}scale} \PY{o}{=} \PY{n}{cuda\PYZus{}scale\PYZus{}kernel}\PY{p}{[}\PY{n}{gridDim}\PY{p}{,}\PY{n}{blockDim}\PY{p}{]}
        
        \PY{c+c1}{\PYZsh{} this schedules blockDim (\PYZlt{}1024) simultaneous threads on up to gridDim streaming processors each with 2048 cores.}
        \PY{c+c1}{\PYZsh{} thus can have tens of thousands threads on thouands of cores in flight for large arrays}
        
        \PY{c+c1}{\PYZsh{} execute it}
        \PY{n}{cuda\PYZus{}scale}\PY{p}{(}\PY{n}{a}\PY{p}{,}\PY{n}{d\PYZus{}X}\PY{p}{,}\PY{n}{d\PYZus{}Out}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{}\PYZpc{}timeit cuda\PYZus{}scale(a,d\PYZus{}X,d\PYZus{}Out)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}7}]:} \PY{c+c1}{\PYZsh{} cleanup and release GPU and CPU memory from tutorial}
        \PY{k}{del} \PY{n}{d\PYZus{}X}
        \PY{k}{del} \PY{n}{d\PYZus{}Out}
        \PY{k}{del} \PY{n}{X}
        \PY{k}{del} \PY{n}{Out}
\end{Verbatim}


    \hypertarget{define-some-frequently-used-constants}{%
\section{Define some frequently used
constants}\label{define-some-frequently-used-constants}}

Because python defaults to 8 byte ints and floats, whereas GPU memory
busses and CPU SIMD are optimized for 4 byte ints and floats, it's
useful to pre-cast some often used constants.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}8}]:} \PY{c+c1}{\PYZsh{} common constants: pre\PYZhy{}cast to float32 form to speed up calculations.  }
        \PY{c+c1}{\PYZsh{}    convenient to make globals}
        \PY{n}{zero} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{)}
        \PY{n}{p5} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{)}
        \PY{n}{one} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
        \PY{n}{two} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}
\end{Verbatim}


    \hypertarget{utility-function-first-order-derivaties-for-2d-matricies}{%
\section{utility function: First order derivaties for 2D
matricies}\label{utility-function-first-order-derivaties-for-2d-matricies}}

Derivative is formed by taking difference of adjacent values along one
axis, and dividing by delta.

Note while one could define higher order derivative calculations using
additional next-nearest neighbors this not useful here. In the later
code we will be averaging these derivates making them effectively higher
order central differences, and the Rutte Kunga style integrators in use
will further average these over time steps making these effectively
fourth or fifth order in the results even though we begin with simple
first differences.

This is also the first example of using a combination of both Numpy
vector ops, and Numba just-in-time run-time compilation.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}9}]:} \PY{c+c1}{\PYZsh{} First order differential functions}
        
        \PY{c+c1}{\PYZsh{} derivative in x}
        \PY{n+nd}{@nb}\PY{o}{.}\PY{n}{njit}\PY{p}{(}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{n}{parallel}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
        \PY{k}{def} \PY{n+nf}{d\PYZus{}dx}\PY{p}{(}\PY{n}{a}\PY{p}{,} \PY{n}{dx}\PY{p}{)}\PY{p}{:}
            \PY{k}{return} \PY{p}{(} \PY{n}{a}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{a}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{p}{)}\PY{o}{*}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{n}{dx}\PY{p}{)} \PY{c+c1}{\PYZsh{} ddx}
        
        \PY{c+c1}{\PYZsh{} derivative in y}
        \PY{n+nd}{@nb}\PY{o}{.}\PY{n}{njit}\PY{p}{(}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{n}{parallel}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
        \PY{k}{def} \PY{n+nf}{d\PYZus{}dy}\PY{p}{(}\PY{n}{a}\PY{p}{,} \PY{n}{dy}\PY{p}{)}\PY{p}{:}
            \PY{k}{return} \PY{p}{(} \PY{n}{a}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{a}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{p}{)}\PY{o}{*}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{n}{dy}\PY{p}{)}
\end{Verbatim}


    \hypertarget{tsumani-wave-type-examples.}{%
\section{Tsumani Wave type
examples.}\label{tsumani-wave-type-examples.}}

This code will be using two different wave shapes for simulation of
tsunamis. * A simple uplift using a truncated, possibly eliptical,
Gaussian * A ``Seismic'' shape that is sutied to a slip-fault and other
types of waves.

Here are some static images of these common wave models taken from the
literature (see References)

Figure 1: simple 2d disturbance \includegraphics{attachment:image7.png}

    Figure 2: ``seismic'' disturbance, with negative and positive height
deviation \includegraphics{attachment:image8.png}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}10}]:} \PY{c+c1}{\PYZsh{} simple environments or initial conditions}
         
         \PY{c+c1}{\PYZsh{} create a simple 1d gaussian disturbance}
         \PY{k}{def} \PY{n+nf}{lingauss}\PY{p}{(}\PY{n}{shape}\PY{p}{,} \PY{n}{w}\PY{p}{,} \PY{n}{cx} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{,} \PY{n}{cy} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{,} \PY{n}{theta} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{,} \PY{n}{cutoff} \PY{o}{=} \PY{l+m+mf}{0.05}\PY{p}{,} \PY{n}{norm} \PY{o}{=} \PY{k+kc}{False}\PY{p}{)}\PY{p}{:}\PY{c+c1}{\PYZsh{}, win = (\PYZhy{}2, 2)):}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}returns a 1d gaussian on a 2d array of shape \PYZsq{}shape\PYZsq{}\PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{x} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{arange}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{c+c1}{\PYZsh{}linspace( win[0], win[1], shape[0] )}
             \PY{n}{y} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{arange}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{c+c1}{\PYZsh{}linspace( win[0], win[1], shape[1] )}
             \PY{n}{xx}\PY{p}{,} \PY{n}{yy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{meshgrid}\PY{p}{(}\PY{n}{x}\PY{p}{,} \PY{n}{y}\PY{p}{,} \PY{n}{indexing}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ij}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{xy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{o}{*}\PY{p}{(}\PY{n}{xx}\PY{o}{\PYZhy{}}\PY{n}{cx}\PY{p}{)} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{o}{*}\PY{p}{(}\PY{n}{yy}\PY{o}{\PYZhy{}}\PY{n}{cy}\PY{p}{)} \PY{c+c1}{\PYZsh{} lin comb of x, y, to rotate gaussian}
             \PY{n}{h} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{exp}\PY{p}{(} \PY{o}{\PYZhy{}} \PY{p}{(} \PY{n}{xy}\PY{o}{*}\PY{n}{xy} \PY{p}{)} \PY{o}{/} \PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{w}\PY{o}{*}\PY{n}{w}\PY{p}{)} \PY{p}{)}
             \PY{k}{if} \PY{n}{norm}\PY{p}{:}
                 \PY{n}{h} \PY{o}{=} \PY{n}{h} \PY{o}{/} \PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{two}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{p}{)}\PY{o}{*}\PY{n}{w}\PY{p}{)}
             \PY{n}{h} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{cutoff}
             \PY{n}{h}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{less}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{zero}\PY{p}{)}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
             \PY{k}{return} \PY{p}{(}\PY{n}{h}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} creates a simple 2d disturbance (see figure 1)}
         \PY{k}{def} \PY{n+nf}{planegauss}\PY{p}{(}\PY{n}{shape}\PY{p}{,} \PY{n}{wx}\PY{p}{,} \PY{n}{wy}\PY{p}{,} \PY{n}{cx}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{cy}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{theta} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{,} \PY{n}{cutoff} \PY{o}{=} \PY{l+m+mf}{0.05}\PY{p}{,} \PY{n}{norm} \PY{o}{=} \PY{k+kc}{False}\PY{p}{)}\PY{p}{:}
             \PY{n}{h1} \PY{o}{=} \PY{n}{lingauss}\PY{p}{(}\PY{n}{shape}\PY{p}{,} \PY{n}{wx}\PY{p}{,} \PY{n}{cx}\PY{o}{=}\PY{n}{cx}\PY{p}{,} \PY{n}{cy}\PY{o}{=}\PY{n}{cy}\PY{p}{,} \PY{n}{theta} \PY{o}{=} \PY{n}{theta}\PY{p}{,} \PY{n}{cutoff}\PY{o}{=}\PY{n}{cutoff}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{n}{norm}\PY{p}{)}
             \PY{n}{h2} \PY{o}{=} \PY{n}{lingauss}\PY{p}{(}\PY{n}{shape}\PY{p}{,} \PY{n}{wy}\PY{p}{,} \PY{n}{cx}\PY{o}{=}\PY{n}{cx}\PY{p}{,} \PY{n}{cy}\PY{o}{=}\PY{n}{cy}\PY{p}{,} \PY{n}{theta} \PY{o}{=} \PY{n}{theta} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{cutoff}\PY{o}{=}\PY{n}{cutoff}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{n}{norm}\PY{p}{)}
             \PY{k}{return} \PY{n}{h1}\PY{o}{*}\PY{n}{h2}
         
         \PY{c+c1}{\PYZsh{} creates a \PYZdq{}seismic\PYZdq{} distrubance, with negative and positive height deviation (see figure 2)}
         \PY{k}{def} \PY{n+nf}{seismic}\PY{p}{(}\PY{n}{shape}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{length}\PY{p}{,} \PY{n}{cx}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{cy}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{theta}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{a1} \PY{o}{=} \PY{l+m+mi}{1}\PY{p}{,} \PY{n}{a2} \PY{o}{=} \PY{l+m+mi}{1}\PY{p}{,} \PY{n}{cutoff}\PY{o}{=}\PY{l+m+mf}{0.05}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}returns simple seismic initial condition on array with shape \PYZsq{}shape\PYZsq{}}
         \PY{l+s+sd}{        theta \PYZhy{} angle of rotation}
         \PY{l+s+sd}{        length \PYZhy{} length across distrubance}
         \PY{l+s+sd}{        width \PYZhy{} width across disturbance}
         \PY{l+s+sd}{        a1 \PYZhy{} amplitude of positive portion of distrubance}
         \PY{l+s+sd}{        a2 \PYZhy{} amplitude of negative portion of disturbance}
         \PY{l+s+sd}{        cx \PYZhy{} the x position of the distrubance}
         \PY{l+s+sd}{        cy \PYZhy{} the y position of the disturbance}
         \PY{l+s+sd}{        cutoff \PYZhy{} the magnitude below which values are rounded to zero\PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{offx} \PY{o}{=} \PY{n}{width}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{0.5}
             \PY{n}{offy} \PY{o}{=} \PY{n}{width}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{0.5}
             \PY{n}{h1} \PY{o}{=} \PY{n}{a1}\PY{o}{*}\PY{n}{planegauss}\PY{p}{(}\PY{n}{shape}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{length}\PY{p}{,} \PY{n}{cx}\PY{o}{=}\PY{n}{cx}\PY{o}{+}\PY{n}{offx}\PY{p}{,} \PY{n}{cy}\PY{o}{=}\PY{n}{cy}\PY{o}{+}\PY{n}{offy}\PY{p}{,} \PY{n}{theta} \PY{o}{=} \PY{n}{theta}\PY{p}{,} \PY{n}{cutoff}\PY{o}{=}\PY{n}{cutoff}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{n}{norm}\PY{p}{)} \PY{c+c1}{\PYZsh{} \PYZsq{}hill\PYZsq{}}
             \PY{n}{h2} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{a2}\PY{o}{*}\PY{n}{planegauss}\PY{p}{(}\PY{n}{shape}\PY{p}{,} \PY{n}{width}\PY{p}{,} \PY{n}{length}\PY{p}{,} \PY{n}{cx}\PY{o}{=}\PY{n}{cx}\PY{o}{\PYZhy{}}\PY{n}{offx}\PY{p}{,} \PY{n}{cy}\PY{o}{=}\PY{n}{cy}\PY{o}{\PYZhy{}}\PY{n}{offy}\PY{p}{,} \PY{n}{theta} \PY{o}{=} \PY{n}{theta}\PY{p}{,} \PY{n}{cutoff}\PY{o}{=}\PY{n}{cutoff}\PY{p}{,} \PY{n}{norm}\PY{o}{=}\PY{n}{norm}\PY{p}{)} \PY{c+c1}{\PYZsh{} \PYZsq{}valley\PYZsq{}}
             \PY{k}{return} \PY{n}{h1}\PY{o}{+}\PY{n}{h2}
\end{Verbatim}


    \hypertarget{setup-simulation}{%
\subsection{Setup simulation}\label{setup-simulation}}

The simulation requires specifying the location on earth, the size of
the simulation region. The resolution in space is set. This detemines
the maximum time step via the CDL condition relating grid size and wave
speed. \#\#\# Adjustable paramters This model has only two ajustable
physics parameters and the results are not sensitive to these. One is
the friction coefficient, and the other is the depth defining where the
coastal land starts.

These are not set by fitting them to data but simply set to practical
values. The friction damps instabilities so it is set to the lowest
value where the time steppers are stable. The coastal edge is set 1 to
15 meters off shore ahead of the surf zone where the Shallow Water
equations don't apply. The bigger the Tsunami wave the further out the
surf zone is set. This is not important to the maximum wave height
comparisons.

All of the rest of the parameters are physical constants like gravity
and water density. Because the GPU complier puts restrictions on how
constants are declared, most of the constants are defined in the code
itself or are globals rather than python objects.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}11}]:} \PY{c+c1}{\PYZsh{} physics constants}
         \PY{k}{class} \PY{n+nc}{p}\PY{p}{(}\PY{p}{)}\PY{p}{:}
             \PY{n}{g} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{9.81}\PY{p}{)} \PY{c+c1}{\PYZsh{} gravity}
\end{Verbatim}


    \hypertarget{boundary-contitions}{%
\section{Boundary Contitions}\label{boundary-contitions}}

\hypertarget{handling-landcoastline-and-the-limits-of-the-simulated-area}{%
\subsection{handling land/coastline and the limits of the simulated
area}\label{handling-landcoastline-and-the-limits-of-the-simulated-area}}

There are two different boundaries that are handled differently * The
Land and Land-sea boundary Reflective boundary condition at the
interface by setting the X and Y Velocity is set to zero.

\begin{itemize}
\tightlist
\item
   Non-Reflective borders Exiting boundary conditions. At the edges of
  the simulation matrix the wave height and wave speeds are very slowly
  atteunated over a margin region to prevent unwanted reflections for
  these artifical boundaries. This approximates the waves exiting the
  simulation region.
\end{itemize}

\hypertarget{vector-code-style}{%
\subsubsection{Vector code style}\label{vector-code-style}}

Here we see that the same methods are implemented two different ways. *
Numpy vector syntax * Cuda GPU syntax

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}12}]:} \PY{c+c1}{\PYZsh{} functions to handle coast and boundaries}
         
         \PY{k}{def} \PY{n+nf}{land}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{coastx}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} how to handle land/above water area}
             \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{)}\PY{p}{[}\PY{n}{coastx}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
             \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{[}\PY{n}{coastx}\PY{p}{]} \PY{o}{=} \PY{n}{zero} \PY{c+c1}{\PYZsh{} set vel. on either side of land to zero, makes reflective}
             \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{)}\PY{p}{[}\PY{n}{coastx}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
             \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{[}\PY{n}{coastx}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
         \PY{c+c1}{\PYZsh{}     n[coastx] = zero}
             \PY{k}{return} \PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{)}
         
         
         \PY{k}{def} \PY{n+nf}{border}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{margwidth}\PY{o}{=}\PY{l+m+mi}{15}\PY{p}{,} \PY{n}{alph}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{l+m+mf}{0.95}\PY{p}{,} \PY{l+m+mf}{0.95}\PY{p}{,} \PY{l+m+mf}{0.95}\PY{p}{,} \PY{l+m+mf}{0.5}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}near one = fake exiting ( attenuate off edges)}
         \PY{l+s+sd}{    1 = reflective\PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{c+c1}{\PYZsh{} attenuate off edges to minimize reflections}
             \PY{n}{n}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{margwidth}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{u}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{margwidth}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{v}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{margwidth}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             
             \PY{n}{n}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{n}{margwidth}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{u}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{n}{margwidth}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{v}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{n}{margwidth}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
             
             \PY{n}{n}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{margwidth}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}
             \PY{n}{u}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{margwidth}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}
             \PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{margwidth}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}
             
             \PY{n}{n}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{n}{margwidth}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}
             \PY{n}{u}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{n}{margwidth}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}
             \PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{n}{margwidth}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}
             
         \PY{c+c1}{\PYZsh{}     return n, u, v}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}13}]:} \PY{n+nd}{@nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{k}{def} \PY{n+nf}{land\PYZus{}cuda}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{coastx}\PY{p}{)}\PY{p}{:}  \PY{c+c1}{\PYZsh{} call with gridn}
             \PY{n}{iy} \PY{p}{,}\PY{n}{jx}\PY{o}{=} \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{k}{if} \PY{n}{coastx}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{p}{:}
                 \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
                 \PY{n}{u}\PY{p}{[}\PY{n}{jx}  \PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
                 \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
                 \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}  \PY{p}{]} \PY{o}{=} \PY{n}{zero}
         \PY{c+c1}{\PYZsh{}     return u, v}
         
         
         
         \PY{n+nd}{@nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{k}{def} \PY{n+nf}{bordery\PYZus{}cuda}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{a1}\PY{p}{,}\PY{n}{a3}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}near one = fake exiting ( attenuate off edges)}
         \PY{l+s+sd}{    1 = reflective\PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{iy}\PY{p}{,}\PY{n}{jx} \PY{o}{=}  \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)} 
             \PY{k}{if} \PY{p}{(}\PY{n}{jx}\PY{o}{\PYZlt{}}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:} 
                 \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a1}
                 \PY{n}{v}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a3} 
                 \PY{k}{if} \PY{p}{(}\PY{n}{iy}\PY{o}{\PYZlt{}}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a1}
                     \PY{n}{n}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a3}
                \PY{c+c1}{\PYZsh{} if (iy\PYZlt{}u.shape[0]):    }
                     \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a1}
                     \PY{n}{u}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a3}
         
             
         \PY{n+nd}{@nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}    
         \PY{k}{def} \PY{n+nf}{borderx\PYZus{}cuda}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{a0}\PY{p}{,}\PY{n}{a2}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}near one = fake exiting ( attenuate off edges)}
         \PY{l+s+sd}{    1 = reflective\PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{iy}\PY{p}{,}\PY{n}{jx} \PY{o}{=}  \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{k}{if} \PY{p}{(}\PY{n}{jx}\PY{o}{\PYZlt{}}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}    
                 \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a0}
                 \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a2}
                 \PY{k}{if} \PY{p}{(}\PY{n}{jx}\PY{o}{\PYZlt{}}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a0}
                     \PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a2}
               \PY{c+c1}{\PYZsh{}  if (jx\PYZlt{}v.shape[0]):    }
                     \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a0}
                     \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{n}{iy}\PY{p}{]} \PY{o}{*}\PY{o}{=} \PY{n}{a2} 
             
         \PY{k}{def} \PY{n+nf}{border\PYZus{}cuda}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{margwidth}\PY{o}{=}\PY{l+m+mi}{16}\PY{p}{,} \PY{n}{alph}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{p}{[}\PY{l+m+mf}{0.95}\PY{p}{,} \PY{l+m+mf}{0.95}\PY{p}{,} \PY{l+m+mf}{0.95}\PY{p}{,} \PY{l+m+mf}{0.95}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{:}
             \PY{n}{threadblock} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{16}\PY{p}{,}\PY{l+m+mi}{16}\PY{p}{)}
             \PY{n}{grid1} \PY{o}{=} \PY{p}{(}\PY{p}{(}\PY{n}{marginwidth}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PYZbs{}
                     \PY{p}{(}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}    \PY{c+c1}{\PYZsh{} u is longer thanv}
             \PY{n}{grid2} \PY{o}{=} \PY{p}{(}\PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PYZbs{}
                     \PY{p}{(}\PY{n}{marginwidth}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{borderx\PYZus{}cuda}\PY{p}{[}\PY{n}{grid1}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}  \PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}
             \PY{n}{bordery\PYZus{}cuda}\PY{p}{[}\PY{n}{grid2}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}  \PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}\PY{n}{alph}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{)}
\end{Verbatim}


    \hypertarget{physics-model}{%
\subsection{Physics model}\label{physics-model}}

The core simulation engine will simulate the shallow water differential
equations.

Equations of motion \[
\begin{align}
\frac{\partial \eta}{\partial t} & =
    -\frac{\partial  }{\partial x} \bigl( \left( \eta + h\right)u \bigr) 
    - \frac{\partial  }{\partial y}  \bigl( \left( \eta + h\right)v \bigr)\\  
\\
\frac{\partial u}{\partial t} & = Coriolis + Advection + Gravity + Attenuation\\
 & = +fv +\bigl( \kappa\nabla^{2}u - (u,v)\cdot\vec\nabla u \bigr)  
    - g\frac{\partial \eta}{\partial x} - \frac{1}{\rho (h + \eta)} \mu u \sqrt{u^{2} + v^{2}}\\  
& = +fv +\bigl( \kappa\frac{\partial^{2} u}{\partial x^{2}}
           +\kappa\frac{\partial^{2} u}{\partial y^{2}}
           -u\frac{\partial u}{\partial x} - v\frac{\partial u}{\partial y}\bigr) 
           - g\frac{\partial \eta}{\partial x}
            - \frac{1}{\rho (h + \eta)} \mu u \sqrt{u^{2} + v^{2}}\\
\\
\frac{\partial v}{\partial t} & = -fu 
   + \bigl( \kappa\nabla^{2}v - (u,v)\cdot\vec\nabla v \bigr) 
    - g\frac{\partial \eta}{\partial y}
    - \frac{1}{\rho (h + \eta)} \mu v \sqrt{u^{2} + v^{2}}\\   
& = -fu+\bigl( \kappa\frac{\partial^{2} v}{\partial x^{2}}
           +\kappa\frac{\partial^{2} v}{\partial y^{2}}
           -u\frac{\partial v}{\partial x} - v\frac{\partial v}{\partial y}\bigr) 
           - g\frac{\partial \eta}{\partial y}
           - \frac{1}{\rho (h + \eta)} \mu v \sqrt{u^{2} + v^{2}}\\           
\end{align}
\]

Where - \emph{\emph{h}} calm ocean depth (positive number) at any point.
Presumed constant in time - \(\eta\) is the wave height or sea surface
height deviation from normal - \emph{\emph{u}} is the mean water column
velocity in the \emph{x} (east) direction - \emph{v} is the mean water
column velocity in the \emph{y} (north) direction

and the physcial constant parameters are: - \emph{g} gravitational
constant - \emph{f} is the lattidude dependent coriolis coefficient:
\(2\omega \sin(latitude)\) - \(\kappa\) is the viscous damping
coefficient across the grid cell boundaries - \(\mu\) is the friction
coeffecient

    \hypertarget{rate-of-change-of-wave-height-dndt}{%
\section{Rate of change of wave height
dn/dt}\label{rate-of-change-of-wave-height-dndt}}

This is implemented 3 ways * Numpy Matrix style * Numba Compiled * GPU
Kernel

    \hypertarget{numpy-matrix-style}{%
\subsubsection{Numpy Matrix Style}\label{numpy-matrix-style}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}14}]:} \PY{c+c1}{\PYZsh{} numpy style with  matrix notation}
         
         \PY{k}{def} \PY{n+nf}{dndt}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{)} \PY{p}{:}
         \PY{c+c1}{\PYZsh{} def dndt(state):}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}change in n per timestep, by diff. equations\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{c+c1}{\PYZsh{}     h, n, u, v, dx, dy = [qp.asnumpy(state.\PYZus{}\PYZus{}dict\PYZus{}\PYZus{}[k]) for k in (\PYZsq{}h\PYZsq{}, \PYZsq{}n\PYZsq{}, \PYZsq{}u\PYZsq{}, \PYZsq{}v\PYZsq{}, \PYZsq{}dx\PYZsq{}, \PYZsq{}dy\PYZsq{})]}
             \PY{n}{hx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{empty}\PY{p}{(}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{n}\PY{o}{.}\PY{n}{dtype}\PY{p}{)} \PY{c+c1}{\PYZsh{} to be x (u) momentum array}
             \PY{n}{hy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{empty}\PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{n}\PY{o}{.}\PY{n}{dtype}\PY{p}{)}
             
             \PY{n}{depth} \PY{o}{=} \PY{n}{h}\PY{o}{+}\PY{n}{n}
             \PY{n}{hx}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{depth}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{depth}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5} \PY{c+c1}{\PYZsh{} average}
             \PY{n}{hx}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{zero} \PY{c+c1}{\PYZsh{} normal flow boundaries/borders}
             \PY{n}{hx}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{zero} \PY{c+c1}{\PYZsh{} the water exiting the water on the edge is n+h}
             
             \PY{n}{hy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{p}{(}\PY{n}{depth}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{depth}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             \PY{n}{hy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
             \PY{n}{hy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{zero}   
             
             \PY{n}{hx} \PY{o}{*}\PY{o}{=} \PY{n}{u} \PY{c+c1}{\PYZsh{} height/mass\PYZhy{}\PYZgt{}momentum of water column.}
             \PY{n}{hy} \PY{o}{*}\PY{o}{=} \PY{n}{v}
             \PY{n}{out}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{d\PYZus{}dx}\PY{p}{(}\PY{n}{hx}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{dx}\PY{p}{)}\PY{o}{+}\PY{n}{d\PYZus{}dy}\PY{p}{(}\PY{n}{hy}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{dy}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}     return ( d\PYZus{}dx(hx, \PYZhy{}dx)+d\PYZus{}dy(hy, \PYZhy{}dy) )}
          \PY{c+c1}{\PYZsh{} change in x vel. (u) per timestep}
\end{Verbatim}


    \hypertarget{numba-style-and-cpu-compiler}{%
\subsubsection{Numba Style and CPU
compiler}\label{numba-style-and-cpu-compiler}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}15}]:} \PY{c+c1}{\PYZsh{} Single thread scalar function in python}
         \PY{k}{def} \PY{n+nf}{dndt2a}\PY{p}{(}\PY{n}{jx}\PY{p}{,} \PY{n}{iy}\PY{p}{,} \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{)} \PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}change in n per timestep, by diff. equations\PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{p5} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{)}
             \PY{n}{depth\PYZus{}jm0im0} \PY{o}{=} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}  \PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}    \PY{n}{iy}\PY{p}{]}
             \PY{n}{depth\PYZus{}jp1im0} \PY{o}{=} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}  \PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}
             \PY{n}{depth\PYZus{}jm1im0} \PY{o}{=} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}  \PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}
             \PY{n}{depth\PYZus{}jm0ip1} \PY{o}{=} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{depth\PYZus{}jm0im1} \PY{o}{=} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}
             
             \PY{n}{hx\PYZus{}jp1} \PY{o}{=} \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{depth\PYZus{}jm0im0} \PY{o}{+} \PY{n}{depth\PYZus{}jp1im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             \PY{n}{hx\PYZus{}jm0} \PY{o}{=} \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{depth\PYZus{}jm1im0} \PY{o}{+} \PY{n}{depth\PYZus{}jm0im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             
             
             \PY{n}{hy\PYZus{}ip1} \PY{o}{=} \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{depth\PYZus{}jm0im0} \PY{o}{+} \PY{n}{depth\PYZus{}jm0ip1}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             \PY{n}{hy\PYZus{}im0} \PY{o}{=} \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}  \PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{depth\PYZus{}jm0im1} \PY{o}{+} \PY{n}{depth\PYZus{}jm0im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             
             \PY{c+c1}{\PYZsh{} assume u and v are zero on edge}
             \PY{n}{dhx} \PY{o}{=} \PY{p}{(}\PY{n}{hx\PYZus{}jp1}\PY{o}{\PYZhy{}}\PY{n}{hx\PYZus{}jm0}\PY{p}{)}\PY{o}{/}\PY{n}{dx}\PY{c+c1}{\PYZsh{}[jx,iy]}
             \PY{n}{dhy} \PY{o}{=} \PY{p}{(}\PY{n}{hy\PYZus{}ip1}\PY{o}{\PYZhy{}}\PY{n}{hy\PYZus{}im0}\PY{p}{)}\PY{o}{/}\PY{n}{dy}\PY{c+c1}{\PYZsh{}[jx,iy]}
         
          
             \PY{k}{return} \PY{p}{(} \PY{o}{\PYZhy{}}\PY{n}{dhx}\PY{o}{\PYZhy{}}\PY{n}{dhy} \PY{p}{)}
         \PY{c+c1}{\PYZsh{} numba kernel to drive threads in parallel}
         \PY{k}{def} \PY{n+nf}{dndta\PYZus{}drive\PYZus{}py}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{)}\PY{p}{:}      
             \PY{k}{for} \PY{n}{jx64} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}  
                 \PY{k}{for} \PY{n}{iy64} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                     \PY{n}{jx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{(}\PY{n}{jx64}\PY{p}{)}
                     \PY{n}{iy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{(}\PY{n}{iy64}\PY{p}{)}
                     \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{dndt2a\PYZus{}numba}\PY{p}{(}\PY{n}{jx}\PY{p}{,} \PY{n}{iy}\PY{p}{,} \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{)}
             \PY{k}{for} \PY{n}{iy} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{out}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{iy}\PY{p}{]} \PY{c+c1}{\PYZsh{} reflective boundary condition }
                 \PY{n}{out}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{out}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{,}\PY{n}{iy}\PY{p}{]} 
             \PY{k}{for} \PY{n}{jx} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]} 
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{p}{]}    
           
                 
         \PY{c+c1}{\PYZsh{} the following matches the numpy syntax e but isn\PYZsq{}t as good a boundary condition}
         \PY{k}{def} \PY{n+nf}{dndt2b}\PY{p}{(}\PY{n}{jx}\PY{p}{,} \PY{n}{iy}\PY{p}{,} \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{)} \PY{p}{:}
         
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}change in n per timestep, by diff. equations\PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{p5} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{)}
             
             \PY{n}{depth\PYZus{}jm0im0} \PY{o}{=} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}  \PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}    \PY{n}{iy}\PY{p}{]}
             
             \PY{k}{if} \PY{n}{jx}\PY{o}{==}\PY{n}{h}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
                 \PY{n}{hx\PYZus{}jp1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{)}
                 \PY{n}{hx\PYZus{}jm0} \PY{o}{=} \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{p}{]}\PY{o}{*}\PY{p}{(} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}  \PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{+} \PY{n}{depth\PYZus{}jm0im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             \PY{k}{else}\PY{p}{:}
                 \PY{n}{hx\PYZus{}jp1} \PY{o}{=} \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{depth\PYZus{}jm0im0} \PY{o}{+} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}  \PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{k}{if} \PY{n}{jx}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:}
                     \PY{n}{hx\PYZus{}jm0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{)}
                 \PY{k}{else}\PY{p}{:}
                     \PY{n}{hx\PYZus{}jm0} \PY{o}{=} \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{p}{]}\PY{o}{*}\PY{p}{(} \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}  \PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{+} \PY{n}{depth\PYZus{}jm0im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                     
             \PY{k}{if} \PY{n}{iy} \PY{o}{==}\PY{n}{h}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
                 \PY{n}{hy\PYZus{}ip1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
                 \PY{n}{hy\PYZus{}im0} \PY{o}{=} \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}  \PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{n}{depth\PYZus{}jm0im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             \PY{k}{else}\PY{p}{:}
                 \PY{n}{hy\PYZus{}ip1} \PY{o}{=} \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{depth\PYZus{}jm0im0} \PY{o}{+}  \PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{k}{if} \PY{n}{iy} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                     \PY{n}{hy\PYZus{}im0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
                 \PY{k}{else}\PY{p}{:} 
                     \PY{n}{hy\PYZus{}im0} \PY{o}{=} \PY{n}{v}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}  \PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{h}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}  \PY{n}{iy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{n}{depth\PYZus{}jm0im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             
             \PY{c+c1}{\PYZsh{} assume u and v are zero on edge}
             \PY{n}{dhx} \PY{o}{=} \PY{p}{(}\PY{n}{hx\PYZus{}jp1}\PY{o}{\PYZhy{}}\PY{n}{hx\PYZus{}jm0}\PY{p}{)}\PY{o}{/}\PY{n}{dx}\PY{c+c1}{\PYZsh{}[jx,iy]}
             \PY{n}{dhy} \PY{o}{=} \PY{p}{(}\PY{n}{hy\PYZus{}ip1}\PY{o}{\PYZhy{}}\PY{n}{hy\PYZus{}im0}\PY{p}{)}\PY{o}{/}\PY{n}{dy}\PY{c+c1}{\PYZsh{}[jx,iy]}
         
             \PY{k}{return} \PY{p}{(} \PY{o}{\PYZhy{}}\PY{n}{dhx}\PY{o}{\PYZhy{}}\PY{n}{dhy} \PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} numba kernel to drive function }
         \PY{k}{def} \PY{n+nf}{dndtb\PYZus{}drive\PYZus{}py}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{)}\PY{p}{:}      
             \PY{k}{for} \PY{n}{jx64} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}  
                 \PY{k}{for} \PY{n}{iy64} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{jx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{(}\PY{n}{jx64}\PY{p}{)}  \PY{c+c1}{\PYZsh{} remove?}
                     \PY{n}{iy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{(}\PY{n}{iy64}\PY{p}{)}
                     \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{dndt2b\PYZus{}numba}\PY{p}{(}\PY{n}{jx}\PY{p}{,} \PY{n}{iy}\PY{p}{,} \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{)}
         
         \PY{k}{def} \PY{n+nf}{dndtc\PYZus{}drive\PYZus{}py}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{)}\PY{p}{:}      
             \PY{k}{for} \PY{n}{jx64} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{jx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{(}\PY{n}{jx64}\PY{p}{)}  \PY{c+c1}{\PYZsh{} remove?}
                 \PY{k}{if} \PY{n}{jx} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                     \PY{n}{jx} \PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
                 \PY{k}{elif} \PY{n}{jx} \PY{o}{==} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
                     \PY{n}{jx} \PY{o}{\PYZhy{}}\PY{o}{=}\PY{l+m+mi}{1}
                         \PY{c+c1}{\PYZsh{} positive reflection }
                 \PY{k}{for} \PY{n}{iy64} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                     \PY{n}{iy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{(}\PY{n}{iy64}\PY{p}{)}
                     \PY{k}{if} \PY{n}{iy}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:}
                         \PY{n}{iy} \PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
                     \PY{k}{elif} \PY{n}{iy} \PY{o}{==} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}   
                         \PY{n}{iy} \PY{o}{\PYZhy{}}\PY{o}{=}\PY{l+m+mi}{1}
                         
                     \PY{n}{out}\PY{p}{[}\PY{n}{jx64}\PY{p}{,}\PY{n}{iy64}\PY{p}{]} \PY{o}{=} \PY{n}{dndt2b\PYZus{}numba}\PY{p}{(}\PY{n}{jx}\PY{p}{,} \PY{n}{iy}\PY{p}{,} \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{)}           
         
         \PY{c+c1}{\PYZsh{} compile the scalar function to a cuda device function}
         \PY{n}{ndevice\PYZus{}compiler\PYZus{}numba} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{njit}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{float32(int32,int32,float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{parallel}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{n}{dndt2b\PYZus{}numba} \PY{o}{=} \PY{n}{ndevice\PYZus{}compiler\PYZus{}numba} \PY{p}{(}\PY{n}{dndt2b}\PY{p}{)} 
         \PY{n}{dndt2a\PYZus{}numba} \PY{o}{=} \PY{n}{ndevice\PYZus{}compiler\PYZus{}numba} \PY{p}{(}\PY{n}{dndt2a}\PY{p}{)} \PY{c+c1}{\PYZsh{} same as c but slightly faster}
         
         \PY{n}{dndt\PYZus{}drive\PYZus{}numba} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{njit}\PY{p}{(}\PY{n}{dndtc\PYZus{}drive\PYZus{}py}\PY{p}{,}\PY{n}{parallel}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\end{Verbatim}


    \hypertarget{cuda-style-and-gpu-complier}{%
\subsubsection{Cuda style and GPU
complier}\label{cuda-style-and-gpu-complier}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}16}]:} \PY{n}{ndevice\PYZus{}compiler\PYZus{}cuda} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{float32(int32,int32,float32[:,:],float32[:,:],}\PY{l+s+se}{\PYZbs{}}
         \PY{l+s+s1}{float32[:,:],float32[:,:],float32,float32)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{device}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         
         \PY{n}{dndt2\PYZus{}cuda} \PY{o}{=} \PY{n}{ndevice\PYZus{}compiler\PYZus{}cuda}\PY{p}{(}\PY{n}{dndt2a}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} numba kernel to drive function }
          
                 
         \PY{k}{def} \PY{n+nf}{dndt\PYZus{}drive\PYZus{}cuda}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{)}\PY{p}{:}
             \PY{n}{iy} \PY{p}{,}\PY{n}{jx}\PY{o}{=} \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)} \PY{c+c1}{\PYZsh{} verify the order here is okay. \PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
             \PY{n}{iy0} \PY{o}{=} \PY{n}{iy}
             \PY{n}{jx0} \PY{o}{=} \PY{n}{jx}
             \PY{k}{if} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{jx} \PY{o+ow}{and} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{iy}\PY{p}{:}
                 \PY{k}{if} \PY{n}{jx} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                     \PY{n}{jx} \PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
                 \PY{k}{elif} \PY{n}{jx} \PY{o}{==} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
                     \PY{n}{jx} \PY{o}{\PYZhy{}}\PY{o}{=}\PY{l+m+mi}{1}
                     \PY{c+c1}{\PYZsh{} positive reflection }
                     
                 \PY{k}{if} \PY{n}{iy}\PY{o}{==}\PY{l+m+mi}{0}\PY{p}{:}
                     \PY{n}{iy} \PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
                 \PY{k}{elif} \PY{n}{iy} \PY{o}{==} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}   
                     \PY{n}{iy} \PY{o}{\PYZhy{}}\PY{o}{=}\PY{l+m+mi}{1}
             
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx0}\PY{p}{,}\PY{n}{iy0}\PY{p}{]} \PY{o}{=} \PY{n}{dndt2\PYZus{}cuda}\PY{p}{(}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{,}\PY{n}{h}\PY{p}{,}\PY{n}{n}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{,}\PY{n}{dx}\PY{p}{,}\PY{n}{dy}\PY{p}{)}
                     
         
         
         \PY{n}{ncompiler} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{void(float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,}\PY{l+s+se}{\PYZbs{}}
         \PY{l+s+s1}{float32,float32[:,:])}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         
         \PY{n}{dndt\PYZus{}drive\PYZus{}cuda}\PY{o}{=}\PY{n}{ncompiler}\PY{p}{(}\PY{n}{dndt\PYZus{}drive\PYZus{}cuda}\PY{p}{)}
\end{Verbatim}


    \hypertarget{rate-of-change-of-wave-velocity-dudt-and-dvdt}{%
\section{Rate of change of wave Velocity du/dt and
dv/dt}\label{rate-of-change-of-wave-velocity-dudt-and-dvdt}}

\hypertarget{u-is-the-x-direction-longitudinal-speed.-v-is-they-direction-lattitudinal-speed}{%
\subsubsection{U is the ``x-direction (longitudinal)'' speed. V is
the``y-direction (lattitudinal)''
speed}\label{u-is-the-x-direction-longitudinal-speed.-v-is-they-direction-lattitudinal-speed}}

This is implemented 3 ways * Numpy Vector style * Numba Compiled * GPU
Kernel

    \hypertarget{numpy-matrix-syntax}{%
\subsubsection{numpy matrix syntax}\label{numpy-matrix-syntax}}

code written for use with the numpy library, which has syntax simillar
to that of matlab

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{c+c1}{\PYZsh{} caculate the rate of change of the x velocities in the system}
         \PY{k}{def} \PY{n+nf}{dudt}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{,} \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)} \PY{p}{:}
             \PY{n}{mu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{mu}\PY{p}{)}
             \PY{n}{g} \PY{o}{=} \PY{n}{p}\PY{o}{.}\PY{n}{g}
             
             \PY{n}{dudt} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{u}\PY{o}{.}\PY{n}{dtype}\PY{p}{)} \PY{c+c1}{\PYZsh{} x accel array}
             
             \PY{k}{if} \PY{n}{grav}\PY{p}{:}
                 \PY{n}{dudt}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{d\PYZus{}dx}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{dx}\PY{o}{/}\PY{n}{g}\PY{p}{)}
             
             
             \PY{n}{vn} \PY{o}{=} \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5} \PY{c+c1}{\PYZsh{} n shaped v}
             
             \PY{c+c1}{\PYZsh{} coriolis force}
             \PY{k}{if} \PY{n}{cori}\PY{p}{:}
                 
                 \PY{n}{fn} \PY{o}{=} \PY{n}{f}\PY{c+c1}{\PYZsh{}(f[:,1:]+f[:,:\PYZhy{}1])*0.5 \PYZsh{} n shaped f}
                 \PY{n}{fvn} \PY{o}{=} \PY{p}{(}\PY{n}{fn}\PY{o}{*}\PY{n}{vn}\PY{p}{)} \PY{c+c1}{\PYZsh{} product of coriolis and y vel.}
                 \PY{n}{dudt}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+}\PY{o}{=} \PY{p}{(}\PY{n}{fvn}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{fvn}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5} \PY{c+c1}{\PYZsh{} coriolis force}
             
             
             \PY{c+c1}{\PYZsh{} advection}
             
             \PY{c+c1}{\PYZsh{} advection in x direction}
             \PY{k}{if} \PY{n}{advx}\PY{p}{:}
                 \PY{n}{dudx} \PY{o}{=} \PY{n}{d\PYZus{}dx}\PY{p}{(}\PY{n}{u}\PY{p}{,} \PY{n}{dx}\PY{p}{)}
                 \PY{n}{dudt}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{dudx}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{dudx}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5} \PY{c+c1}{\PYZsh{} advection}
             
             \PY{c+c1}{\PYZsh{} advection in y direction}
             \PY{c+c1}{\PYZsh{} possibly average to corners first, then multiply. may be better?}
             \PY{k}{if} \PY{n}{advy}\PY{p}{:}
                 \PY{n}{duy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{empty}\PY{p}{(}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{u}\PY{o}{.}\PY{n}{dtype}\PY{p}{)}
                 \PY{n}{dudy} \PY{o}{=} \PY{n}{d\PYZus{}dy}\PY{p}{(}\PY{n}{u}\PY{p}{,} \PY{n}{dy}\PY{p}{)}
                 \PY{n}{duy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{p}{(} \PY{n}{dudy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{dudy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{p}{)} \PY{o}{*} \PY{n}{p5}
                 \PY{n}{duy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{dudy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}
                 \PY{n}{duy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{dudy}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}
                 \PY{n}{dudt}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{p}{(}\PY{n}{vn}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{vn}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}\PY{o}{*}\PY{n}{duy}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{c+c1}{\PYZsh{} advection}
             
         
             \PY{c+c1}{\PYZsh{}attenuation new}
             \PY{k}{if} \PY{n}{attn}\PY{p}{:}
                 \PY{n}{vna} \PY{o}{=} \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{n}{depth} \PY{o}{=} \PY{n}{p5}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{p}{(}\PY{n}{h}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{h}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{one}
                 \PY{n}{v\PYZus{}u} \PY{o}{=} \PY{p}{(}\PY{n}{vna}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{vna}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{n}{attenu} \PY{o}{=} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{n}{depth}\PY{p}{)} \PY{o}{*} \PY{n}{mu} \PY{o}{*} \PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{n}{v\PYZus{}u}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)} \PY{c+c1}{\PYZsh{} attenuation}
                 \PY{n}{dudt}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{attenu}
         
             \PY{c+c1}{\PYZsh{} viscous term}
         \PY{c+c1}{\PYZsh{}     nu = np.float32(1000/dx)}
         
         \PY{c+c1}{\PYZsh{}     ddux = d\PYZus{}dx(dudx, dx)}
         \PY{c+c1}{\PYZsh{}     dduy = np.empty(u.shape, dtype=u.dtype)}
         \PY{c+c1}{\PYZsh{}     ddudy = d\PYZus{}dy(duy, dy)}
         \PY{c+c1}{\PYZsh{}     dduy[:,1:\PYZhy{}1] = ( ddudy[:,1:] + ddudy[:,:\PYZhy{}1] ) * p5}
         \PY{c+c1}{\PYZsh{}     dduy[:,0] = ddudy[:,0]}
         \PY{c+c1}{\PYZsh{}     dduy[:,\PYZhy{}1] = ddudy[:, \PYZhy{}1]}
         \PY{c+c1}{\PYZsh{}     dudt[1:\PYZhy{}1] \PYZhy{}= nu*(ddux+dduy[1:\PYZhy{}1])}
             
             
             \PY{n}{dudt}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
             \PY{n}{dudt}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{zero} \PY{c+c1}{\PYZsh{} reflective boundaries}
             \PY{n}{dudt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
             \PY{n}{dudt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{zero} \PY{c+c1}{\PYZsh{} reflective boundaries}
             \PY{n}{out}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{dudt}
         \PY{c+c1}{\PYZsh{}     return ( dudt )}
         
         
         
         
         \PY{k}{def} \PY{n+nf}{dvdt}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{,}\PYZbs{}
                  \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{)} \PY{p}{:}
             \PY{n}{mu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{mu}\PY{p}{)}
             \PY{n}{g} \PY{o}{=} \PY{n}{p}\PY{o}{.}\PY{n}{g}
             
             \PY{n}{dvdt} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{v}\PY{o}{.}\PY{n}{dtype}\PY{p}{)} \PY{c+c1}{\PYZsh{} x accel array}
             
             \PY{c+c1}{\PYZsh{}gravity}
             \PY{k}{if} \PY{n}{grav}\PY{p}{:}
                 
                 \PY{n}{dvdt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{d\PYZus{}dy}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{dy}\PY{o}{/}\PY{n}{g}\PY{p}{)}
             
             
             \PY{n}{un} \PY{o}{=} \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{u}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5} \PY{c+c1}{\PYZsh{} n\PYZhy{}shaped u}
             
             \PY{c+c1}{\PYZsh{} coriolis force}
             \PY{k}{if} \PY{n}{cori}\PY{p}{:}
                 
                 \PY{n}{fun} \PY{o}{=} \PY{p}{(}\PY{n}{f}\PY{o}{*}\PY{n}{un}\PY{p}{)} \PY{c+c1}{\PYZsh{} product of coriolis and x vel.}
                 \PY{n}{dvdt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+}\PY{o}{=} \PY{p}{(}\PY{n}{fun}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{fun}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{l+m+mf}{0.5} \PY{c+c1}{\PYZsh{} coriolis force}
                 
             
             \PY{c+c1}{\PYZsh{} advection}
             
             \PY{c+c1}{\PYZsh{} advection in y direction}
             \PY{k}{if} \PY{n}{advx}\PY{p}{:}
                 \PY{n}{dvdy} \PY{o}{=} \PY{n}{d\PYZus{}dy}\PY{p}{(}\PY{n}{v}\PY{p}{,} \PY{n}{dy}\PY{p}{)}
                 \PY{n}{dvdt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{dvdy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{dvdy}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5} \PY{c+c1}{\PYZsh{} advection}
             
             \PY{c+c1}{\PYZsh{} advection in x direction}
             \PY{k}{if} \PY{n}{advy}\PY{p}{:}
                 \PY{n}{dvx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{empty}\PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{v}\PY{o}{.}\PY{n}{dtype}\PY{p}{)}
                 \PY{n}{dvdx} \PY{o}{=} \PY{n}{d\PYZus{}dx}\PY{p}{(}\PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{)}
                 \PY{n}{dvx}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{p}{(} \PY{n}{dvdx}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]} \PY{o}{+} \PY{n}{dvdx}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{p}{)} \PY{o}{*} \PY{n}{p5}
                 \PY{n}{dvx}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{dvdx}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                 \PY{n}{dvx}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{dvdx}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}
                 \PY{n}{dvdt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{p}{(}\PY{n}{un}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{un}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}\PY{o}{*}\PY{n}{dvx}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{c+c1}{\PYZsh{} advection}
             
             
             \PY{c+c1}{\PYZsh{} attenuation}
             \PY{k}{if} \PY{n}{attn}\PY{p}{:}
                 \PY{n}{una} \PY{o}{=} \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{u}\PY{p}{[}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)} \PY{o}{*} \PY{n}{p5}
                 \PY{n}{depth} \PY{o}{=} \PY{n}{p5}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{h}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{h}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{p}{)} \PY{o}{+} \PY{n}{one}
                 \PY{n}{uv} \PY{o}{=} \PY{p}{(}\PY{n}{una}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{p}{]}\PY{o}{+}\PY{n}{una}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{n}{dvdt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{mu} \PY{o}{*} \PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{n}{uv}\PY{o}{*}\PY{n}{uv}\PY{p}{)} \PY{o}{/} \PY{n}{depth}
             
             
             \PY{c+c1}{\PYZsh{} viscous term}
         \PY{c+c1}{\PYZsh{}     nu = np.float32(dy/1000) \PYZsh{} nu given as argument}
         
         \PY{c+c1}{\PYZsh{}     ddvy = d\PYZus{}dy(dvdy, dy)}
         \PY{c+c1}{\PYZsh{}     ddvx = np.empty(v.shape, dtype=v.dtype)}
         \PY{c+c1}{\PYZsh{}     ddvdx = d\PYZus{}dx(dvx, dx)}
         \PY{c+c1}{\PYZsh{}     ddvx[1:\PYZhy{}1] = ( ddvdx[1:] + ddvdx[:\PYZhy{}1] ) * p5}
         \PY{c+c1}{\PYZsh{}     ddvx[0] = ddvdx[0]}
         \PY{c+c1}{\PYZsh{}     ddvx[\PYZhy{}1] = ddvdx[\PYZhy{}1]}
         \PY{c+c1}{\PYZsh{}     dvdt[:,1:\PYZhy{}1] \PYZhy{}= nu*(ddvy+ddvx[:,1:\PYZhy{}1])}
         
         \PY{c+c1}{\PYZsh{}     dvdt[:,0] += nu*ddvx[:,0]*ddvy[:,0]}
         \PY{c+c1}{\PYZsh{}     dvdt[:,\PYZhy{}1] += nu*ddvx[:,\PYZhy{}1]*ddvy[:,\PYZhy{}1]}
             
             \PY{n}{dvdt}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
             \PY{n}{dvdt}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{zero} \PY{c+c1}{\PYZsh{} reflective boundaries}
             \PY{n}{dvdt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{n}{zero}
             \PY{n}{dvdt}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{n}{zero} \PY{c+c1}{\PYZsh{} reflective boundaries}
             \PY{n}{out}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{dvdt}
         \PY{c+c1}{\PYZsh{}     return dvdt}
\end{Verbatim}


    \hypertarget{python-syntax-with-looping-over-array---with-numba}{%
\subsubsection{python syntax with looping over array - with
numba}\label{python-syntax-with-looping-over-array---with-numba}}

Looping over the array should take much longer than doing array
calculations - however, using the numba library and compiling the
function to numba, it goes much faster than even the version with array
calculations.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}18}]:} \PY{c+c1}{\PYZsh{} calculate the rate of change of the x velocity of a single point}
         \PY{k}{def} \PY{n+nf}{dudt2}\PY{p}{(}\PY{n}{jx}\PY{p}{,} \PY{n}{iy}\PY{p}{,} \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PYZbs{}
                   \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)} \PY{p}{:}
             \PY{n}{mu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{mu}\PY{p}{)}
             \PY{n}{p5} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{)}
             \PY{n}{one} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{g}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{9.81}\PY{p}{)}
             
             \PY{n}{jxm1}\PY{o}{=} \PY{n}{jx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
             \PY{n}{iym1}\PY{o}{=} \PY{n}{iy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
             \PY{n}{jxp1}\PY{o}{=} \PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{iyp1}\PY{o}{=} \PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{jxm0}\PY{o}{=} \PY{n}{jx}
             \PY{n}{iym0}\PY{o}{=} \PY{n}{iy}
             
             \PY{n}{dudt} \PY{o}{=} \PY{l+m+mi}{0}
             
             \PY{c+c1}{\PYZsh{} gravity}
             \PY{k}{if} \PY{n}{grav}\PY{p}{:}
                 \PY{n}{dudt} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{g} \PY{o}{*} \PY{p}{(} \PY{n}{n}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,} \PY{n}{iym0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{n}\PY{p}{[}\PY{n}{jxm1}\PY{p}{,} \PY{n}{iym0}\PY{p}{]} \PY{p}{)} \PY{o}{/} \PY{n}{dx}
             
             
             \PY{n}{vn\PYZus{}jm1} \PY{o}{=} \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{n}{jxm1}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{+}\PY{n}{v}\PY{p}{[}\PY{n}{jxm1}\PY{p}{,}\PY{n}{iyp1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             \PY{n}{vn\PYZus{}jm0} \PY{o}{=} \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{+}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iyp1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             
             \PY{c+c1}{\PYZsh{} coriolis force}
             \PY{k}{if} \PY{n}{cori}\PY{p}{:}
                 
         
                 \PY{n}{vf\PYZus{}jm1im0} \PY{o}{=} \PY{n}{f}\PY{p}{[}\PY{n}{jxm1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{vn\PYZus{}jm1}  \PY{c+c1}{\PYZsh{} techically the iy lookup on f is irrelevant}
                 \PY{n}{vf\PYZus{}jm0im0} \PY{o}{=} \PY{n}{f}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{vn\PYZus{}jm0}
         
                 \PY{n}{dudt} \PY{o}{+}\PY{o}{=}  \PY{p}{(}\PY{n}{vf\PYZus{}jm0im0} \PY{o}{+} \PY{n}{vf\PYZus{}jm1im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             
             \PY{c+c1}{\PYZsh{} advection}
             
             \PY{c+c1}{\PYZsh{} advection in x direction}
             \PY{k}{if} \PY{n}{advx}\PY{p}{:}
                 \PY{n}{dudx\PYZus{}jp1} \PY{o}{=} \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{n}{jxp1}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{dx}
                 \PY{n}{dudx\PYZus{}jm0} \PY{o}{=} \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{u}\PY{p}{[}\PY{n}{jxm1}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{dx}
                 \PY{n}{dudt} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{dudx\PYZus{}jp1}\PY{o}{+}\PY{n}{dudx\PYZus{}jm0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             
             
             \PY{c+c1}{\PYZsh{} advection in y direction}
             \PY{k}{if} \PY{n}{advy}\PY{p}{:}
                 \PY{n}{dudy\PYZus{}ip1} \PY{o}{=} \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iyp1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{dy}
                 \PY{n}{dudy\PYZus{}im0} \PY{o}{=} \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym1}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{dy}
         
                 \PY{n}{vu} \PY{o}{=} \PY{p}{(}\PY{n}{vn\PYZus{}jm1}\PY{o}{+}\PY{n}{vn\PYZus{}jm0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
         
                 \PY{n}{dudt} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{vu}\PY{o}{*}\PY{p}{(}\PY{n}{dudy\PYZus{}ip1} \PY{o}{+} \PY{n}{dudy\PYZus{}im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5} \PY{c+c1}{\PYZsh{} wrong? multiply in other order?}
             
             
             \PY{c+c1}{\PYZsh{}attenuation}
             \PY{k}{if} \PY{n}{attn}\PY{p}{:}
                 \PY{n}{h\PYZus{}jm0} \PY{o}{=} \PY{p}{(}\PY{n}{h}\PY{p}{[}\PY{n}{jxm1}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{+}\PY{n}{h}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{n}{n\PYZus{}jm0} \PY{o}{=} \PY{p}{(}\PY{n}{n}\PY{p}{[}\PY{n}{jxm1}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{n}{depth} \PY{o}{=} \PY{n+nb}{abs}\PY{p}{(}\PY{n}{h\PYZus{}jm0}\PY{o}{+}\PY{n}{n\PYZus{}jm0}\PY{p}{)}\PY{o}{+}\PY{n}{one}
             \PY{c+c1}{\PYZsh{}     if depth == 0: print (\PYZsq{}yikes! zero depth!\PYZsq{})}
                 \PY{n}{dudt} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{mu} \PY{o}{*} \PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{*} \PY{n}{mysqrt}\PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{n}{vu}\PY{o}{*}\PY{n}{vu}\PY{p}{)} \PY{o}{/} \PY{n}{depth}
             
             
             \PY{c+c1}{\PYZsh{} viscous term}
             \PY{c+c1}{\PYZsh{}}
             
             \PY{k}{return} \PY{p}{(} \PY{n}{dudt} \PY{p}{)}
         
         \PY{n}{device\PYZus{}compiler\PYZus{}numba} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{njit}\PY{p}{(}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{float32(int32,int32,float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,b1,b1,b1,b1,b1,float32,float32)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{n}{parallel}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         
         \PY{n}{dudt2\PYZus{}numba} \PY{o}{=} \PY{n}{device\PYZus{}compiler\PYZus{}numba}\PY{p}{(}\PY{n}{dudt2}\PY{p}{)}
         
         \PY{k}{def} \PY{n+nf}{dudt\PYZus{}drive\PYZus{}py}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{,} \PYZbs{}
                           \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{:}
             \PY{k}{for} \PY{n}{jx} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
                 \PY{k}{for} \PY{n}{iy} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                     \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{dudt2\PYZus{}numba}\PY{p}{(}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{,}\PY{n}{h}\PY{p}{,}\PY{n}{n}\PY{p}{,}\PY{n}{f}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{,}\PY{n}{dx}\PY{p}{,}\PY{n}{dy}\PY{p}{,} \PYZbs{}
                                              \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
              \PY{c+c1}{\PYZsh{} setting the edges to zero may not be needed if we can assure it stays zero       }
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
             \PY{k}{for} \PY{n}{iy} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
                 \PY{n}{out}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}   
         
         
         \PY{n}{dudt\PYZus{}drive\PYZus{}numba} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{njit}\PY{p}{(}\PY{n}{dudt\PYZus{}drive\PYZus{}py}\PY{p}{,}\PY{n}{parallel}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         
         
         
         \PY{k}{def} \PY{n+nf}{dvdt2}\PY{p}{(}\PY{n}{jx}\PY{p}{,} \PY{n}{iy}\PY{p}{,} \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PYZbs{}
                   \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)} \PY{p}{:}
             \PY{n}{mu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{mu}\PY{p}{)}
             \PY{n}{p5} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{)}
             \PY{n}{one} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{g}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{9.81}\PY{p}{)}
         
             \PY{n}{jxm1}\PY{o}{=} \PY{n}{jx}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
             \PY{n}{iym1}\PY{o}{=} \PY{n}{iy}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}
             \PY{n}{jxp1}\PY{o}{=} \PY{n}{jx}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{iyp1}\PY{o}{=} \PY{n}{iy}\PY{o}{+}\PY{l+m+mi}{1}
             \PY{n}{jxm0}\PY{o}{=} \PY{n}{jx}
             \PY{n}{iym0}\PY{o}{=} \PY{n}{iy}
             
             \PY{n}{dvdt} \PY{o}{=} \PY{l+m+mi}{0}
             
             \PY{k}{if} \PY{n}{grav}\PY{p}{:}
                 \PY{n}{dvdt} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{g} \PY{o}{*} \PY{p}{(} \PY{n}{n}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,} \PY{n}{iym0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{n}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,} \PY{n}{iym1}\PY{p}{]} \PY{p}{)} \PY{o}{/} \PY{n}{dy}
             
             
             \PY{n}{un\PYZus{}im1} \PY{o}{=} \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym1}\PY{p}{]}\PY{o}{+}\PY{n}{u}\PY{p}{[}\PY{n}{jxp1}\PY{p}{,}\PY{n}{iym1}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             \PY{n}{un\PYZus{}im0} \PY{o}{=} \PY{p}{(}\PY{n}{u}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{+}\PY{n}{u}\PY{p}{[}\PY{n}{jxp1}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             \PY{n}{uv} \PY{o}{=} \PY{p}{(}\PY{n}{un\PYZus{}im0} \PY{o}{+} \PY{n}{un\PYZus{}im1}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             
             \PY{c+c1}{\PYZsh{} coriolis force}
             \PY{k}{if} \PY{n}{cori}\PY{p}{:}
                 \PY{n}{dvdt} \PY{o}{+}\PY{o}{=}  \PY{n}{f}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{uv}
             
             
             \PY{c+c1}{\PYZsh{} advection}
             
             \PY{c+c1}{\PYZsh{}\PYZsh{} advection in y direction}
             \PY{k}{if} \PY{n}{advx}\PY{p}{:}
                 \PY{n}{dvdy\PYZus{}ip1} \PY{o}{=} \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iyp1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{dy}
                 \PY{n}{dvdy\PYZus{}im0} \PY{o}{=} \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym1}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{dy}
                 \PY{n}{dvdt} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{*}\PY{p}{(}\PY{n}{dvdy\PYZus{}ip1}\PY{o}{+}\PY{n}{dvdy\PYZus{}im0}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
             
             \PY{c+c1}{\PYZsh{}\PYZsh{} advection in x direction}
             \PY{k}{if} \PY{n}{advy}\PY{p}{:}
                 \PY{n}{dvdx\PYZus{}jp1} \PY{o}{=} \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{n}{jxp1}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{dx}
                 \PY{n}{dvdx\PYZus{}jm0} \PY{o}{=} \PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{v}\PY{p}{[}\PY{n}{jxm1}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{n}{dx}
                 \PY{n}{dvdt} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{uv}\PY{o}{*}\PY{p}{(}\PY{n}{dvdx\PYZus{}jp1} \PY{o}{+} \PY{n}{dvdx\PYZus{}jm0}\PY{p}{)}\PY{o}{*}\PY{n}{p5} \PY{c+c1}{\PYZsh{} wrong? multiply in other order?}
             
             \PY{c+c1}{\PYZsh{} attenuation}
             \PY{k}{if} \PY{n}{attn}\PY{p}{:}
                 \PY{n}{h\PYZus{}im0} \PY{o}{=} \PY{p}{(}\PY{n}{h}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym1}\PY{p}{]}\PY{o}{+}\PY{n}{h}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{n}{n\PYZus{}im0} \PY{o}{=} \PY{p}{(}\PY{n}{n}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym1}\PY{p}{]}\PY{o}{+}\PY{n}{n}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{p5}
                 \PY{n}{depth} \PY{o}{=} \PY{n+nb}{abs}\PY{p}{(}\PY{n}{h\PYZus{}im0}\PY{o}{+}\PY{n}{n\PYZus{}im0}\PY{p}{)} \PY{o}{+} \PY{n}{one}
             \PY{c+c1}{\PYZsh{}     if depth == 0: print(\PYZsq{}yikes! zero depth!\PYZsq{})}
                 \PY{n}{dvdt} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{mu} \PY{o}{*} \PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]} \PY{o}{*} \PY{n}{mysqrt}\PY{p}{(}\PY{n}{v}\PY{p}{[}\PY{n}{jxm0}\PY{p}{,}\PY{n}{iym0}\PY{p}{]}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{n}{uv}\PY{o}{*}\PY{n}{uv}\PY{p}{)} \PY{o}{/} \PY{n}{depth}
             
             \PY{k}{return} \PY{p}{(} \PY{n}{dvdt} \PY{p}{)}
         
         \PY{n}{dvdt2\PYZus{}numba} \PY{o}{=} \PY{n}{device\PYZus{}compiler\PYZus{}numba} \PY{p}{(}\PY{n}{dvdt2}\PY{p}{)}
         
         \PY{k}{def} \PY{n+nf}{dvdt\PYZus{}drive\PYZus{}py}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{,} \PYZbs{}
                           \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{:}   
             \PY{k}{for} \PY{n}{jx} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
                 \PY{k}{for} \PY{n}{iy} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
                   \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{dvdt2\PYZus{}numba}\PY{p}{(}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{,}\PY{n}{h}\PY{p}{,}\PY{n}{n}\PY{p}{,}\PY{n}{f}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{,}\PY{n}{dx}\PY{p}{,}\PY{n}{dy}\PY{p}{,}\PYZbs{}
                                            \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
                     
                         
                 \PY{c+c1}{\PYZsh{} the following can be avoided if we can assure the edges stay zero}
                 
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
             \PY{k}{for} \PY{n}{iy} \PY{o+ow}{in} \PY{n}{nb}\PY{o}{.}\PY{n}{prange}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
                 \PY{n}{out}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}   
         
         \PY{n}{dvdt\PYZus{}drive\PYZus{}numba} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{njit}\PY{p}{(}\PY{n}{dvdt\PYZus{}drive\PYZus{}py}\PY{p}{,}\PY{n}{parallel}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}19}]:} \PY{k}{def} \PY{n+nf}{donothing} \PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{nu}\PY{p}{,} \PY{n}{coastx}\PY{p}{,} \PY{n}{bounds}\PY{p}{,} \PY{n}{mu}\PY{p}{,} \PY{n}{itr}\PY{p}{)}\PY{p}{:} \PY{k}{return}
\end{Verbatim}


    \hypertarget{cuda-style-for-gpu}{%
\subsubsection{cuda style for GPU}\label{cuda-style-for-gpu}}

cuda compiles the functions to run on the graphics card, with each cell
performing the necessary calculations on a single index of the array.
This goes much faster than numpy or numba.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}20}]:} \PY{n}{device\PYZus{}compiler\PYZus{}cuda} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{float32(int32,int32,float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,b1,b1,b1,b1,b1,float32,float32)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PYZbs{}
             \PY{n}{device}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{n}{dudt2\PYZus{}cuda} \PY{o}{=} \PY{n}{device\PYZus{}compiler\PYZus{}cuda}\PY{p}{(}\PY{n}{dudt2}\PY{p}{)}
         
         \PY{k}{def} \PY{n+nf}{dudt\PYZus{}drive\PYZus{}cuda}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{,} \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{n}{nb}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{n}{nb}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{)}\PY{p}{:}
             \PY{n}{iy} \PY{p}{,}\PY{n}{jx}\PY{o}{=} \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{k}{if} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{\PYZgt{}}\PY{n}{jx}\PY{o}{\PYZgt{}}\PY{l+m+mi}{0}  \PY{o+ow}{and} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{\PYZgt{}}\PY{n}{iy}\PY{o}{\PYZgt{}}\PY{l+m+mi}{0}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{dudt2\PYZus{}cuda}\PY{p}{(}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{,}\PY{n}{h}\PY{p}{,}\PY{n}{n}\PY{p}{,}\PY{n}{f}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{,}\PY{n}{dx}\PY{p}{,}\PY{n}{dy}\PY{p}{,} \PYZbs{}
                                         \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
             \PY{k}{else}\PY{p}{:}  \PY{c+c1}{\PYZsh{} could lose this since we don\PYZsq{}t care! }
                \PY{k}{if} \PY{n}{jx} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or}  \PY{n}{jx} \PY{o}{==} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
                    \PY{k}{if} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{iy}\PY{p}{:}
                            \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
                \PY{k}{elif} \PY{n}{iy} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or}  \PY{n}{iy} \PY{o}{==} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
                    \PY{k}{if} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{jx}\PY{p}{:}
                            \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
         \PY{n}{compiler} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{void(float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,float32[:,:],b1,b1,b1,b1,b1,float32,float32)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PYZbs{}
             \PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} \PYZpc{}env NUMBA\PYZus{}ENABLE\PYZus{}CUDASIM=1}
         \PY{n}{dudt\PYZus{}drive\PYZus{}cuda}\PY{o}{=}\PY{n}{compiler}\PY{p}{(}\PY{n}{dudt\PYZus{}drive\PYZus{}cuda}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} \PYZpc{}env NUMBA\PYZus{}ENABLE\PYZus{}CUDASIM=0}
         
         
         
         
         
         \PY{n}{device\PYZus{}compiler\PYZus{}cuda} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{float32(int32,int32,float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,b1,b1,b1,b1,b1,float32,float32)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{device}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         
         \PY{n}{dvdt2\PYZus{}cuda} \PY{o}{=} \PY{n}{device\PYZus{}compiler\PYZus{}cuda}\PY{p}{(}\PY{n}{dvdt2}\PY{p}{)}
         
         \PY{k}{def} \PY{n+nf}{dvdt\PYZus{}drive\PYZus{}cuda}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{out}\PY{p}{,} \PYZbs{}
                             \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PYZbs{}
                             \PY{n}{nu}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{)}\PY{p}{:}
             \PY{n}{iy} \PY{p}{,}\PY{n}{jx}\PY{o}{=} \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{k}{if} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{\PYZgt{}}\PY{n}{jx}\PY{o}{\PYZgt{}}\PY{l+m+mi}{0}  \PY{o+ow}{and} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{\PYZgt{}}\PY{n}{iy}\PY{o}{\PYZgt{}}\PY{l+m+mi}{0}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{dvdt2\PYZus{}cuda}\PY{p}{(}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{,}\PY{n}{h}\PY{p}{,}\PY{n}{n}\PY{p}{,}\PY{n}{f}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{,}\PY{n}{dx}\PY{p}{,}\PY{n}{dy}\PY{p}{,}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
             \PY{k}{else}\PY{p}{:}  \PY{c+c1}{\PYZsh{} could lose this since we don\PYZsq{}t care! }
                \PY{k}{if} \PY{n}{jx} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or}  \PY{n}{jx} \PY{o}{==} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
                    \PY{k}{if} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{iy}\PY{p}{:}
                            \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
                \PY{k}{elif} \PY{n}{iy} \PY{o}{==} \PY{l+m+mi}{0} \PY{o+ow}{or}  \PY{n}{iy} \PY{o}{==} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}
                    \PY{k}{if} \PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZgt{}}\PY{n}{jx}\PY{p}{:}
                            \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0}\PY{p}{)}
         
         \PY{n}{compiler} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{void(float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,float32[:,:],b1,b1,b1,b1,b1,float32,float32)}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{fastmath}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}
         
         \PY{n}{dvdt\PYZus{}drive\PYZus{}cuda}\PY{o}{=}\PY{n}{compiler}\PY{p}{(}\PY{n}{dvdt\PYZus{}drive\PYZus{}cuda}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}dvdt\PYZus{}drive\PYZus{}cud=cuda.jit(dvdt\PYZus{}drive\PYZus{}cuda) \PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
\end{Verbatim}


    \hypertarget{unit-tests}{%
\subsubsection{Unit tests:}\label{unit-tests}}

Validation of the numerical identity of different numerical methods.

    \hypertarget{timestep-integrators}{%
\subsection{timestep integrators}\label{timestep-integrators}}

there are multiple different ways of integrating the differential
equation system. 1. Forward Euler the most simple timestepping scheme,
simply adding the derivative of each value to the value. This method has
is only first order so it has numerical instability unless the step
sizes are very small. 2. Forward-Backward based off the forward euler
timestep, but with an added level of complexity, shifting some of the
calculation into being interpolation rather than extrapolation, and
thereby being both more accurate and stable. 3. Forward-Backward
Predictor Corrector makes an initial prediction using a forward-backward
timestep, and then correct on that prediction for more accuracy and
higher stability. While the added prediction step doubles the
calculation time, the stability and accuacy allows larger time steps
making it faster overall.\\
4. Generalized Forward-Backward Incorporates values from several
previous timesteps, replacing the time-wasting predictor step (above) to
gain speed, at the expense of using additional memory. This is the
fastest overall.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}21}]:} \PY{k}{def} \PY{n+nf}{forward}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn}\PY{p}{,} \PYZbs{}
                     \PY{n}{beta}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PYZbs{}
                     \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt}\PY{p}{,} \PYZbs{}
                     \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} forward euler and forward/backward timestep}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{        beta = 0 forward euler timestep}
         \PY{l+s+sd}{        beta = 1 forward\PYZhy{}backward timestep}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{beta} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{beta}\PY{p}{)}
             \PY{n}{mu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{mu}\PY{p}{)}
             
             \PY{n}{du1}\PY{p}{,} \PY{n}{du0} \PY{o}{=} \PY{n}{du}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
             \PY{n}{dv1}\PY{p}{,} \PY{n}{dv0} \PY{o}{=} \PY{n}{dv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
             \PY{n}{dn0} \PY{o}{=} \PY{n}{dn}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             
             \PY{n}{dndt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dn0}\PY{p}{)} \PY{c+c1}{\PYZsh{} calculate dndt and put it into dn0}
             
             \PY{n}{n1} \PY{o}{=} \PY{n}{n} \PY{o}{+} \PY{p}{(} \PY{n}{dn0} \PY{p}{)}\PY{o}{*}\PY{n}{dt}
             
             \PY{n}{dudt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,}  \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du0}\PY{p}{,}\PYZbs{}
                    \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
             \PY{n}{dvdt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,}  \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv0}\PY{p}{,}\PYZbs{}
                    \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
             \PY{n}{dudt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du1}\PY{p}{,} \PYZbs{}
                    \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
             \PY{n}{dvdt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv1}\PY{p}{,}
                    \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
             
             \PY{n}{u1} \PY{o}{=} \PY{n}{u} \PY{o}{+} \PY{p}{(} \PY{n}{beta}\PY{o}{*}\PY{n}{du1} \PY{o}{+} \PY{p}{(}\PY{n}{one}\PY{o}{\PYZhy{}}\PY{n}{beta}\PY{p}{)}\PY{o}{*}\PY{n}{du0} \PY{p}{)}\PY{o}{*}\PY{n}{dt}
             \PY{n}{v1} \PY{o}{=} \PY{n}{v} \PY{o}{+} \PY{p}{(} \PY{n}{beta}\PY{o}{*}\PY{n}{dv1} \PY{o}{+} \PY{p}{(}\PY{n}{one}\PY{o}{\PYZhy{}}\PY{n}{beta}\PY{p}{)}\PY{o}{*}\PY{n}{dv0} \PY{p}{)}\PY{o}{*}\PY{n}{dt}
             
             \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v} \PY{o}{=} \PY{n}{n1}\PY{p}{,} \PY{n}{u1}\PY{p}{,} \PY{n}{v1}
             
             \PY{n}{du} \PY{o}{=} \PY{p}{[}\PY{n}{du1}\PY{p}{,} \PY{n}{du0}\PY{p}{,} \PY{n}{du0}\PY{p}{,} \PY{n}{du0}\PY{p}{]}
             \PY{n}{dv} \PY{o}{=} \PY{p}{[}\PY{n}{dv1}\PY{p}{,} \PY{n}{dv0}\PY{p}{,} \PY{n}{dv0}\PY{p}{,} \PY{n}{dv0}\PY{p}{]}
             \PY{n}{dn} \PY{o}{=} \PY{p}{[}\PY{n}{dn0}\PY{p}{,} \PY{n}{dn0}\PY{p}{,} \PY{n}{dn0}\PY{p}{]}
             \PY{k}{return} \PY{n}{n1}\PY{p}{,} \PY{n}{u1}\PY{p}{,} \PY{n}{v1}\PY{p}{,} \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}22}]:} \PY{k}{def} \PY{n+nf}{fbfeedback}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn}\PY{p}{,} \PYZbs{}
                        \PY{n}{beta}\PY{o}{=}\PY{l+m+mi}{1}\PY{o}{/}\PY{l+m+mi}{3}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mi}{2}\PY{o}{/}\PY{l+m+mi}{3}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PYZbs{}
                        \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt}\PY{p}{,} \PYZbs{}
                        \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{        predictor (forward\PYZhy{}backward) corrector timestep}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{beta} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{beta}\PY{p}{)}
             \PY{n}{eps} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{eps}\PY{p}{)}
             \PY{n}{mu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{mu}\PY{p}{)}
             
             \PY{n}{du0}\PY{p}{,} \PY{n}{du1}\PY{p}{,} \PY{n}{du1g} \PY{o}{=} \PY{n}{du}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}
             \PY{n}{dv0}\PY{p}{,} \PY{n}{dv1}\PY{p}{,} \PY{n}{dv1g} \PY{o}{=} \PY{n}{dv}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]}
             \PY{n}{dn0}\PY{p}{,} \PY{n}{dn1} \PY{o}{=} \PY{n}{dn}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
             
             \PY{c+c1}{\PYZsh{}predict}
             \PY{n}{n1g}\PY{p}{,} \PY{n}{u1g}\PY{p}{,} \PY{n}{v1g}\PY{p}{,} \PY{n}{dug}\PY{p}{,} \PY{n}{dvg}\PY{p}{,} \PY{n}{dng} \PY{o}{=} \PY{n}{forward}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn}\PY{p}{,} \PY{n}{beta}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PYZbs{}
                                                    \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt\PYZus{}x}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt\PYZus{}x}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt\PYZus{}x}\PY{p}{,} \PYZbs{}
                                                    \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{)} \PY{c+c1}{\PYZsh{} forward\PYZhy{}backward first guess}
             
             \PY{c+c1}{\PYZsh{}feedback on prediction}
             
             \PY{n}{dndt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1g}\PY{p}{,}\PY{n}{u1g}\PY{p}{,}\PY{n}{v1g}\PY{p}{,}\PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dn1}\PY{p}{)}
             \PY{n}{dn0} \PY{o}{=} \PY{n}{dng}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
         \PY{c+c1}{\PYZsh{}     dndt\PYZus{}x(h, n,  u,  v,  dx, dy, dn0)}
             
             \PY{n}{n1} \PY{o}{=} \PY{n}{n} \PY{o}{+} \PY{n}{p5}\PY{o}{*}\PY{p}{(}\PY{n}{dn1} \PY{o}{+} \PY{n}{dn0}\PY{p}{)}\PY{o}{*}\PY{n}{dt}
             
             \PY{n}{du0} \PY{o}{=} \PY{n}{dug}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{dv0} \PY{o}{=} \PY{n}{dvg}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
         \PY{c+c1}{\PYZsh{}     dudt\PYZus{}x(h, n,  f, u,  v,  dx, dy, du0,  grav=grav, cori=cori, advx=advx, advy=advy, attn=attn)}
         \PY{c+c1}{\PYZsh{}     dvdt\PYZus{}x(h, n,  f, u,  v,  dx, dy, dv0,  grav=grav, cori=cori, advx=advx, advy=advy, attn=attn)}
             \PY{n}{dudt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1g}\PY{p}{,}\PY{n}{f}\PY{p}{,} \PY{n}{u1g}\PY{p}{,}\PY{n}{v1g}\PY{p}{,}\PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du1g}\PY{p}{,} \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
             \PY{n}{dvdt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1g}\PY{p}{,}\PY{n}{f}\PY{p}{,} \PY{n}{u1g}\PY{p}{,}\PY{n}{v1g}\PY{p}{,}\PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv1g}\PY{p}{,} \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
             \PY{n}{dudt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,}  \PY{n}{v}\PY{p}{,}  \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du1}\PY{p}{,}  \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
             \PY{n}{dvdt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,}  \PY{n}{v}\PY{p}{,}  \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv1}\PY{p}{,}  \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
         
             \PY{n}{u1} \PY{o}{=} \PY{n}{u} \PY{o}{+} \PY{n}{p5}\PY{o}{*}\PY{p}{(}\PY{n}{eps}\PY{o}{*}\PY{n}{du1}\PY{o}{+}\PY{p}{(}\PY{n}{one}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{du1g}\PY{o}{+}\PY{n}{du0}\PY{p}{)}\PY{o}{*}\PY{n}{dt}
             \PY{n}{v1} \PY{o}{=} \PY{n}{v} \PY{o}{+} \PY{n}{p5}\PY{o}{*}\PY{p}{(}\PY{n}{eps}\PY{o}{*}\PY{n}{dv1}\PY{o}{+}\PY{p}{(}\PY{n}{one}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dv1g}\PY{o}{+}\PY{n}{dv0}\PY{p}{)}\PY{o}{*}\PY{n}{dt}
             
         \PY{c+c1}{\PYZsh{}     n[:,:], u[:,:], v[:,:] = n1, u1, v1}
             \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn} \PY{o}{=} \PY{p}{[}\PY{n}{du1}\PY{p}{,} \PY{n}{du0}\PY{p}{,} \PY{n}{du0}\PY{p}{,} \PY{n}{du0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{dv1}\PY{p}{,} \PY{n}{dv0}\PY{p}{,} \PY{n}{dv0}\PY{p}{,} \PY{n}{dv0}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{dn0}\PY{p}{,} \PY{n}{dn0}\PY{p}{,} \PY{n}{dn0}\PY{p}{]}
             \PY{k}{return} \PY{n}{n1}\PY{p}{,} \PY{n}{u1}\PY{p}{,} \PY{n}{v1}\PY{p}{,} \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}23}]:} \PY{n}{p5}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{)}
         \PY{n}{p32} \PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{1.5}\PY{p}{)}
         \PY{k}{def} \PY{n+nf}{genfb}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PYZbs{}
                   \PY{n}{du}\PY{p}{,}\PY{n}{dv}\PY{p}{,}\PY{n}{dn}\PY{p}{,}\PYZbs{}
                   \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{0.281105}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{0.013}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.0880}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PYZbs{}
                   \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt}\PY{p}{,} \PYZbs{}
                   \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} generalized forward backward feedback timestep}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{        generalized forward backward predictor corrector}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
             
             \PY{n}{beta} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{beta}\PY{p}{)}
             \PY{n}{eps} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{eps}\PY{p}{)}
             \PY{n}{gamma} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{gamma}\PY{p}{)}
             \PY{n}{mu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{mu}\PY{p}{)}
             \PY{n}{nu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{nu}\PY{p}{)}
             
             \PY{n}{dn\PYZus{}m1}\PY{p}{,}\PY{n}{dn\PYZus{}m2}\PY{p}{,}\PY{n}{dn\PYZus{}m0} \PY{o}{=} \PY{n}{dn}     \PY{c+c1}{\PYZsh{} unpack}
             \PY{n}{dndt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dn\PYZus{}m0}\PY{p}{)}  
         
             \PY{c+c1}{\PYZsh{} must do the following before the u and v !}
             \PY{n}{n1} \PY{o}{=} \PY{n}{n} \PY{o}{+} \PY{p}{(}\PY{p}{(}\PY{n}{p32}\PY{o}{+}\PY{n}{beta}\PY{p}{)}\PY{o}{*} \PY{n}{dn\PYZus{}m0} \PY{o}{\PYZhy{}} \PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{beta}\PY{o}{+}\PY{n}{beta}\PY{p}{)}\PY{o}{*} \PY{n}{dn\PYZus{}m1}\PY{o}{+} \PY{p}{(}\PY{n}{beta}\PY{p}{)}\PY{o}{*} \PY{n}{dn\PYZus{}m2}\PY{p}{)}\PY{o}{*}\PY{n}{dt}
             
             \PY{n}{du\PYZus{}m0}\PY{p}{,}\PY{n}{du\PYZus{}m1}\PY{p}{,}\PY{n}{du\PYZus{}m2}\PY{p}{,}\PY{n}{du\PYZus{}p1} \PY{o}{=} \PY{n}{du}     \PY{c+c1}{\PYZsh{} unpack}
             \PY{n}{dudt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du\PYZus{}p1}\PY{p}{,} \PYZbs{}
                    \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
         
             \PY{n}{dv\PYZus{}m0}\PY{p}{,}\PY{n}{dv\PYZus{}m1}\PY{p}{,}\PY{n}{dv\PYZus{}m2}\PY{p}{,}\PY{n}{dv\PYZus{}p1} \PY{o}{=} \PY{n}{dv}     \PY{c+c1}{\PYZsh{} unpack   }
             \PY{n}{dvdt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n1}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv\PYZus{}p1}\PY{p}{,} \PYZbs{}
                    \PY{n}{grav}\PY{o}{=}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{)}
             
             \PY{n}{u1} \PY{o}{=} \PY{n}{u}\PY{o}{+} \PY{p}{(}\PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{gamma}\PY{o}{+}\PY{n}{eps}\PY{o}{+}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{)}\PY{o}{*}\PY{n}{du\PYZus{}p1} \PY{o}{+}\PY{p}{(}\PY{p}{(}\PY{n}{p5}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{)}\PY{o}{*}\PY{n}{du\PYZus{}m0} \PYZbs{}
                      \PY{o}{+}\PY{p}{(}\PY{n}{gamma}\PY{o}{*}\PY{n}{dt}\PY{p}{)}\PY{o}{*}\PY{n}{du\PYZus{}m1} \PY{o}{+}\PY{p}{(}\PY{n}{eps}\PY{o}{*}\PY{n}{dt}\PY{p}{)}\PY{o}{*}\PY{n}{du\PYZus{}m2} 
          
             \PY{n}{v1} \PY{o}{=} \PY{n}{v}\PY{o}{+} \PY{p}{(}\PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{gamma}\PY{o}{+}\PY{n}{eps}\PY{o}{+}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{)}\PY{o}{*}\PY{n}{dv\PYZus{}p1} \PY{o}{+}\PY{p}{(}\PY{p}{(}\PY{n}{p5}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{)}\PY{o}{*}\PY{n}{dv\PYZus{}m0} \PYZbs{}
                      \PY{o}{+}\PY{p}{(}\PY{n}{gamma}\PY{o}{*}\PY{n}{dt}\PY{p}{)}\PY{o}{*}\PY{n}{dv\PYZus{}m1} \PY{o}{+}\PY{p}{(}\PY{n}{eps}\PY{o}{*}\PY{n}{dt}\PY{p}{)}\PY{o}{*}\PY{n}{dv\PYZus{}m2}
             
             \PY{c+c1}{\PYZsh{}v1 = v+ ((p5+gamma+eps+eps)*dv\PYZus{}p1 +(p5\PYZhy{}gamma\PYZhy{}gamma\PYZhy{}eps\PYZhy{}eps\PYZhy{}eps)*dv\PYZus{}m0 +\PYZbs{}}
                    \PY{c+c1}{\PYZsh{}  gamma*dv\PYZus{}m1 +eps*dv\PYZus{}m2)*dt}
         
         
             \PY{n}{dv} \PY{o}{=} \PY{p}{(} \PY{n}{dv\PYZus{}p1}\PY{p}{,}\PY{n}{dv\PYZus{}m0}\PY{p}{,}\PY{n}{dv\PYZus{}m1}\PY{p}{,}\PY{n}{dv\PYZus{}m2} \PY{p}{)}
             \PY{n}{du} \PY{o}{=} \PY{p}{(} \PY{n}{du\PYZus{}p1}\PY{p}{,}\PY{n}{du\PYZus{}m0}\PY{p}{,}\PY{n}{du\PYZus{}m1}\PY{p}{,}\PY{n}{du\PYZus{}m2} \PY{p}{)}
             \PY{n}{dn} \PY{o}{=} \PY{p}{(} \PY{n}{dn\PYZus{}m0}\PY{p}{,}\PY{n}{dn\PYZus{}m1}\PY{p}{,}\PY{n}{dn\PYZus{}m2} \PY{p}{)}
             
             \PY{k}{return} \PY{n}{n1}\PY{p}{,} \PY{n}{u1}\PY{p}{,} \PY{n}{v1}\PY{p}{,} \PY{n}{du}\PY{p}{,}\PY{n}{dv}\PY{p}{,}\PY{n}{dn}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}24}]:} \PY{k}{def} \PY{n+nf}{lin\PYZus{}comb4\PYZus{}thread}\PY{p}{(}\PY{n}{v1}\PY{p}{,} \PY{n}{v2}\PY{p}{,} \PY{n}{v3}\PY{p}{,} \PY{n}{v4}\PY{p}{,} \PY{n}{w1}\PY{p}{,} \PY{n}{w2}\PY{p}{,} \PY{n}{w3}\PY{p}{,} \PY{n}{w4}\PY{p}{,} \PY{n}{out}\PY{p}{)}\PY{p}{:}
             \PY{n}{iy} \PY{p}{,}\PY{n}{jx}\PY{o}{=} \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)} 
             \PY{k}{if} \PY{n}{iy}\PY{o}{\PYZlt{}}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o+ow}{and} \PY{n}{jx}\PY{o}{\PYZlt{}}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{w1}\PY{o}{*}\PY{n}{v1}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{+} \PY{n}{w2}\PY{o}{*}\PY{n}{v2}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{+} \PY{n}{w3}\PY{o}{*}\PY{n}{v3}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{+} \PY{n}{w4}\PY{o}{*}\PY{n}{v4}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]}
         \PY{n}{cudacompilelc4} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{void(float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,float32,float32,float32[:,:])}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{lincomb4\PYZus{}cuda} \PY{o}{=} \PY{n}{cudacompilelc4}\PY{p}{(}\PY{n}{lin\PYZus{}comb4\PYZus{}thread}\PY{p}{)}
         
         \PY{k}{def} \PY{n+nf}{lin\PYZus{}comb5\PYZus{}thread}\PY{p}{(}\PY{n}{v1}\PY{p}{,} \PY{n}{v2}\PY{p}{,} \PY{n}{v3}\PY{p}{,} \PY{n}{v4}\PY{p}{,} \PY{n}{v5}\PY{p}{,} \PY{n}{w1}\PY{p}{,} \PY{n}{w2}\PY{p}{,} \PY{n}{w3}\PY{p}{,} \PY{n}{w4}\PY{p}{,} \PY{n}{w5}\PY{p}{,} \PY{n}{out}\PY{p}{)}\PY{p}{:}
             \PY{n}{iy} \PY{p}{,}\PY{n}{jx}\PY{o}{=} \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)} 
             \PY{k}{if} \PY{n}{iy}\PY{o}{\PYZlt{}}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o+ow}{and} \PY{n}{jx}\PY{o}{\PYZlt{}}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{:}
                 \PY{n}{out}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n}{w1}\PY{o}{*}\PY{n}{v1}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{+} \PY{n}{w2}\PY{o}{*}\PY{n}{v2}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{+} \PY{n}{w3}\PY{o}{*}\PY{n}{v3}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{+}\PYZbs{}
                 \PY{n}{w4}\PY{o}{*}\PY{n}{v4}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{+} \PY{n}{w5}\PY{o}{*}\PY{n}{v5}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]}
         \PY{n}{cudacompilelc5} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{void(float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,float32,float32,float32,float32[:,:])}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{lincomb5\PYZus{}cuda} \PY{o}{=} \PY{n}{cudacompilelc5}\PY{p}{(}\PY{n}{lin\PYZus{}comb5\PYZus{}thread}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} def lin\PYZus{}comb\PYZus{}master\PYZus{}thread(vs, ws, out):}
         \PY{c+c1}{\PYZsh{}     i,j = nb.cuda.grid(2)}
         \PY{c+c1}{\PYZsh{}     tmp[i,j] = 0}
         \PY{c+c1}{\PYZsh{}     for n, v in enumerate(vs):}
         \PY{c+c1}{\PYZsh{}         tmp[i,j] += v[i,j]+ws[n]}
         \PY{c+c1}{\PYZsh{}     out[i,j] = tmp[i,j]}
         \PY{c+c1}{\PYZsh{} cudacompilelc = nb.cuda.jit(\PYZsq{}void(float32[:],float32[:,:,:],float32[:,:])\PYZsq{})}
         \PY{c+c1}{\PYZsh{} lincombmaster\PYZus{}cuda = cudacompilelc(lin\PYZus{}comb\PYZus{}master\PYZus{}thread)}
         
         \PY{k}{def} \PY{n+nf}{lin\PYZus{}comb4}\PY{p}{(}\PY{n}{v1}\PY{p}{,} \PY{n}{v2}\PY{p}{,} \PY{n}{v3}\PY{p}{,} \PY{n}{v4}\PY{p}{,} \PY{n}{w1}\PY{p}{,} \PY{n}{w2}\PY{p}{,} \PY{n}{w3}\PY{p}{,} \PY{n}{w4}\PY{p}{,} \PY{n}{out}\PY{p}{)}\PY{p}{:}
             \PY{n}{threadblock} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{32}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}
             \PY{n}{gridx} \PY{o}{=} \PY{p}{(}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{gridy} \PY{o}{=} \PY{p}{(}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{lincomb4\PYZus{}cuda}\PY{p}{[}\PY{p}{(}\PY{n}{gridx}\PY{p}{,}\PY{n}{gridy}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{n}{threadblock}\PY{p}{)}\PY{p}{]}\PY{p}{(}\PY{n}{v1}\PY{p}{,} \PY{n}{v2}\PY{p}{,} \PY{n}{v3}\PY{p}{,} \PY{n}{v4}\PY{p}{,} \PY{n}{w1}\PY{p}{,} \PY{n}{w2}\PY{p}{,} \PY{n}{w3}\PY{p}{,} \PY{n}{w4}\PY{p}{,} \PY{n}{out}\PY{p}{)}
             
         
         \PY{k}{def} \PY{n+nf}{lin\PYZus{}comb5}\PY{p}{(}\PY{n}{v1}\PY{p}{,} \PY{n}{v2}\PY{p}{,} \PY{n}{v3}\PY{p}{,} \PY{n}{v4}\PY{p}{,} \PY{n}{v5}\PY{p}{,} \PY{n}{w1}\PY{p}{,} \PY{n}{w2}\PY{p}{,} \PY{n}{w3}\PY{p}{,} \PY{n}{w4}\PY{p}{,} \PY{n}{w5}\PY{p}{,} \PY{n}{out}\PY{p}{)}\PY{p}{:}
             \PY{n}{threadblock} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{32}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}
             \PY{n}{gridx} \PY{o}{=} \PY{p}{(}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{gridy} \PY{o}{=} \PY{p}{(}\PY{n}{out}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{lincomb5\PYZus{}cuda}\PY{p}{[}\PY{p}{(}\PY{n}{gridx}\PY{p}{,}\PY{n}{gridy}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{n}{threadblock}\PY{p}{)}\PY{p}{]}\PY{p}{(}\PY{n}{v1}\PY{p}{,} \PY{n}{v2}\PY{p}{,} \PY{n}{v3}\PY{p}{,} \PY{n}{v4}\PY{p}{,} \PY{n}{v5}\PY{p}{,} \PY{n}{w1}\PY{p}{,} \PY{n}{w2}\PY{p}{,} \PY{n}{w3}\PY{p}{,} \PY{n}{w4}\PY{p}{,} \PY{n}{w5}\PY{p}{,} \PY{n}{out}\PY{p}{)}
         
         \PY{k}{def} \PY{n+nf}{max\PYZus{}cuda\PYZus{}thread}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{maxn}\PY{p}{)}\PY{p}{:}
             \PY{n}{iy} \PY{p}{,}\PY{n}{jx}\PY{o}{=} \PY{n}{cuda}\PY{o}{.}\PY{n}{grid}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)} 
             \PY{k}{if} \PY{n}{jx}\PY{o}{\PYZlt{}}\PY{n}{maxn}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o+ow}{and} \PY{n}{iy}\PY{o}{\PYZlt{}}\PY{n}{maxn}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{:}
                 \PY{n}{maxn}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]} \PY{o}{=} \PY{n+nb}{max}\PY{p}{(}\PY{n}{maxn}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{p}{,} \PY{n}{n}\PY{p}{[}\PY{n}{jx}\PY{p}{,}\PY{n}{iy}\PY{p}{]}\PY{p}{)}
         \PY{n}{cudacompilemax} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{jit}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{void(float32[:,:],float32[:,:])}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{max\PYZus{}cuda} \PY{o}{=} \PY{n}{cudacompilemax}\PY{p}{(}\PY{n}{max\PYZus{}cuda\PYZus{}thread}\PY{p}{)}
         
         \PY{k}{def} \PY{n+nf}{cudamax}\PY{p}{(}\PY{n}{n}\PY{p}{,}\PY{n}{maxn}\PY{p}{)}\PY{p}{:}
             \PY{n}{threadblock} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{32}\PY{p}{,}\PY{l+m+mi}{8}\PY{p}{)}
             \PY{n}{gridx} \PY{o}{=} \PY{p}{(}\PY{n}{maxn}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
             \PY{n}{gridy} \PY{o}{=} \PY{p}{(}\PY{n}{maxn}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{max\PYZus{}cuda}\PY{p}{[}\PY{p}{(}\PY{n}{gridx}\PY{p}{,}\PY{n}{gridy}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{n}{threadblock}\PY{p}{)}\PY{p}{]}\PY{p}{(}\PY{n}{n}\PY{p}{,}\PY{n}{maxn}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}25}]:} \PY{c+c1}{\PYZsh{}@nb.cuda.jit(fastmath=True,device=True)}
         \PY{k}{def} \PY{n+nf}{genfb\PYZus{}py}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,}\PYZbs{}
                   \PY{n}{du}\PY{p}{,}\PY{n}{dv}\PY{p}{,}\PY{n}{dn}\PY{p}{,} \PY{n}{gridu}\PY{p}{,}\PY{n}{gridv}\PY{p}{,}\PY{n}{gridn}\PY{p}{,} \PY{n}{threadblock}\PY{p}{,}\PYZbs{}
                   \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{0.281105}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{0.013}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.0880}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PYZbs{}
                   \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt}\PY{p}{,} \PYZbs{}
                   \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PYZbs{}
                     \PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} generalized forward backward feedback timestep}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{        generalized forward backward predictor corrector}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
            
             \PY{n}{p5}   \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.5}\PY{p}{)}
             \PY{n}{one}  \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{p32}  \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{1.5}\PY{p}{)}
             \PY{n}{beta} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{beta}\PY{p}{)}
             \PY{n}{eps}  \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{eps}\PY{p}{)}
             \PY{n}{gamma}\PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{gamma}\PY{p}{)}
             \PY{n}{mu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{mu}\PY{p}{)}
             \PY{n}{nu} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{nu}\PY{p}{)}
             
             \PY{n}{dn\PYZus{}m1}\PY{p}{,}\PY{n}{dn\PYZus{}m2}\PY{p}{,}\PY{n}{dn\PYZus{}m0} \PY{o}{=} \PY{n}{dn}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{dn}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{dn}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}     \PY{c+c1}{\PYZsh{} unpack  }
             \PY{n}{dndt\PYZus{}x}\PY{p}{[}\PY{n}{gridn}\PY{p}{,} \PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dn\PYZus{}m0}\PY{p}{)}
             \PY{c+c1}{\PYZsh{} must do the following before the u and v !}
             \PY{c+c1}{\PYZsh{}    n1 = n + ((p32+beta)* dn\PYZus{}m0 \PYZhy{} (p5+beta+beta)* dn\PYZus{}m1+ (beta)* dn\PYZus{}m2)*dt}
             \PY{n}{lincomb4\PYZus{}cuda}\PY{p}{[}\PY{n}{gridn}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{dn\PYZus{}m0}\PY{p}{,} \PY{n}{dn\PYZus{}m1}\PY{p}{,} \PY{n}{dn\PYZus{}m2}\PY{p}{,}\PYZbs{}
                                              \PY{n}{one}\PY{p}{,} \PY{p}{(}\PY{n}{p32}\PY{o}{+}\PY{n}{beta}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{beta}\PY{o}{+}\PY{n}{beta}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{p}{(}\PY{n}{beta}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{n}{n}\PY{p}{)}
             \PY{n}{du\PYZus{}m0}\PY{p}{,}\PY{n}{du\PYZus{}m1}\PY{p}{,}\PY{n}{du\PYZus{}m2}\PY{p}{,}\PY{n}{du\PYZus{}p1} \PY{o}{=} \PY{n}{du}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{du}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{du}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{du}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}     \PY{c+c1}{\PYZsh{} unpack}
             \PY{n}{dudt\PYZus{}x}\PY{p}{[}\PY{n}{gridu}\PY{p}{,} \PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du\PYZus{}p1}\PY{p}{,}\PYZbs{}
                                        \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
             \PY{n}{dv\PYZus{}m0}\PY{p}{,}\PY{n}{dv\PYZus{}m1}\PY{p}{,}\PY{n}{dv\PYZus{}m2}\PY{p}{,}\PY{n}{dv\PYZus{}p1} \PY{o}{=} \PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}     \PY{c+c1}{\PYZsh{} unpack   }
             \PY{n}{dvdt\PYZus{}x}\PY{p}{[}\PY{n}{gridv}\PY{p}{,} \PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv\PYZus{}p1}\PY{p}{,}\PYZbs{}
                                        \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
         
         
             \PY{c+c1}{\PYZsh{}u1 = u+ ((p5+gamma+eps+eps)*du\PYZus{}p1 +(p5\PYZhy{}gamma\PYZhy{}gamma\PYZhy{}eps\PYZhy{}eps\PYZhy{}eps)*du\PYZus{}m0 +gamma*du\PYZus{}m1+eps*du\PYZus{}m2)*dt}
             \PY{n}{lincomb5\PYZus{}cuda}\PY{p}{[}\PY{n}{gridu}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{u}\PY{p}{,} \PY{n}{du\PYZus{}p1}\PY{p}{,} \PY{n}{du\PYZus{}m0}\PY{p}{,} \PY{n}{du\PYZus{}m1}\PY{p}{,} \PY{n}{du\PYZus{}m2}\PY{p}{,}\PYZbs{}
                         \PY{n}{one}\PY{p}{,} \PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{gamma}\PY{o}{+}\PY{n}{eps}\PY{o}{+}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{p}{(}\PY{n}{p5}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PYZbs{}
                                              \PY{n}{gamma}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{n}{eps}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{n}{u}\PY{p}{)}
         
             \PY{c+c1}{\PYZsh{}v1 = v+ ((p5+gamma+eps+eps)*dv\PYZus{}p1 +(p5\PYZhy{}gamma\PYZhy{}gamma\PYZhy{}eps\PYZhy{}eps\PYZhy{}eps)*dv\PYZus{}m0 +gamma*dv\PYZus{}m1+eps*dv\PYZus{}m2)*dt}
             \PY{n}{lincomb5\PYZus{}cuda}\PY{p}{[}\PY{n}{gridv}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{v}\PY{p}{,} \PY{n}{dv\PYZus{}p1}\PY{p}{,} \PY{n}{dv\PYZus{}m0}\PY{p}{,} \PY{n}{dv\PYZus{}m1}\PY{p}{,} \PY{n}{dv\PYZus{}m2}\PY{p}{,}\PYZbs{}
                         \PY{n}{one}\PY{p}{,} \PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{gamma}\PY{o}{+}\PY{n}{eps}\PY{o}{+}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{p}{(}\PY{n}{p5}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PYZbs{}
                                              \PY{n}{gamma}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{n}{eps}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{n}{v}\PY{p}{)}
            \PY{c+c1}{\PYZsh{} lincomb5\PYZus{}cuda[gridv,threadblock](v, dv\PYZus{}p1, dv\PYZus{}m0, dv\PYZus{}m1, dv\PYZus{}m2, \PYZbs{}}
             \PY{c+c1}{\PYZsh{}                                 one, one*dt, np.float32(0.0), np.float32(0.0), np.float32(0.0), v)}
         
         
             \PY{n}{dv} \PY{o}{=} \PY{p}{(} \PY{n}{dv\PYZus{}p1}\PY{p}{,}\PY{n}{dv\PYZus{}m0}\PY{p}{,}\PY{n}{dv\PYZus{}m1}\PY{p}{,}\PY{n}{dv\PYZus{}m2} \PY{p}{)}
             \PY{n}{du} \PY{o}{=} \PY{p}{(} \PY{n}{du\PYZus{}p1}\PY{p}{,}\PY{n}{du\PYZus{}m0}\PY{p}{,}\PY{n}{du\PYZus{}m1}\PY{p}{,}\PY{n}{du\PYZus{}m2} \PY{p}{)}
             \PY{n}{dn} \PY{o}{=} \PY{p}{(} \PY{n}{dn\PYZus{}m0}\PY{p}{,}\PY{n}{dn\PYZus{}m1}\PY{p}{,}\PY{n}{dn\PYZus{}m2} \PY{p}{)}
             \PY{k}{return}  \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}26}]:} \PY{c+c1}{\PYZsh{} \PYZsh{} fast weighted linear combination kernels for different numbers of items}
         
         \PY{c+c1}{\PYZsh{} @nb.vectorize([\PYZsq{}float32(float32,float32,float32,float32)\PYZsq{}],target=\PYZsq{}cuda\PYZsq{})}
         \PY{c+c1}{\PYZsh{} def lin\PYZus{}comb\PYZus{}2(v1, v2, w1, w2):}
         \PY{c+c1}{\PYZsh{}     return v1*w1 + v2*w2}
         \PY{c+c1}{\PYZsh{} @nb.vectorize([\PYZsq{}float32(float32,float32,float32,float32,float32,float32)\PYZsq{}],target=\PYZsq{}cuda\PYZsq{})}
         \PY{c+c1}{\PYZsh{} def lin\PYZus{}comb\PYZus{}3(v1, v2, v3, w1, w2, w3):}
         \PY{c+c1}{\PYZsh{}     return v1*w1 + v2*w2 + v3*w3}
         \PY{c+c1}{\PYZsh{} @nb.vectorize([\PYZsq{}float32(float32,float32,float32,float32,float32,float32,float32,float32)\PYZsq{}],target=\PYZsq{}cuda\PYZsq{})}
         \PY{c+c1}{\PYZsh{} def lin\PYZus{}comb\PYZus{}4(v1, v2, v3, v4, w1, w2, w3, w4):}
         \PY{c+c1}{\PYZsh{}     return v1*w1 + v2*w2 + v3*w3 + v4*w4}
         \PY{c+c1}{\PYZsh{} @nb.vectorize([\PYZsq{}float32(float32,float32,float32,float32,float32,float32,float32,float32,float32,float32)\PYZsq{}],target=\PYZsq{}cuda\PYZsq{})}
         \PY{c+c1}{\PYZsh{} def lin\PYZus{}comb\PYZus{}5(v1, v2, v3, v4, v5, w1, w2, w3, w4, w5):}
         \PY{c+c1}{\PYZsh{}     return v1*w1 + v2*w2 + v3*w3 + v4*w4 + v5*w5}
         
         
         \PY{c+c1}{\PYZsh{} @nb.numba.jit(\PYZsq{}void(float32[:,:],float32[:,:],float32,float32,float32[:,:])\PYZsq{})}
         \PY{c+c1}{\PYZsh{} def lincomb2(v1, v2, w1, w2, out):}
         \PY{c+c1}{\PYZsh{}     out[:,:] = lin\PYZus{}comb\PYZus{}2(v1, v2, w1, w2)}
         \PY{c+c1}{\PYZsh{} @nb.numba.jit(\PYZsq{}void(float32[:,:],float32[:,:],float32[:,:],float32,float32,float32,float32[:,:])\PYZsq{})}
         \PY{c+c1}{\PYZsh{} def lincomb3(v1, v2, v3, w1, w2, w3, out):}
         \PY{c+c1}{\PYZsh{}     out[:,:] = lin\PYZus{}comb\PYZus{}3(v1, v2, v3, w1, w2, w3)}
         \PY{c+c1}{\PYZsh{} @nb.numba.jit(\PYZsq{}void(float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,float32,float32,float32[:,:])\PYZsq{})}
         \PY{c+c1}{\PYZsh{} def lincomb4(v1, v2, v3, v4, w1, w2, w3, w4, out):}
         \PY{c+c1}{\PYZsh{}     out[:,:] = lin\PYZus{}comb\PYZus{}4(v1, v2, v3, v4, w1, w2, w3, w4)}
         \PY{c+c1}{\PYZsh{} @nb.numba.jit(\PYZsq{}void(float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32[:,:],float32,float32,float32,float32,float32,float32[:,:])\PYZsq{})}
         \PY{c+c1}{\PYZsh{} def lincomb5(v1, v2, v3, v4, v5, w1, w2, w3, w4, w5, out):}
         \PY{c+c1}{\PYZsh{}     out[:,:] = lin\PYZus{}comb\PYZus{}5(v1, v2, v3, v4, v5, w1, w2, w3, w4, w5)}
             
           
\end{Verbatim}


    \hypertarget{simulation-driver}{%
\subsection{Simulation driver}\label{simulation-driver}}

the simulation driver iterates the time steppers for a defined period of
time. This iteratively produces the state of the whole ocean region in
the state variables of height (n) and velocity (u,v) at each grid point.

Snapshots of the height is kept periodically and stored into a harddisk
mapped virtual memory array for later conversion to animation or images.

The maximum height at every grid cell is recorded.

\hypertarget{gpu-and-cpu-versions}{%
\subsubsection{GPU and CPU versions}\label{gpu-and-cpu-versions}}

since the memory and thread management is different on the GPU and CPU
there are two different versions of the simulator.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}27}]:} \PY{k}{def} \PY{n+nf}{simulate\PYZus{}cuda}\PY{p}{(}\PY{n}{initstate}\PY{p}{,} \PY{n}{t}\PY{p}{,} \PY{n}{timestep}\PY{o}{=}\PY{n}{genfb\PYZus{}py}\PY{p}{,} \PY{n}{nttname} \PY{o}{=} \PY{k+kc}{False}\PY{p}{,} \PYZbs{}
                      \PY{n}{bounds} \PY{o}{=} \PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{saveinterval}\PY{o}{=}\PY{l+m+mi}{10}\PY{p}{,}\PYZbs{}
                      \PY{n}{drive}\PY{o}{=}\PY{n}{donothing}\PY{p}{,} \PYZbs{}
                      \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{0.281105}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{0.013}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.0880}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PYZbs{}
                      \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt}\PY{p}{,} \PYZbs{}
                      \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} gives surface height array of the system after evert dt}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{        evolve shallow water system from initstate over t seconds}
         \PY{l+s+sd}{        returns:}
         \PY{l+s+sd}{            ntt (n through time) np.memmap,}
         \PY{l+s+sd}{            maxn (the maximum value of n over the duration at each point) np.array,}
         \PY{l+s+sd}{            \PYZsh{}minn (the minimum value of n over the duration at each point) np.array,}
         \PY{l+s+sd}{            \PYZsh{}timemax (the number of seconds until the maximum height at each point) np.array}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{simulate start}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
             \PY{n}{bounds} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{asarray}\PY{p}{(}\PY{n}{bounds}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
             \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dt} \PY{o}{=} \PY{p}{[}\PY{n}{initstate}\PY{p}{[}\PY{n}{k}\PY{p}{]} \PY{k}{for} \PY{n}{k} \PY{o+ow}{in} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{u}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{v}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{]}\PY{c+c1}{\PYZsh{}h, state.n, state.u, state.v, state.dx, state.dy, state.dt}
             
         \PY{c+c1}{\PYZsh{}     h[np.logical\PYZus{}and(np.greater(h, \PYZhy{}0.1), np.less(h, 0.2))] = np.float32(0.1)}
             \PY{n}{f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{f}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{l+m+mi}{180}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{24}\PY{o}{*}\PY{l+m+mi}{3600}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}\PY{p}{)}
             
         
             
             
             \PY{n}{nu} \PY{o}{=} \PY{p}{(}\PY{n}{dx}\PY{o}{+}\PY{n}{dy}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{1000}
             \PY{c+c1}{\PYZsh{}     state = initstate}
             \PY{n}{mmax} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{n}\PY{p}{)}\PY{p}{)}
             \PY{n}{landthresh} \PY{o}{=} \PY{l+m+mf}{1.5}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{n}\PY{p}{)} \PY{c+c1}{\PYZsh{} threshhold for when sea ends and land begins}
             \PY{n}{itrs} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{ceil}\PY{p}{(}\PY{n}{t}\PY{o}{/}\PY{n}{dt}\PY{p}{)}\PY{p}{)}
             
             \PY{n}{saveinterval} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{(}\PY{n}{saveinterval}\PY{o}{/}\PY{o}{/}\PY{n}{dt}\PY{p}{)}
             \PY{k}{assert} \PY{p}{(}\PY{n}{dt} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{negative dt!}\PY{l+s+s1}{\PYZsq{}} \PY{c+c1}{\PYZsh{} dont try if timstep is zero or negative}
             
             \PY{n}{ntt} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{ceil}\PY{p}{(}\PY{n}{itrs}\PY{o}{/}\PY{n}{saveinterval}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{p}{)}\PY{o}{+}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}     ntt = np.memmap(str(nttname)+\PYZsq{}\PYZus{}eed\PYZsq{}, dtype=\PYZsq{}float32\PYZsq{}, mode=\PYZsq{}w+\PYZsq{}, shape=(itrs,)+n.shape)}
             \PY{n}{maxn} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{n}\PY{o}{.}\PY{n}{dtype}\PY{p}{)} \PY{c+c1}{\PYZsh{} max height in that area}
         \PY{c+c1}{\PYZsh{}     minn = np.zeros(n.shape, dtype=n.dtype) \PYZsh{} minimum height that was at each point}
         \PY{c+c1}{\PYZsh{}     timemax = np.zeros(n.shape, dtype=n.dtype) \PYZsh{} when the maximum height occured}
             
             \PY{n}{coastx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{less}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{landthresh}\PY{p}{)} \PY{c+c1}{\PYZsh{} where the reflective condition is enforced on the coast}
         
             \PY{n}{coastx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{coastx}\PY{p}{)}
             
             
             \PY{n}{ch}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{h}\PY{p}{)}
             \PY{n}{cn}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{n}\PY{p}{)}
             \PY{n}{cu}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{u}\PY{p}{)}
             \PY{n}{cv}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{v}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}     cout = nb.cuda.to\PYZus{}device(uout)}
         \PY{c+c1}{\PYZsh{}     cnout = nb.cuda.to\PYZus{}device(nout)}
             \PY{n}{cf}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{f}\PY{p}{)}
             \PY{n}{ccoastx}\PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{coastx}\PY{p}{)}
             \PY{n}{cmaxn}  \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{maxn}\PY{p}{)}
         
             \PY{n}{threadblock}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{16}\PY{p}{,}\PY{l+m+mi}{16}\PY{p}{)}
           \PY{c+c1}{\PYZsh{}  threadblock=(32,8)   \PYZsh{} this fails but  Why?????????????????????????????????????}
                                 \PY{c+c1}{\PYZsh{} no errors, just nothing at all updates on GPU}
         \PY{c+c1}{\PYZsh{}     gridu = ( (u.shape[0]+threadblock[0]\PYZhy{}1)//threadblock[0],}
         \PY{c+c1}{\PYZsh{}               (u.shape[1]+threadblock[1]\PYZhy{}1)//threadblock[1])}
         \PY{c+c1}{\PYZsh{}     gridv = ( (v.shape[0]+threadblock[0]\PYZhy{}1)//threadblock[0],}
         \PY{c+c1}{\PYZsh{}               (v.shape[1]+threadblock[1]\PYZhy{}1)//threadblock[1])}
         \PY{c+c1}{\PYZsh{}     gridn = ( (n.shape[0]+threadblock[0]\PYZhy{}1)//threadblock[0],}
         \PY{c+c1}{\PYZsh{}               (n.shape[1]+threadblock[1]\PYZhy{}1)//threadblock[1])}
             \PY{c+c1}{\PYZsh{} other order.}
             \PY{n}{gridu} \PY{o}{=} \PY{p}{(} \PY{p}{(}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}
                       \PY{p}{(}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{gridv} \PY{o}{=} \PY{p}{(} \PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}
                       \PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
             \PY{n}{gridn} \PY{o}{=} \PY{p}{(} \PY{p}{(}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}
                       \PY{p}{(}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
           
             \PY{n}{dudt\PYZus{}x} \PY{o}{=} \PY{n}{dudt\PYZus{}drive\PYZus{}cuda}\PY{c+c1}{\PYZsh{}[gridu,threadblock]  \PYZsh{} these override the inputs}
             \PY{n}{dvdt\PYZus{}x} \PY{o}{=} \PY{n}{dvdt\PYZus{}drive\PYZus{}cuda}\PY{c+c1}{\PYZsh{}[gridv,threadblock]}
             \PY{n}{dndt\PYZus{}x} \PY{o}{=} \PY{n}{dndt\PYZus{}drive\PYZus{}cuda}\PY{c+c1}{\PYZsh{}[gridn,threadblock]}
         
             \PY{c+c1}{\PYZsh{}create  du,dv,dn on device}
             \PY{n}{du0} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{u}\PY{p}{)}
             \PY{n}{dv0} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{v}\PY{p}{)}
             \PY{n}{dn0} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{n}\PY{p}{)}
          
             \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dndt\PYZhy{}cuda attrs }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{.}\PY{n}{\PYZus{}func}\PY{o}{.}\PY{n}{get}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{attrs}\PY{p}{)}
             \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dudt\PYZhy{}cuda attrs }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{dudt\PYZus{}x}\PY{o}{.}\PY{n}{\PYZus{}func}\PY{o}{.}\PY{n}{get}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{attrs}\PY{p}{)}
             \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dvdt\PYZhy{}cuda attrs }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{.}\PY{n}{\PYZus{}func}\PY{o}{.}\PY{n}{get}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{attrs}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} load in the intial values}
             \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{initializing}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
             \PY{n}{dndt\PYZus{}x}\PY{p}{[}\PY{n}{gridn}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{ch}\PY{p}{,} \PY{n}{cn}\PY{p}{,}     \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dn0}\PY{p}{)}
             \PY{n}{dvdt\PYZus{}x}\PY{p}{[}\PY{n}{gridv}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{ch}\PY{p}{,} \PY{n}{cn}\PY{p}{,} \PY{n}{cf}\PY{p}{,} \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv0}\PY{p}{,}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
             \PY{n}{dudt\PYZus{}x}\PY{p}{[}\PY{n}{gridu}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{ch}\PY{p}{,} \PY{n}{cn}\PY{p}{,} \PY{n}{cf}\PY{p}{,} \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du0}\PY{p}{,}\PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} create the tuples }
             \PY{n}{cdu} \PY{o}{=} \PY{p}{(}\PY{n}{du0}\PY{p}{,} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{du0}\PY{p}{)}\PY{p}{,} \PYZbs{}
                    \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{du0}\PY{p}{)}\PY{p}{,} \PYZbs{}
                    \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{du0}\PY{p}{)} \PY{p}{)}
             
             \PY{n}{cdv} \PY{o}{=} \PY{p}{(}\PY{n}{dv0}\PY{p}{,}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{,}\PYZbs{}
                    \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{,} \PYZbs{}
                    \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{)}
             
             \PY{n}{cdn} \PY{o}{=} \PY{p}{(}\PY{n}{dn0}\PY{p}{,} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{dn0}\PY{p}{)}\PY{p}{,}\PYZbs{}
                    \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{dn0}\PY{p}{)}\PY{p}{)}
             
             \PY{c+c1}{\PYZsh{} initialize the tuples on the device}
             \PY{k}{for} \PY{n}{d} \PY{o+ow}{in} \PY{n}{cdn}\PY{p}{:}
                 \PY{n}{d}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=}  \PY{n}{dn0}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}
                 
             \PY{k}{for} \PY{n}{d} \PY{o+ow}{in} \PY{n}{cdv}\PY{p}{:}
                 \PY{n}{d}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{dv0}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}
                    
             \PY{k}{for} \PY{n}{d} \PY{o+ow}{in} \PY{n}{cdu}\PY{p}{:}
                 \PY{n}{d}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{du0}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}
             
             \PY{n}{land}   \PY{o}{=}   \PY{n}{land\PYZus{}cuda}\PY{c+c1}{\PYZsh{}[(gridu[0],gridv[1]),threadblock]  \PYZsh{} is this grid right }
             \PY{n}{border} \PY{o}{=} \PY{n}{border\PYZus{}cuda}\PY{c+c1}{\PYZsh{}[(gridu[0],gridv[1]),threadblock]}
             
             \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{synchronize}\PY{p}{(}\PY{p}{)}  \PY{c+c1}{\PYZsh{} needed?}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{threadblock,grid}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{threadblock}\PY{p}{,}\PY{n}{gridn}\PY{p}{,}\PY{n}{gridu}\PY{p}{,}\PY{n}{gridv}\PY{p}{)}
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{simulating...}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{k}{try}\PY{p}{:}
                 \PY{k}{for} \PY{n}{itr} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{itrs}\PY{p}{)}\PY{p}{:}\PY{c+c1}{\PYZsh{} iterate for the given number of iterations}
                     \PY{k}{if} \PY{n}{itr}\PY{o}{\PYZpc{}}\PY{k}{saveinterval} == 0:
                         \PY{c+c1}{\PYZsh{}cuda.synchronize() \PYZsh{} is this needed?}
                         \PY{n}{ntt}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{(}\PY{n}{itr}\PY{o}{/}\PY{n}{saveinterval}\PY{p}{)}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{cn}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}
                   
                     \PY{n}{cdu}\PY{p}{,} \PY{n}{cdv}\PY{p}{,} \PY{n}{cdn} \PY{o}{=} \PY{n}{timestep}\PY{p}{(}\PY{n}{ch}\PY{p}{,} \PY{n}{cn}\PY{p}{,} \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{cf}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,}\PYZbs{}
                                 \PY{n}{cdu}\PY{p}{,}\PY{n}{cdv}\PY{p}{,}\PY{n}{cdn}\PY{p}{,}\PY{n}{gridu}\PY{p}{,}\PY{n}{gridv}\PY{p}{,}\PY{n}{gridn}\PY{p}{,}\PY{n}{threadblock}\PY{p}{,} \PYZbs{}
                                 \PY{l+m+mf}{0.281105}\PY{p}{,} \PY{l+m+mf}{0.013}\PY{p}{,} \PY{l+m+mf}{0.0880}\PY{p}{,} \PY{l+m+mf}{0.3}\PY{p}{,} \PY{l+m+mf}{0.3}\PY{p}{,} \PYZbs{}
                                 \PY{n}{dudt\PYZus{}x}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{p}{,} \PYZbs{}
                                 \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True} \PYZbs{}
                            \PY{p}{)} \PY{c+c1}{\PYZsh{} pushes n, u, v one step into the future}
         
                 \PY{c+c1}{\PYZsh{}    land\PYZus{}cuda[gridn,threadblock](ch, cn, cu, cv, ccoastx) \PYZsh{} how to handle land/coast}
                  \PY{c+c1}{\PYZsh{}   border\PYZus{}cuda(cn, cu, cv, 16, bounds) }
                  \PY{c+c1}{\PYZsh{}   drive(ch, cn, cu, cv, cf, dt, dx, dy, nu, ccoastx, cbounds, mu, itr)}
                     \PY{n}{cudamax}\PY{p}{(}\PY{n}{cn}\PY{p}{,}\PY{n}{cmaxn}\PY{p}{)}
                 \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{simulation complete}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{k}{except} \PY{n+ne}{Exception} \PY{k}{as} \PY{n}{e}\PY{p}{:}
                 \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{timestep: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{itr}\PY{p}{)}
                 \PY{k}{raise} \PY{n}{e}
             \PY{n}{maxn} \PY{o}{=}  \PY{n}{cmaxn}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}
             
             \PY{k}{return} \PY{n}{ntt}\PY{p}{,} \PY{n}{maxn}\PY{c+c1}{\PYZsh{}.copy\PYZus{}to\PYZus{}host()\PYZsh{}, minn, timemax \PYZsh{} return surface height through time and maximum heights}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}28}]:} \PY{n}{sizex}\PY{p}{,} \PY{n}{sizey} \PY{o}{=} \PY{l+m+mi}{400}\PY{p}{,}\PY{l+m+mi}{200}
         \PY{n}{oned} \PY{o}{=} \PY{p}{\PYZob{}}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1000}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,}\PY{n}{sizey}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{*}\PY{n}{lingauss}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,} \PY{n}{sizey}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{10}\PY{p}{,} \PY{l+m+mi}{300}\PY{p}{)}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{u}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{sizey}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{v}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,} \PY{n}{sizey}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{50}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{50}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.1}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,}\PY{p}{)}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizey}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{p}{\PYZcb{}}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{oned}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{]}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{oned}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{]}\PY{o}{*}\PY{l+m+mi}{100}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    
    \begin{verbatim}
<IPython.core.display.Javascript object>
    \end{verbatim}

    
    
    \begin{verbatim}
<IPython.core.display.HTML object>
    \end{verbatim}

    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}29}]:} \PY{k}{def} \PY{n+nf}{simulate}\PY{p}{(}\PY{n}{initstate}\PY{p}{,} \PY{n}{t}\PY{p}{,} \PY{n}{timestep}\PY{o}{=}\PY{n}{forward}\PY{p}{,} \PY{n}{drive}\PY{o}{=}\PY{n}{donothing}\PY{p}{,} \PYZbs{}
                      \PY{n}{bounds} \PY{o}{=} \PY{p}{[}\PY{l+m+mf}{0.97}\PY{p}{,} \PY{l+m+mf}{0.97}\PY{p}{,} \PY{l+m+mf}{0.97}\PY{p}{,} \PY{l+m+mf}{0.97}\PY{p}{]}\PY{p}{,} \PY{n}{saveinterval}\PY{o}{=}\PY{l+m+mi}{10}\PY{p}{,}\PYZbs{}
                      \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{0.281105}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{0.013}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.0880}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{l+m+mf}{0.3}\PY{p}{,} \PYZbs{}
                      \PY{n}{dudt\PYZus{}x} \PY{o}{=} \PY{n}{dudt}\PY{p}{,} \PY{n}{dvdt\PYZus{}x} \PY{o}{=} \PY{n}{dvdt}\PY{p}{,} \PY{n}{dndt\PYZus{}x} \PY{o}{=} \PY{n}{dndt}\PY{p}{,} \PYZbs{}
                      \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} gives surface height array of the system after evert dt}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{        evolve shallow water system from initstate over t seconds}
         \PY{l+s+sd}{        returns:}
         \PY{l+s+sd}{            ntt (numpy memmap of n through time) numpy array,}
         \PY{l+s+sd}{            maxn (the maximum value of n over the duration at each point) numpy array,}
         \PY{l+s+sd}{            minn (the minimum value of n over the duration at each point) numpy array,}
         \PY{l+s+sd}{            timemax (the number of seconds until the maximum height at each point) numpy array}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{n}{bounds} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{asarray}\PY{p}{(}\PY{n}{bounds}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
             \PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dt} \PY{o}{=} \PY{p}{[}\PY{n}{initstate}\PY{p}{[}\PY{n}{k}\PY{p}{]} \PY{k}{for} \PY{n}{k} \PY{o+ow}{in} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{u}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{v}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{]}
             
             \PY{n}{f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{f}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{l+m+mi}{180}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{24}\PY{o}{*}\PY{l+m+mi}{3600}\PY{p}{)}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{newaxis}\PY{p}{]}\PY{p}{)}
             
             
             \PY{n}{du0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{u}\PY{p}{)}
             \PY{n}{dv0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{v}\PY{p}{)}
             \PY{n}{dn0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{n}\PY{p}{)}
             
                
             \PY{n}{dndt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dn0}\PY{p}{)}
             \PY{n}{dn} \PY{o}{=} \PY{p}{(}\PY{n}{dn0}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dn0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dn0}\PY{p}{)}\PY{p}{)}
             
             \PY{n}{dudt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du0}\PY{p}{)}
             \PY{n}{du} \PY{o}{=} \PY{p}{(}\PY{n}{du0}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{du0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{du0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{du0}\PY{p}{)}\PY{p}{)}
             
             \PY{n}{dvdt\PYZus{}x}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv0}\PY{p}{)}
             \PY{n}{dv} \PY{o}{=} \PY{p}{(}\PY{n}{dv0}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{)}
             
             \PY{n}{nu} \PY{o}{=} \PY{p}{(}\PY{n}{dx}\PY{o}{+}\PY{n}{dy}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{1000}
             
             \PY{n}{mmax} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{n}\PY{p}{)}\PY{p}{)}
             \PY{n}{landthresh} \PY{o}{=} \PY{l+m+mf}{1.5}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{n}\PY{p}{)} \PY{c+c1}{\PYZsh{} threshhold for when sea ends and land begins}
             \PY{n}{itrs} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{ceil}\PY{p}{(}\PY{n}{t}\PY{o}{/}\PY{n}{dt}\PY{p}{)}\PY{p}{)}
             \PY{n}{saveinterval} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{(}\PY{n}{saveinterval}\PY{o}{/}\PY{o}{/}\PY{n}{dt}\PY{p}{)}
             \PY{k}{assert} \PY{p}{(}\PY{n}{dt} \PY{o}{\PYZgt{}}\PY{o}{=} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{negative dt!}\PY{l+s+s1}{\PYZsq{}} \PY{c+c1}{\PYZsh{} dont try if timstep is zero or negative}
             
             \PY{n}{ntt} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{ceil}\PY{p}{(}\PY{n}{itrs}\PY{o}{/}\PY{n}{saveinterval}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{p}{)}\PY{o}{+}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
             \PY{n}{maxn} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{n}\PY{o}{.}\PY{n}{dtype}\PY{p}{)} \PY{c+c1}{\PYZsh{} max height in that area}
             
             \PY{n}{coastx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{less}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{landthresh}\PY{p}{)} \PY{c+c1}{\PYZsh{} where the reflective condition is enforced on the coast}
             
             \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{simulating...}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{k}{try}\PY{p}{:}
                 \PY{k}{for} \PY{n}{itr} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{itrs}\PY{p}{)}\PY{p}{:}\PY{c+c1}{\PYZsh{} iterate for the given number of iterations}
                     \PY{k}{if} \PY{n}{itr}\PY{o}{\PYZpc{}}\PY{k}{saveinterval} == 0:
                         \PY{n}{ntt}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{(}\PY{n}{itr}\PY{o}{/}\PY{n}{saveinterval}\PY{p}{)}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{n}
                     
                     \PY{n}{maxn} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{p}{(}\PY{n}{n}\PY{p}{,} \PY{n}{maxn}\PY{p}{)}\PY{p}{,} \PY{n}{axis}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)} \PY{c+c1}{\PYZsh{} record new maxes if they are greater than previous records        }
                     
                     \PY{c+c1}{\PYZsh{} pushes n, u, v one step into the future}
                     \PY{n}{n}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{,} \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn} \PY{o}{=} \PY{n}{timestep}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du}\PY{p}{,} \PY{n}{dv}\PY{p}{,} \PY{n}{dn}\PY{p}{,} \PYZbs{}
                                 \PY{l+m+mf}{0.281105}\PY{p}{,} \PY{l+m+mf}{0.013}\PY{p}{,} \PY{l+m+mf}{0.0880}\PY{p}{,} \PY{l+m+mf}{0.3}\PY{p}{,} \PY{l+m+mf}{0.3}\PY{p}{,} \PYZbs{}
                                 \PY{n}{dudt\PYZus{}x}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{p}{,} \PYZbs{}
                                 \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True} \PYZbs{}
                            \PY{c+c1}{\PYZsh{}      beta=beta, eps=eps, gamma=gamma, mu=mu, nu=nu, \PYZbs{}}
                            \PY{c+c1}{\PYZsh{}     dudt\PYZus{}x=dudt\PYZus{}x, dvdt\PYZus{}x=dvdt\PYZus{}x, dndt\PYZus{}x=dndt\PYZus{}x, \PYZbs{}}
                           \PY{c+c1}{\PYZsh{}      grav=grav, cori=cori, advx=advx, advy=advy, attn=attn}
                                                 \PY{p}{)}
         
              \PY{c+c1}{\PYZsh{}       land(h, n, u, v, coastx) \PYZsh{} how to handle land/coast}
              \PY{c+c1}{\PYZsh{}       border(n, u, v, 15, bounds) }
              \PY{c+c1}{\PYZsh{}       drive(h, n, u, v, f, dt, dx, dy, nu, coastx, bounds, mu, itr)}
                 \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{simulation complete}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{k}{except} \PY{n+ne}{Exception} \PY{k}{as} \PY{n}{e}\PY{p}{:}
                 \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{timestep: }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{itr}\PY{p}{)}
                 \PY{k}{raise} \PY{n}{e}
             \PY{k}{return} \PY{n}{ntt}\PY{p}{,} \PY{n}{maxn}\PY{c+c1}{\PYZsh{}, minn, timemax \PYZsh{} return surface height through time and maximum heights}
\end{Verbatim}


    \hypertarget{unit-test-verification}{%
\subsection{unit test verification}\label{unit-test-verification}}

assuming n (the sea surface height) is insignificant compared to h (the
depth), then a solution to the shallow water equations can be
approximated, giving the wave speed as the square root of the product of
the gravity coeffecient and the depth. Using a unit test, the speed a
wave propogates at in a small scale simulation is compared to this
expected value. The unit tests verifies the wave speed is approximately
correct within a reasonable margin of error, and thus verifies the
model.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}30}]:} \PY{c+c1}{\PYZsh{}wavespeed and differential tests}
         \PY{k+kn}{import} \PY{n+nn}{unittest}
         \PY{n}{fooo} \PY{o}{=} \PY{p}{[}\PY{p}{]}
         \PY{k}{class} \PY{n+nc}{testWaveSpeed}\PY{p}{(}\PY{n}{unittest}\PY{o}{.}\PY{n}{TestCase}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} tests if the wave speed is correct}
             \PY{k}{def} \PY{n+nf}{setUp}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dur} \PY{o}{=} \PY{l+m+mi}{100} \PY{c+c1}{\PYZsh{} duration of period to calculate speed over}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{10}\PY{p}{,} \PY{l+m+mi}{1000}\PY{p}{)} \PY{c+c1}{\PYZsh{} grid squares (dx\PYZsq{}s)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dx} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{100}\PY{p}{)} \PY{c+c1}{\PYZsh{} meters}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{100}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lat} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} physical location the simulation is over}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lon} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0} \PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{h} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{10000}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{)}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{n} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.1}\PY{p}{)}\PY{o}{*}\PY{n}{lingauss}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{,} \PY{l+m+mi}{10}\PY{p}{,} \PY{n}{cy}\PY{o}{=}\PY{l+m+mi}{500}\PY{p}{,} \PY{n}{theta}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)} \PY{c+c1}{\PYZsh{} intial condition single wave in the center}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{u} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} x vel array}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{v} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{0}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} y vel array}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dt} \PY{o}{=} \PY{l+m+mf}{0.3}\PY{o}{*}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dx}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{h}\PY{p}{)}\PY{o}{*}\PY{n}{p}\PY{o}{.}\PY{n}{g}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{margin} \PY{o}{=} \PY{l+m+mf}{0.15} \PY{c+c1}{\PYZsh{} error margin of test}
                 
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{initialcondition} \PY{o}{=} \PY{p}{\PYZob{}}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{h}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{n}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{u}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{u}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{v}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{v}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dt}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dx}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dy}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lat}\PY{p}{,}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lon}
                 \PY{p}{\PYZcb{}}
         \PY{c+c1}{\PYZsh{}         self.testStart = State(self.h, self.n, self.u, self.v, self.dx, self.dy, self.lat, self.lon)}
             \PY{k}{def} \PY{n+nf}{calcWaveSpeed}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{ar1}\PY{p}{,} \PY{n}{ar2}\PY{p}{,} \PY{n}{Dt}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} calculat how fast the wave is propagating out}
                 \PY{n}{midstrip1} \PY{o}{=} \PY{n}{ar1}\PY{p}{[}\PY{n+nb}{int}\PY{p}{(}\PY{n}{ar1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n+nb}{int}\PY{p}{(}\PY{n}{ar1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{:}\PY{p}{]}
                 \PY{n}{midstrip2} \PY{o}{=} \PY{n}{ar2}\PY{p}{[}\PY{n+nb}{int}\PY{p}{(}\PY{n}{ar1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n+nb}{int}\PY{p}{(}\PY{n}{ar2}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{:}\PY{p}{]}
                 \PY{n}{peakloc1} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{argmax}\PY{p}{(}\PY{n}{midstrip1}\PY{p}{)}
                 \PY{n}{peakloc2} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{argmax}\PY{p}{(}\PY{n}{midstrip2}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{l+m+mi}{6}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{clf}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}         plt.subplot(2, 1, 1)}
         \PY{c+c1}{\PYZsh{}         plt.imshow(ar1)}
         \PY{c+c1}{\PYZsh{}         plt.subplot(2, 1, 2)}
         \PY{c+c1}{\PYZsh{}         plt.imshow(ar2)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{midstrip1}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{midstrip2}\PY{p}{,} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{\PYZhy{}\PYZhy{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}         plt.plot(midstrip1\PYZhy{}midstrip2)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
                 \PY{n}{speed} \PY{o}{=} \PY{p}{(}\PY{n}{peakloc2} \PY{o}{\PYZhy{}} \PY{n}{peakloc1}\PY{p}{)}\PY{o}{*}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dy}\PY{o}{/}\PY{n}{Dt}
                 \PY{k}{return} \PY{n}{speed}
             \PY{k}{def} \PY{n+nf}{calcExactWaveSpeed}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} approximently how fast the wave should be propagating outwards}
                 \PY{n}{ws} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{l+m+mf}{9.81}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{average}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{h}\PY{p}{)}\PY{p}{)}
                 \PY{k}{return} \PY{n}{ws}
             \PY{k}{def} \PY{n+nf}{test\PYZus{}wavespeed}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} test if the expected and calculated wave speeds line up approcimently}
                 
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{simdata} \PY{o}{=} \PY{n}{simulate}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{initialcondition}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dur}\PY{p}{,} \PY{n}{saveinterval}\PY{o}{=}\PY{l+m+mf}{0.2}\PY{p}{,} \PYZbs{}
                                         \PY{n}{timestep}\PY{o}{=}\PY{n}{genfb}\PY{p}{,} \PY{n}{bounds}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{False}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}         self.testFrames, self.testmax, self.testmin = self.simdata[:3]}
                 \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{l+m+mi}{7}\PY{p}{)}
                 \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{simdata}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{5}\PY{p}{]}\PY{p}{)}\PY{c+c1}{\PYZsh{}self.testStart.n)}
         \PY{c+c1}{\PYZsh{}         arts = [(plt.imshow(frame),) for frame in self.simdata[0]]}
         \PY{c+c1}{\PYZsh{}         anim = animation.ArtistAnimation(fig, arts)}
                 
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{testFrames} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{simdata}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{testEndN} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{testFrames}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}
                 \PY{n}{calcedws} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{calcWaveSpeed}\PY{p}{(} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{initialcondition}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{testEndN}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dur} \PY{p}{)}
                 \PY{n}{exactws} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{calcExactWaveSpeed}\PY{p}{(}\PY{p}{)}
                 \PY{n}{err} \PY{o}{=} \PY{p}{(}\PY{n}{calcedws} \PY{o}{\PYZhy{}} \PY{n}{exactws}\PY{p}{)}\PY{o}{/}\PY{n}{exactws}
                 \PY{n+nb}{print}\PY{p}{(}\PY{n}{calcedws}\PY{p}{,} \PY{n}{exactws}\PY{p}{)}
                 \PY{n+nb}{print}\PY{p}{(}\PY{n}{err}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{margin}\PY{p}{)}
                 
                 \PY{k}{assert} \PY{p}{(}\PY{n+nb}{abs}\PY{p}{(}\PY{n}{err}\PY{p}{)} \PY{o}{\PYZlt{}} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{margin}\PY{p}{)} \PY{c+c1}{\PYZsh{} error margin}
             \PY{k}{def} \PY{n+nf}{tearDown}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dur}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dx}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dy}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lat}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lon}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{size}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{h}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{n}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{u}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{v}\PY{p}{)}
         
         \PY{k}{class} \PY{n+nc}{testdifferential}\PY{p}{(}\PY{n}{unittest}\PY{o}{.}\PY{n}{TestCase}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} differental function test (d\PYZus{}dx)}
             \PY{k}{def} \PY{n+nf}{setUp}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{a} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{arange}\PY{p}{(}\PY{l+m+mi}{144}\PY{p}{)} \PY{c+c1}{\PYZsh{} test input}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{a} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{a}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{12}\PY{p}{)} \PY{c+c1}{\PYZsh{} make into 2d array}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{ddthreshold} \PY{o}{=} \PY{l+m+mf}{1E\PYZhy{}16}
             \PY{k}{def} \PY{n+nf}{test\PYZus{}ddx}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{n}{da} \PY{o}{=} \PY{n}{d\PYZus{}dx}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{a}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{diff} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{da}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{da}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}
                 \PY{n}{maxdiff} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{diff}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{assertTrue}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{all}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{da}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{:}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZlt{}} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{ddthreshold}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{expected zero along borders}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{assertTrue}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{all}\PY{p}{(}\PY{n}{diff} \PY{o}{\PYZlt{}} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{ddthreshold}\PY{p}{)}\PY{p}{,}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Expected constant d\PYZus{}dx less than }\PY{l+s+si}{\PYZpc{}f}\PY{l+s+s2}{ but got }\PY{l+s+si}{\PYZpc{}f}\PY{l+s+s2}{\PYZdq{}}\PY{o}{\PYZpc{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{ddthreshold}\PY{p}{,}\PY{n}{maxdiff}\PY{p}{)}\PY{p}{)}
             \PY{k}{def} \PY{n+nf}{tearDown}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{a}\PY{p}{)}
                 \PY{k}{del}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{ddthreshold}\PY{p}{)}
         
         \PY{n}{unittest}\PY{o}{.}\PY{n}{main}\PY{p}{(}\PY{n}{argv}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{first\PYZhy{}arg\PYZhy{}is\PYZhy{}ignored}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{exit}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
         \PY{c+c1}{\PYZsh{}You can pass further arguments in the argv list, e.g.}
         \PY{c+c1}{\PYZsh{}unittest.main(argv=[\PYZsq{}ignored\PYZsq{}, \PYZsq{}\PYZhy{}v\PYZsq{}], exit=False)      }
         \PY{c+c1}{\PYZsh{}unittest.main()}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
simulating{\ldots}
simulation complete

    \end{Verbatim}

    
    \begin{verbatim}
<IPython.core.display.Javascript object>
    \end{verbatim}

    
    
    \begin{verbatim}
<IPython.core.display.HTML object>
    \end{verbatim}

    
    
    \begin{verbatim}
<IPython.core.display.Javascript object>
    \end{verbatim}

    
    
    \begin{verbatim}
<IPython.core.display.HTML object>
    \end{verbatim}

    
    \begin{Verbatim}[commandchars=\\\{\}]
.
    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
279.0 313.2091952673165
-0.10922155474432915 0.15

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
.
----------------------------------------------------------------------
Ran 2 tests in 1.676s

OK

    \end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}30}]:} <unittest.main.TestProgram at 0x7f074e03f518>
\end{Verbatim}
            
    \hypertarget{small-scale-case-as-verification}{%
\subsubsection{small scale case as
verification}\label{small-scale-case-as-verification}}

running a small scale simulation of a initial disturbance like that from
a rock thrown in a pond to verify the model

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}31}]:} \PY{n}{oned2} \PY{o}{=} \PY{p}{\PYZob{}}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1000}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,} \PY{n}{sizey}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{c+c1}{\PYZsh{}(1\PYZhy{}2*lingauss((sizex, sizey), 20, 20))),}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{*}\PY{n}{lingauss}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,} \PY{n}{sizey}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{10}\PY{p}{,} \PY{l+m+mi}{500}\PY{p}{)}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{u}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{sizey}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{v}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,} \PY{n}{sizey}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{50}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{50}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.2}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,}\PY{p}{)}\PY{p}{)}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizey}\PY{p}{,}\PY{p}{)}\PY{p}{)}
         \PY{p}{\PYZcb{}}
         \PY{n}{oned2}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{100}\PY{p}{]} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{3}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{oned2}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{25}\PY{p}{]}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{oned2}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{25}\PY{p}{]}\PY{o}{*}\PY{l+m+mi}{100}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    
    \begin{verbatim}
<IPython.core.display.Javascript object>
    \end{verbatim}

    
    
    \begin{verbatim}
<IPython.core.display.HTML object>
    \end{verbatim}

    
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}32}]:} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{conedMax}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{colorbar}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{clf}\PY{p}{(}\PY{p}{)}
         \PY{n}{onedart} \PY{o}{=} \PY{p}{[}\PY{p}{(}\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{n}{vmin}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{mmax}\PY{p}{,} \PY{n}{vmax}\PY{o}{=}\PY{n}{mmax}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{seismic}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,}\PY{p}{)} \PY{k}{for} \PY{n}{frame} \PY{o+ow}{in} \PY{n}{conedframes}\PY{p}{]}
         
         \PY{n}{anim} \PY{o}{=} \PY{n}{animation}\PY{o}{.}\PY{n}{ArtistAnimation}\PY{p}{(}\PY{n}{fig}\PY{p}{,} \PY{n}{onedart}\PY{p}{,} \PY{n}{interval}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,} \PY{n}{blit}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{repeat\PYZus{}delay}\PY{o}{=}\PY{l+m+mi}{200}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{colorbar}\PY{p}{(}\PY{p}{)}
         \PY{c+c1}{\PYZsh{} coast = plt.contour(oned[\PYZsq{}h\PYZsq{}], levels=1, colors=[\PYZsq{}black\PYZsq{}])}
         \PY{c+c1}{\PYZsh{} anim.save(\PYZsq{}../results/simpleplop.mp4\PYZsq{})}
         \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    
    \begin{verbatim}
<IPython.core.display.Javascript object>
    \end{verbatim}

    
    
    \begin{verbatim}
<IPython.core.display.HTML object>
    \end{verbatim}

    
    \begin{Verbatim}[commandchars=\\\{\}]

        ---------------------------------------------------------------------------

        NameError                                 Traceback (most recent call last)

        <ipython-input-32-98fdc8ef9cea> in <module>
          1 plt.figure()
    ----> 2 plt.imshow(conedMax)
          3 plt.colorbar()
          4 plt.show()
          5 plt.figure()


        NameError: name 'conedMax' is not defined

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{tm} \PY{o}{=} \PY{n}{time}\PY{o}{.}\PY{n}{perf\PYZus{}counter}\PY{p}{(}\PY{p}{)}
        \PY{n}{onedframes2}\PY{p}{,} \PY{n}{onedMax2} \PY{o}{=} \PY{n}{simulate}\PY{p}{(}\PY{n}{oned}\PY{p}{,} \PY{l+m+mi}{550}\PY{p}{,} \PY{n}{timestep}\PY{o}{=}\PY{n}{fbfeedback}\PY{p}{,} \PY{n}{saveinterval}\PY{o}{=}\PY{l+m+mi}{20}\PY{p}{,}\PYZbs{}
                                       \PY{n}{dudt\PYZus{}x} \PY{o}{=} \PY{n}{dudt}\PY{p}{,} \PY{n}{dvdt\PYZus{}x} \PY{o}{=} \PY{n}{dvdt}\PY{p}{,} \PY{n}{dndt\PYZus{}x} \PY{o}{=} \PY{n}{dndt}\PY{p}{,} \PYZbs{}
                                       \PY{n}{bounds}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                       \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{time}\PY{o}{.}\PY{n}{perf\PYZus{}counter}\PY{p}{(}\PY{p}{)}\PY{o}{\PYZhy{}}\PY{n}{tm}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{onedframes2}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{sizex}\PY{p}{,} \PY{n}{sizey} \PY{o}{=} \PY{l+m+mi}{200}\PY{p}{,} \PY{l+m+mi}{200}
        \PY{n}{pondrock} \PY{o}{=} \PY{p}{\PYZob{}}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1000}\PY{o}{*}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{\PYZhy{}}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{lingauss}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,} \PY{n}{sizey}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{20}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{l+m+mi}{50}\PY{p}{,} \PY{n}{theta}\PY{o}{=}\PY{l+m+mi}{3}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{l+m+mi}{4}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{1}\PY{o}{*}\PY{n}{seismic}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,} \PY{n}{sizey}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{10}\PY{p}{,} \PY{l+m+mi}{10}\PY{p}{,} \PY{l+m+mi}{130}\PY{p}{,} \PY{l+m+mi}{70}\PY{p}{,} \PY{n}{theta}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{a1}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,} \PY{n}{a2}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)}\PY{p}{)}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{u}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{sizey}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{v}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,} \PY{n}{sizey}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{100}\PY{p}{)}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mi}{100}\PY{p}{)}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizex}\PY{p}{,}\PY{p}{)}\PY{p}{)}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{sizey}\PY{p}{,}\PY{p}{)}\PY{p}{)}
        \PY{p}{\PYZcb{}}
        
        \PY{c+c1}{\PYZsh{} simpleState = State(**simpletestcase)}
        \PY{c+c1}{\PYZsh{} print(simpleState.dx, simpleState.dy, simpleState.h+simpleState.n)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{pondframes}\PY{p}{,} \PY{n}{pondMax} \PY{o}{=} \PY{n}{simulate}\PY{p}{(}\PY{n}{pondrock}\PY{p}{,} \PY{l+m+mi}{320}\PY{p}{,} \PY{n}{timestep}\PY{o}{=}\PY{n}{fbfeedback}\PY{p}{,} \PY{n}{saveinterval}\PY{o}{=}\PY{l+m+mi}{2}\PY{p}{,}\PYZbs{}
                                                   \PY{n}{dudt\PYZus{}x} \PY{o}{=} \PY{n}{dudt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dvdt\PYZus{}x} \PY{o}{=} \PY{n}{dvdt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dndt\PYZus{}x} \PY{o}{=} \PY{n}{dndt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PYZbs{}
                                                   \PY{n}{bounds}\PY{o}{=}\PY{p}{[}\PY{l+m+mf}{0.97}\PY{p}{,} \PY{l+m+mf}{0.97}\PY{p}{,} \PY{l+m+mf}{0.97}\PY{p}{,} \PY{l+m+mf}{0.97}\PY{p}{]}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{l+m+mi}{25}\PY{p}{)}
        \PY{n}{mmax} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{pondframes}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{2}
        \PY{n}{coast} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{contour}\PY{p}{(}\PY{n}{pondrock}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{levels}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{colors}\PY{o}{=}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{black}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
        \PY{n}{pondart} \PY{o}{=} \PY{p}{[}\PY{p}{(}\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{n}{vmin}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{mmax}\PY{p}{,} \PY{n}{vmax}\PY{o}{=}\PY{n}{mmax}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{seismic}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,}\PY{p}{)} \PY{k}{for} \PY{n}{frame} \PY{o+ow}{in} \PY{n}{pondframes}\PY{p}{]}
        
        \PY{n}{anim} \PY{o}{=} \PY{n}{animation}\PY{o}{.}\PY{n}{ArtistAnimation}\PY{p}{(}\PY{n}{fig}\PY{p}{,} \PY{n}{pondart}\PY{p}{,} \PY{n}{interval}\PY{o}{=}\PY{l+m+mi}{100}\PY{p}{,} \PY{n}{blit}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{repeat\PYZus{}delay}\PY{o}{=}\PY{l+m+mi}{200}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{colorbar}\PY{p}{(}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} anim.save(\PYZsq{}../results/simpleplop.mp4\PYZsq{})}
        \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
        \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{l+m+mi}{27}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{pondMax}\PY{p}{)}
\end{Verbatim}


    \hypertarget{simulating-multiple-tsunamis-around-palu}{%
\section{Simulating multiple tsunamis around
Palu}\label{simulating-multiple-tsunamis-around-palu}}

    \hypertarget{setting-up-conditions-for-all-the-palu-simulations}{%
\subsubsection{setting up conditions for all the Palu
Simulations}\label{setting-up-conditions-for-all-the-palu-simulations}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{palu} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
        \PY{n}{latran} \PY{o}{=} \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mf}{1.2}\PY{p}{,} \PY{l+m+mf}{0.2}\PY{p}{)} \PY{c+c1}{\PYZsh{} latitude range map covers}
        \PY{n}{lonran} \PY{o}{=} \PY{p}{(}\PY{l+m+mf}{118.7}\PY{p}{,} \PY{l+m+mi}{121}\PY{p}{)} \PY{c+c1}{\PYZsh{} longitude range map covers}
        
        \PY{c+c1}{\PYZsh{} calculate height of map  11100*lat degrees = meters}
        \PY{c+c1}{\PYZsh{} calculate width of map  1 lon degree = cos(lat) lat degrees, *11100 = meters}
        \PY{c+c1}{\PYZsh{} use lon degree size of average latitude}
        \PY{n}{realsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{111000}\PY{o}{*}\PY{p}{(}\PY{n}{latran}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{latran}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{,}\PYZbs{}
                       \PY{l+m+mi}{111000}\PY{o}{*}\PY{p}{(}\PY{n}{lonran}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{lonran}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PYZbs{}
                          \PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{p}{(}\PY{n}{latran}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{latran}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{)}\PY{c+c1}{\PYZsh{} h, w of map in meters}
            
        \PY{n}{size} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{700}\PY{p}{,} \PY{l+m+mi}{1150}\PY{p}{)}\PY{c+c1}{\PYZsh{} grid size of the map lat, lon}
        
        
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{realsize}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{/}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{realsize}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{/}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx and dy }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} read in bathymetry data}
        \PY{n}{bathdata} \PY{o}{=} \PY{n}{nc}\PY{o}{.}\PY{n}{Dataset}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{../data/bathymetry.nc}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{r}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{bathlat} \PY{o}{=} \PY{n}{bathdata}\PY{o}{.}\PY{n}{variables}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        \PY{n}{bathlon} \PY{o}{=} \PY{n}{bathdata}\PY{o}{.}\PY{n}{variables}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        \PY{c+c1}{\PYZsh{}calculate indexes of bathymetry dataset we need}
        \PY{n}{bathlatix} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{argmin}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{bathlat}\PY{p}{[}\PY{p}{:}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{latran}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{np}\PY{o}{.}\PY{n}{argmin}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{bathlat}\PY{p}{[}\PY{p}{:}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{latran}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{size}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n+nb}{int}\PY{p}{)}
        \PY{n}{bathlonix} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{argmin}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{bathlon}\PY{p}{[}\PY{p}{:}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{lonran}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{np}\PY{o}{.}\PY{n}{argmin}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{bathlon}\PY{p}{[}\PY{p}{:}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{lonran}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                \PY{n}{size}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n+nb}{int}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} print(bathlatix, bathlonix)}
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{asarray}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{n}{bathdata}\PY{o}{.}\PY{n}{variables}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{elevation}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{n}{bathlatix}\PY{p}{,} \PY{n}{bathlonix}\PY{p}{]}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{asarray}\PY{p}{(}\PY{n}{bathlat}\PY{p}{[}\PY{n}{bathlatix}\PY{p}{]}\PY{p}{)}
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{asarray}\PY{p}{(}\PY{n}{bathlon}\PY{p}{[}\PY{n}{bathlonix}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{size}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{u}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{v}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{size}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PY{n}{dtype}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        
        \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.3}\PY{p}{)}\PY{o}{*}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{/}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{*}\PY{n}{p}\PY{o}{.}\PY{n}{g}\PY{p}{)}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} paluState = State(**palu)}
\end{Verbatim}


    \hypertarget{display-coastline-to-verify-correct-setup-of-palu}{%
\subsubsection{display coastline to verify correct setup of
Palu}\label{display-coastline-to-verify-correct-setup-of-palu}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{l+m+mi}{166}\PY{p}{)}
        \PY{n}{coast} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{contour}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{levels}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{colors}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{black}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{xtixks} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{5}\PY{p}{)}\PY{p}{,}\PYZbs{}
                   \PY{n}{np}\PY{o}{.}\PY{n}{round}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{5}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
        \PY{n}{yticks} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{5}\PY{p}{)}\PY{p}{,}\PYZbs{}
                   \PY{n}{np}\PY{o}{.}\PY{n}{round}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{5}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \hypertarget{create-array-of-multiple-initial-conditions-of-sea-surface-heights}{%
\subsubsection{create array of multiple initial conditions of sea
surface
heights}\label{create-array-of-multiple-initial-conditions-of-sea-surface-heights}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{dist} \PY{o}{=} \PY{l+m+mi}{33000} \PY{c+c1}{\PYZsh{} m from mouth of palu bay}
        \PY{n}{center} \PY{o}{=} \PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mf}{0.63}\PY{p}{,} \PY{l+m+mf}{119.75}\PY{p}{)} \PY{c+c1}{\PYZsh{} point events are equidistant from}
        \PY{n}{startang} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{l+m+mi}{4} \PY{c+c1}{\PYZsh{} angle of first event}
        \PY{n}{endang} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{+}\PY{l+m+mf}{0.01} \PY{c+c1}{\PYZsh{} angle of last event}
        \PY{n}{dang} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{l+m+mi}{16} \PY{c+c1}{\PYZsh{} change in angle}
        
        \PY{n}{argcenter} \PY{o}{=} \PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{argmin}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{center}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                     \PY{n}{np}\PY{o}{.}\PY{n}{argmin}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{center}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} the index of the center point}
        \PY{n}{argdist} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{dist}\PY{o}{/}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
        
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{argdist}\PY{p}{,} \PY{n}{argcenter}\PY{p}{)}
        
        
        \PY{n}{seiswidth} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{l+m+mi}{5000}\PY{o}{/}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dx}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
        \PY{n}{seislength} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{l+m+mi}{10000}\PY{o}{/}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dy}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
        
            
        
        \PY{n}{initns} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{n}{seismic}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{,} \PYZbs{}
                                      \PY{n}{width} \PY{o}{=} \PY{n}{seiswidth}\PY{p}{,} \PYZbs{}
                                      \PY{n}{length} \PY{o}{=} \PY{n}{seislength}\PY{p}{,} \PYZbs{}
                                      \PY{n}{a1} \PY{o}{=} \PY{l+m+mi}{4}\PY{p}{,} \PY{n}{a2} \PY{o}{=} \PY{l+m+mi}{1}\PY{p}{,} \PYZbs{}
                                      \PY{n}{cx} \PY{o}{=} \PY{n}{argcenter}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{ang}\PY{p}{)}\PY{o}{*}\PY{n}{argdist}\PY{p}{,} \PYZbs{}
                                      \PY{n}{cy} \PY{o}{=} \PY{n}{argcenter}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{ang}\PY{p}{)}\PY{o}{*}\PY{n}{argdist}\PY{p}{,} \PYZbs{}
                                      \PY{n}{theta} \PY{o}{=} \PY{n}{ang}\PY{o}{+}\PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{p}{)} \PYZbs{}
                              \PY{k}{for} \PY{n}{ang} \PY{o+ow}{in} \PY{n}{np}\PY{o}{.}\PY{n}{arange}\PY{p}{(}\PY{n}{startang}\PY{p}{,} \PY{n}{endang}\PY{p}{,} \PY{n}{dang}\PY{p}{)}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} array of the lat, lon positions of each event}
\end{Verbatim}


    \hypertarget{display-the-initial-conditions}{%
\subsubsection{display the initial
conditions}\label{display-the-initial-conditions}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{spnum} \PY{o}{=} \PY{l+m+mi}{1}
        \PY{n}{spcount} \PY{o}{=} \PY{n}{initns}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
        \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{l+m+mi}{176}\PY{p}{)}
        \PY{n}{mmax} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{initns}\PY{p}{)}\PY{p}{)}
        \PY{k}{for} \PY{n}{initn} \PY{o+ow}{in} \PY{n}{initns}\PY{p}{:}
            \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{n+nb}{int}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{spcount}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{spcount}\PY{o}{/}\PY{n+nb}{int}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{spcount}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{spnum}\PY{p}{)}
            
            \PY{c+c1}{\PYZsh{} sea surface height}
            \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{initn}\PY{p}{[}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{seismic}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{vmax}\PY{o}{=}\PY{n}{mmax}\PY{p}{,} \PY{n}{vmin}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{mmax}\PY{p}{)}
            
            \PY{c+c1}{\PYZsh{} coast}
            \PY{n}{coast} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{contour}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{levels}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{colors}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{black}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}     xtixks = plt.xticks(np.linspace(0, palu[\PYZsq{}h\PYZsq{}].shape[1], 5),\PYZbs{}}
        \PY{c+c1}{\PYZsh{}                np.round(np.linspace(palu[\PYZsq{}lon\PYZsq{}][0], palu[\PYZsq{}lon\PYZsq{}][\PYZhy{}1], 5), 3))}
        \PY{c+c1}{\PYZsh{}     yticks = plt.yticks(np.linspace(0, palu[\PYZsq{}h\PYZsq{}].shape[0], 5),\PYZbs{}}
        \PY{c+c1}{\PYZsh{}                np.round(np.linspace(palu[\PYZsq{}lat\PYZsq{}][0], palu[\PYZsq{}lat\PYZsq{}][\PYZhy{}1], 5), 3))}
            \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{p}{]}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{p}{]}\PY{p}{)}
            
            \PY{n}{spnum} \PY{o}{+}\PY{o}{=} \PY{l+m+mi}{1}
        \PY{n}{plt}\PY{o}{.}\PY{n}{tight\PYZus{}layout}\PY{p}{(}\PY{p}{)}
\end{Verbatim}


    \hypertarget{simulate-each-event-and-save-the-maximum-heights-from-each-one}{%
\subsection{simulate each event and save the maximum heights from each
one}\label{simulate-each-event-and-save-the-maximum-heights-from-each-one}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{c+c1}{\PYZsh{} paluState = State(**palu)}
        
        \PY{n}{eventcount} \PY{o}{=} \PY{n}{initns}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
        
        \PY{n}{maxes} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{n}{eventcount}\PY{p}{,}\PY{p}{)} \PY{o}{+} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{)}\PY{c+c1}{\PYZsh{}np.array([])}
        \PY{c+c1}{\PYZsh{} mins = np.zeros((eventcount,) + palu[\PYZsq{}n\PYZsq{}]shape)\PYZsh{}np.array([])}
        \PY{c+c1}{\PYZsh{} nttmm = np.array([])}
        
        \PY{n}{evnum} \PY{o}{=} \PY{l+m+mi}{0} \PY{c+c1}{\PYZsh{} keep track of which event number were on}
        
        \PY{k}{for} \PY{n}{initn} \PY{o+ow}{in} \PY{n}{initns}\PY{p}{:}
            \PY{n}{initd} \PY{o}{=} \PY{n+nb}{dict}\PY{p}{(}\PY{n}{palu}\PY{p}{)} \PY{c+c1}{\PYZsh{} create copy of Palu init conditons}
            \PY{n}{initd}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{n}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{initn} \PY{c+c1}{\PYZsh{} with the initial SSH of this specific event}
        \PY{c+c1}{\PYZsh{}     initstate = State(**initd) \PYZsh{} turn into instance of State class}
            
            \PY{n}{maxn} \PY{o}{=} \PY{n}{simulate}\PY{p}{(}\PY{n}{initd}\PY{p}{,} \PY{l+m+mi}{2500}\PY{p}{,} \PY{n}{timestep}\PY{o}{=}\PY{n}{genfb}\PY{p}{,} \PYZbs{}
                            \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt}\PY{p}{,} \PYZbs{}
                            \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{c+c1}{\PYZsh{} simulate it}
            
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{finished event }\PY{l+s+s1}{\PYZsq{}} \PY{o}{+} \PY{n+nb}{str}\PY{p}{(}\PY{n}{evnum}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} show progress}
            
            \PY{n}{maxes}\PY{p}{[}\PY{n}{evnum}\PY{p}{]} \PY{o}{=} \PY{n}{maxn} \PY{c+c1}{\PYZsh{} record data for this event}
        \PY{c+c1}{\PYZsh{}     mins[evnum] = minn}
        \PY{c+c1}{\PYZsh{}     maxes[evnum] = maxn}
            
            \PY{n}{evnum} \PY{o}{+}\PY{o}{=} \PY{l+m+mi}{1}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{all done}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} save results}
        \PY{n}{np}\PY{o}{.}\PY{n}{save}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{../results/palumaxheights}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{maxes}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{c+c1}{\PYZsh{} or load previous results}
        \PY{c+c1}{\PYZsh{} maxes = np.load(\PYZsq{}../results/palumaxheights.npy\PYZsq{})}
\end{Verbatim}


    \hypertarget{display-outcomes-of-each-event}{%
\subsubsection{display outcomes of each
event}\label{display-outcomes-of-each-event}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{stfignum} \PY{o}{=} \PY{l+m+mi}{117} \PY{c+c1}{\PYZsh{} the neighborhood of figure numbers in use}
        
        \PY{c+c1}{\PYZsh{} fignum = 0 \PYZsh{} specific figure}
        
        \PY{c+c1}{\PYZsh{}window including just palu bay}
        \PY{n}{pb1} \PY{o}{=} \PY{l+m+mi}{150}
        \PY{n}{pb2} \PY{o}{=} \PY{l+m+mi}{280}
        \PY{n}{pb3} \PY{o}{=} \PY{l+m+mi}{520}
        \PY{n}{pb4} \PY{o}{=} \PY{l+m+mi}{600}
        
        \PY{n}{mmax} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{maxes}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{pb1}\PY{p}{:}\PY{n}{pb2}\PY{p}{,}\PY{n}{pb3}\PY{p}{:}\PY{n}{pb4}\PY{p}{]}\PY{p}{)} \PY{c+c1}{\PYZsh{} true max of maxes}
        \PY{n}{imax} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{initns}\PY{p}{)} \PY{c+c1}{\PYZsh{} true max of initial SSH\PYZsq{}s}
        
        \PY{k}{for} \PY{n}{fignum}\PY{p}{,} \PY{n}{initn} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{initns}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} display initial SSH of each event}
            \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{stfignum}\PY{o}{+}\PY{n}{fignum}\PY{p}{)} \PY{c+c1}{\PYZsh{} start new figures}
            
        \PY{c+c1}{\PYZsh{}     plt.subplot(1, 2, 1)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{initn}\PY{p}{[}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{seismic}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{vmax} \PY{o}{=} \PY{n}{imax}\PY{p}{,} \PY{n}{vmin}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{imax}\PY{p}{)}\PY{c+c1}{\PYZsh{} plot initial condition}
            \PY{n}{plt}\PY{o}{.}\PY{n}{colorbar}\PY{p}{(}\PY{p}{)}
            \PY{n}{coast} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{contour}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mf}{1.5}\PY{p}{,} \PY{n}{levels}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{colors}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{black}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} plot coast}
            
            \PY{c+c1}{\PYZsh{} use latitude, longitude tick markers}
            \PY{n}{xtixks} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{5}\PY{p}{)}\PY{p}{,}\PYZbs{}
                       \PY{n}{np}\PY{o}{.}\PY{n}{round}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lon}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{5}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{n}{yticks} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{5}\PY{p}{)}\PY{p}{,}\PYZbs{}
                       \PY{n}{np}\PY{o}{.}\PY{n}{round}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linspace}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{lat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{5}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{c+c1}{\PYZsh{} use no tickmarks}
        \PY{c+c1}{\PYZsh{}     plt.xticks([], [])}
        \PY{c+c1}{\PYZsh{}     plt.yticks([], [])}
            
            \PY{n}{plt}\PY{o}{.}\PY{n}{savefig}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{../results/palu\PYZhy{}init\PYZhy{}}\PY{l+s+s1}{\PYZsq{}} \PY{o}{+} \PY{n+nb}{str}\PY{p}{(}\PY{n}{fignum}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} download image}
            
        \PY{c+c1}{\PYZsh{}     fignum+=1 \PYZsh{} next figure}
         \PY{c+c1}{\PYZsh{} repeat of last with colorbar}
        \PY{c+c1}{\PYZsh{} plt.figure(stfignum+13)}
        \PY{c+c1}{\PYZsh{} plt.imshow(initns[\PYZhy{}1], cmap=\PYZsq{}seismic\PYZsq{}, vmax=imax, vmin=\PYZhy{}imax)}
        \PY{c+c1}{\PYZsh{} plt.colorbar()}
        \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}../results/palu\PYZhy{}init\PYZhy{}cb\PYZsq{})}
        \PY{c+c1}{\PYZsh{} fignum+=1}
        \PY{k}{for} \PY{n}{fignum}\PY{p}{,} \PY{n}{maxn} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{maxes}\PY{p}{)}\PY{p}{:} \PY{c+c1}{\PYZsh{} display maximum heights in palu bay of each event}
            \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{stfignum}\PY{o}{+}\PY{n}{fignum}\PY{o}{+}\PY{l+m+mi}{14}\PY{p}{)} \PY{c+c1}{\PYZsh{} start new figure}
            
        \PY{c+c1}{\PYZsh{}     plt.subplot(1, 2, 2)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{maxn}\PY{p}{[}\PY{n}{pb2}\PY{p}{:}\PY{n}{pb1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{pb3}\PY{p}{:}\PY{n}{pb4}\PY{p}{]}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{nipy\PYZus{}spectral}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{vmax}\PY{o}{=}\PY{n}{mmax}\PY{p}{,} \PY{n}{vmin}\PY{o}{=}\PY{l+m+mi}{0}\PY{p}{)} \PY{c+c1}{\PYZsh{} show max height image}
            \PY{n}{plt}\PY{o}{.}\PY{n}{colorbar}\PY{p}{(}\PY{p}{)}
            \PY{n}{coast} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{contour}\PY{p}{(}\PY{n}{palu}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{h}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{n}{pb2}\PY{p}{:}\PY{n}{pb1}\PY{p}{:}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{pb3}\PY{p}{:}\PY{n}{pb4}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mf}{1.5}\PY{p}{,} \PY{n}{levels}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{,} \PY{n}{colors}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{black}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{c+c1}{\PYZsh{} the coast}
            
            \PY{c+c1}{\PYZsh{} use latitude, longitude tickmarks}
        \PY{c+c1}{\PYZsh{}     xtixks = plt.xticks(np.linspace(0, palu[\PYZsq{}h\PYZsq{}].shape[1], 5),\PYZbs{}}
        \PY{c+c1}{\PYZsh{}                np.round(np.linspace(palu[\PYZsq{}lon\PYZsq{}][0], palu[\PYZsq{}lon\PYZsq{}][\PYZhy{}1], 5), 3))}
        \PY{c+c1}{\PYZsh{}     yticks = plt.yticks(np.linspace(0, palu[\PYZsq{}h\PYZsq{}].shape[0], 5),\PYZbs{}}
        \PY{c+c1}{\PYZsh{}                np.round(np.linspace(palu[\PYZsq{}lat\PYZsq{}][0], palu[\PYZsq{}lat\PYZsq{}][\PYZhy{}1], 5), 3))}
            \PY{c+c1}{\PYZsh{} use no tickmarks}
            \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{p}{]}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{p}{]}\PY{p}{)}
            
            \PY{n}{plt}\PY{o}{.}\PY{n}{savefig}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{../results/palu\PYZhy{}max\PYZhy{}}\PY{l+s+s1}{\PYZsq{}} \PY{o}{+} \PY{n+nb}{str}\PY{p}{(}\PY{n}{fignum}\PY{p}{)}\PY{p}{)} \PY{c+c1}{\PYZsh{} download image}
            
        \PY{c+c1}{\PYZsh{}     fignum += 1 \PYZsh{} next figure}
        \PY{c+c1}{\PYZsh{} repeat of last event, but with colorbar}
        \PY{c+c1}{\PYZsh{} plt.figure(stfignum+27)}
        \PY{c+c1}{\PYZsh{} plt.imshow(maxes[\PYZhy{}1][pb2:pb1:\PYZhy{}1, pb3:pb4], cmap=\PYZsq{}nipy\PYZus{}spectral\PYZsq{}, vmax=mmax, vmin=0)}
        \PY{c+c1}{\PYZsh{} plt.colorbar()}
        \PY{c+c1}{\PYZsh{} plt.savefig(\PYZsq{}../results/palu\PYZhy{}max\PYZhy{}cb\PYZsq{})plt.colorbar()}
\end{Verbatim}


    \hypertarget{timing-code-to-compare-gpu-and-cpu-codes.}{%
\subsection{Timing code to compare GPU and CPU
codes.}\label{timing-code-to-compare-gpu-and-cpu-codes.}}

\hypertarget{uses-1-d-models}{%
\subsubsection{uses 1-D models}\label{uses-1-d-models}}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{k+kn}{import} \PY{n+nn}{time}
        \PY{n}{tm} \PY{o}{=} \PY{n}{time}\PY{o}{.}\PY{n}{perf\PYZus{}counter}\PY{p}{(}\PY{p}{)}
        
        \PY{n}{onedframes}\PY{p}{,} \PY{n}{onedMax} \PY{o}{=} \PY{n}{simulate}\PY{p}{(}\PY{n}{oned}\PY{p}{,} \PY{l+m+mi}{550}\PY{p}{,} \PY{n}{timestep}\PY{o}{=}\PY{n}{genfb}\PY{p}{,} \PY{n}{saveinterval}\PY{o}{=}\PY{l+m+mi}{15}\PY{p}{,}\PYZbs{}
                                       \PY{n}{dudt\PYZus{}x} \PY{o}{=} \PY{n}{dudt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dvdt\PYZus{}x} \PY{o}{=} \PY{n}{dvdt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dndt\PYZus{}x} \PY{o}{=} \PY{n}{dndt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PYZbs{}
                                       \PY{n}{bounds}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                       \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{time}\PY{o}{.}\PY{n}{perf\PYZus{}counter}\PY{p}{(}\PY{p}{)}\PY{o}{\PYZhy{}}\PY{n}{tm}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{onedframes}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{n}{tm} \PY{o}{=} \PY{n}{time}\PY{o}{.}\PY{n}{perf\PYZus{}counter}\PY{p}{(}\PY{p}{)}
        \PY{n}{conedframes}\PY{p}{,} \PY{n}{conedMax} \PY{o}{=} \PY{n}{simulate\PYZus{}cuda}\PY{p}{(}\PY{n}{oned}\PY{p}{,} \PY{l+m+mi}{550}\PY{p}{,} \PY{n}{timestep}\PY{o}{=}\PY{n}{genfb\PYZus{}py}\PY{p}{,} \PY{n}{saveinterval}\PY{o}{=}\PY{l+m+mi}{15}\PY{p}{,}\PYZbs{}
                                       \PY{n}{dudt\PYZus{}x} \PY{o}{=} \PY{n}{dudt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dvdt\PYZus{}x} \PY{o}{=} \PY{n}{dvdt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dndt\PYZus{}x} \PY{o}{=} \PY{n}{dndt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PYZbs{}
                                       \PY{n}{bounds}\PY{o}{=}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PYZbs{}
                                       \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{)}\PY{p}{[}\PY{p}{:}\PY{l+m+mi}{2}\PY{p}{]}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{time}\PY{o}{.}\PY{n}{perf\PYZus{}counter}\PY{p}{(}\PY{p}{)}\PY{o}{\PYZhy{}}\PY{n}{tm}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{conedframes}\PY{o}{.}\PY{n}{shape}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{c+c1}{\PYZsh{} unit text compare numba and cuda}
        \PY{n}{fnum} \PY{o}{=} \PY{l+m+mi}{3000}
        \PY{n}{mmax} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{onedframes}\PY{p}{)}\PY{p}{)}\PY{o}{/}\PY{l+m+mi}{2}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{mmax}\PY{p}{)}
        \PY{n}{nplt}\PY{o}{=}\PY{l+m+mi}{10}
        \PY{n}{anims} \PY{o}{=} \PY{p}{[}\PY{p}{]}
        \PY{k}{for} \PY{n}{thing}\PY{p}{,}\PY{n}{name} \PY{o+ow}{in} \PY{n+nb}{zip}\PY{p}{(}\PY{p}{(}\PY{n}{onedframes}\PY{p}{,}  \PY{n}{conedframes} \PY{p}{)}\PY{p}{,}
                              \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{onedframes,  conedframes}\PY{l+s+s2}{\PYZdq{}}\PY{o}{.}\PY{n}{split}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{, }\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}\PY{p}{:}
            \PY{n}{mid} \PY{o}{=} \PY{n}{thing}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{/}\PY{o}{/}\PY{l+m+mi}{2}
            \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{shape}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{thing}\PY{o}{.}\PY{n}{shape}\PY{p}{,}\PY{n}{mid}\PY{p}{)}
            \PY{n}{fnum} \PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
            \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{fnum} \PY{p}{,}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{5}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{clf}\PY{p}{(}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{cla}\PY{p}{(}\PY{p}{)}
            \PY{c+c1}{\PYZsh{}plt.title(name) }
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{nplt}\PY{p}{)}\PY{p}{:}
                \PY{n}{f} \PY{o}{=} \PY{n}{i}\PY{o}{*}\PY{l+m+mi}{1}
                \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{nplt}\PY{p}{,}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
                \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{thing}\PY{p}{[}\PY{n}{f}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{p}{)}
                \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{p}{]}\PY{p}{)}
                \PY{n}{plt}\PY{o}{.}\PY{n}{yticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{p}{]}\PY{p}{)}
            \PY{c+c1}{\PYZsh{}plt.tight\PYZus{}layout()   }
            \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{name}\PY{p}{,}\PY{n}{fnum}\PY{p}{)}
        
            \PY{n}{fnum} \PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
            \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{fnum}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{clf}\PY{p}{(}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{n}{name}\PY{p}{)}
            \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{nplt}\PY{p}{)}\PY{p}{:}
                \PY{n}{f} \PY{o}{=} \PY{n}{i}\PY{o}{*}\PY{l+m+mi}{1}
                \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{n}{nplt}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{i}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
                \PY{n}{plt}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{thing}\PY{p}{[}\PY{n}{f}\PY{p}{,}\PY{p}{:}\PY{p}{,}\PY{n}{mid}\PY{p}{]}\PY{p}{)}
                \PY{n}{plt}\PY{o}{.}\PY{n}{xticks}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{p}{]}\PY{p}{)}
                \PY{c+c1}{\PYZsh{}plt.yticks([],[])}
            \PY{c+c1}{\PYZsh{}plt.tight\PYZus{}layout()}
             
            \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{name}\PY{p}{,}\PY{n}{fnum}\PY{p}{)}
            \PY{n}{fnum} \PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
            \PY{n}{fig} \PY{o}{=} \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{fnum}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{clf}\PY{p}{(}\PY{p}{)}
            \PY{n}{onedart} \PY{o}{=} \PY{p}{[}\PY{p}{(}\PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{frame}\PY{p}{,} \PY{n}{vmin}\PY{o}{=}\PY{o}{\PYZhy{}}\PY{n}{mmax}\PY{p}{,} \PY{n}{vmax}\PY{o}{=}\PY{n}{mmax}\PY{p}{,} \PY{n}{cmap}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{seismic}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,}\PY{p}{)}\PYZbs{}
                       \PY{k}{for} \PY{n}{frame} \PY{o+ow}{in} \PY{n}{thing}\PY{p}{]}
        
            \PY{n}{anims}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{animation}\PY{o}{.}\PY{n}{ArtistAnimation}\PY{p}{(}\PY{n}{fig}\PY{p}{,} \PY{n}{onedart}\PY{p}{,} \PY{n}{interval}\PY{o}{=}\PY{l+m+mi}{200}\PY{p}{,} \PYZbs{}
                                             \PY{n}{blit}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{repeat\PYZus{}delay}\PY{o}{=}\PY{l+m+mi}{1000}\PY{p}{)}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{colorbar}\PY{p}{(}\PY{p}{)}
            \PY{c+c1}{\PYZsh{} coast = plt.contour(oned[\PYZsq{}h\PYZsq{}], levels=1, colors=[\PYZsq{}black\PYZsq{}])}
            \PY{c+c1}{\PYZsh{} anim.save(\PYZsq{}../results/simpleplop.mp4\PYZsq{})}
            \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{n}{name}\PY{p}{,}\PY{n}{fnum}\PY{p}{)}
\end{Verbatim}


    \hypertarget{additional-test-code}{%
\subsubsection{Additional test code}\label{additional-test-code}}

\hypertarget{verifies-close-numerical-identity-of-numba-and-cuda-codes}{%
\paragraph{Verifies close numerical identity of Numba and Cuda
codes}\label{verifies-close-numerical-identity-of-numba-and-cuda-codes}}

The following is useful fragments of code needed during debugging and
isnt documents since it's a workspace for testing things in development
not part of the simulation

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor} }]:} \PY{c+c1}{\PYZsh{}unit test verifying numba nd cuda genfb equivalence}
        \PY{n}{N}\PY{o}{=}\PY{l+m+mi}{7}
        \PY{n}{M}\PY{o}{=}\PY{l+m+mi}{7}
        \PY{n}{beta}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.281105}\PY{p}{)}
        \PY{n}{eps}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.013}\PY{p}{)}
        \PY{n}{gamma}\PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{0.0880}\PY{p}{)}
        
        \PY{n}{h} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n}{N}\PY{p}{,}\PY{n}{M}\PY{p}{)}\PY{p}{,}\PY{n}{dtype} \PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        \PY{n}{h}\PY{o}{*}\PY{o}{=}\PY{l+m+mi}{10}
        \PY{n}{sped} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{l+m+mi}{10}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{mean}\PY{p}{(}\PY{n}{h}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{speed}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{sped}\PY{p}{)}
        \PY{n}{n} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{random}\PY{p}{(}\PY{p}{(}\PY{n}{N}\PY{p}{,}\PY{n}{M}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{n}{dtype} \PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        \PY{n}{n}\PY{p}{[}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{/}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.1}
        \PY{n}{n}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{/}\PY{o}{/}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.1}
        \PY{n}{n}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{n}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{n}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{n}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        
        
        \PY{n}{f} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n}{N}\PY{p}{,}\PY{n}{M}\PY{p}{)}\PY{p}{,}\PY{n}{dtype} \PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        \PY{n}{f}\PY{o}{*}\PY{o}{=}\PY{l+m+mi}{0} \PY{c+c1}{\PYZsh{}0.001}
        \PY{n}{u} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{random}\PY{p}{(}\PY{p}{(}\PY{n}{N}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{M}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{n}{dtype} \PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        \PY{n}{u}\PY{o}{*}\PY{o}{=}\PY{n}{sped}\PY{o}{/}\PY{l+m+mi}{10}
        \PY{n}{u}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{u}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{u}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{u}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{v} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{random}\PY{p}{(}\PY{p}{(}\PY{n}{N}\PY{p}{,}\PY{n}{M}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PY{n}{dtype} \PY{o}{=}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{)}
        \PY{n}{v}\PY{o}{*}\PY{o}{=}\PY{n}{sped}\PY{o}{/}\PY{l+m+mi}{10}
        \PY{n}{v}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{v}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n}{v}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
         
        \PY{n}{norig} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{n}\PY{p}{)}
        \PY{n}{uorig} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{u}\PY{p}{)}
        \PY{n}{vorig} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{v}\PY{p}{)}
            
        \PY{n}{ch}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{h}\PY{p}{)}
        \PY{n}{cn}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{n}\PY{p}{)}
        \PY{n}{cu}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{u}\PY{p}{)}
        \PY{n}{cv}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{v}\PY{p}{)}
        \PY{n}{cf}     \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{f}\PY{p}{)}
        
        \PY{n}{cnorig} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{n}\PY{p}{)}
        \PY{n}{cvorig} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{v}\PY{p}{)}
        \PY{n}{cuorig} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{to\PYZus{}device}\PY{p}{(}\PY{n}{u}\PY{p}{)}
        
        \PY{n}{threadblock}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{16}\PY{p}{,}\PY{l+m+mi}{16}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} gridu = ( (u.shape[0]+threadblock[0]\PYZhy{}1)//threadblock[0],}
        \PY{c+c1}{\PYZsh{}           (u.shape[1]+threadblock[1]\PYZhy{}1)//threadblock[1])}
        \PY{c+c1}{\PYZsh{} gridv = ( (v.shape[0]+threadblock[0]\PYZhy{}1)//threadblock[0],}
        \PY{c+c1}{\PYZsh{}           (v.shape[1]+threadblock[1]\PYZhy{}1)//threadblock[1])}
        \PY{c+c1}{\PYZsh{} gridn = ( (n.shape[0]+threadblock[0]\PYZhy{}1)//threadblock[0],}
        \PY{c+c1}{\PYZsh{}           (n.shape[1]+threadblock[1]\PYZhy{}1)//threadblock[1])}
        \PY{c+c1}{\PYZsh{} other order.}
        \PY{n}{gridu} \PY{o}{=} \PY{p}{(} \PY{p}{(}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}
                  \PY{p}{(}\PY{n}{u}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{gridv} \PY{o}{=} \PY{p}{(} \PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}
                  \PY{p}{(}\PY{n}{v}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
        
        \PY{n}{gridn} \PY{o}{=} \PY{p}{(} \PY{p}{(}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,}
                  \PY{p}{(}\PY{n}{n}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{/}\PY{o}{/}\PY{n}{threadblock}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
        
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{grids}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{gridu}\PY{p}{,}\PY{n}{gridv}\PY{p}{,}\PY{n}{gridn}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}h, n, f, u, v, dx, dy, out, grav=True, cori=True, advx=True, advy=True, attn=True, nu=0, mu=0}
        \PY{n}{dx} \PY{o}{=} \PY{n}{dy} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{l+m+mf}{50.0}\PY{p}{)}
        \PY{n}{dt} \PY{o}{=} \PY{n}{dx}\PY{o}{/}\PY{n}{sped}\PY{o}{/}\PY{l+m+mi}{4}
        
        
        \PY{n}{dudt\PYZus{}x} \PY{o}{=} \PY{n}{dudt\PYZus{}drive\PYZus{}cuda}\PY{c+c1}{\PYZsh{}[gridu,threadblock]  \PYZsh{} these override the inputs}
        \PY{n}{dvdt\PYZus{}x} \PY{o}{=} \PY{n}{dvdt\PYZus{}drive\PYZus{}cuda}\PY{c+c1}{\PYZsh{}[gridv,threadblock]}
        \PY{n}{dndt\PYZus{}x} \PY{o}{=} \PY{n}{dndt\PYZus{}drive\PYZus{}cuda}\PY{c+c1}{\PYZsh{}[gridn,threadblock]}
        
        \PY{c+c1}{\PYZsh{}create  du,dv,dn on device}
        \PY{n}{cdu0} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{u}\PY{p}{)}
        \PY{n}{cdu0}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}\PY{o}{=}\PY{l+m+mf}{0.0}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{cdu0}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}du0[:]=0.0}
        \PY{n}{cdv0} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{v}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}dv0[:]=0.0}
        \PY{n}{cdn0} \PY{o}{=}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{n}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}dn0[:]=0.0}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{dvdt\PYZhy{}cuda attrs }\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{.}\PY{n}{\PYZus{}func}\PY{o}{.}\PY{n}{get}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{attrs}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} load in the intial values}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{initializing}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}
        \PY{n}{cori}\PY{o}{=}\PY{n}{advx}\PY{o}{=}\PY{n}{advy}\PY{o}{=}\PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}
        \PY{n}{nu}\PY{o}{=}\PY{n}{mu}\PY{o}{=}\PY{l+m+mf}{0.3}
        
        
        \PY{c+c1}{\PYZsh{} note cant use transpose for output!}
        
        
        \PY{n}{dndt\PYZus{}x}\PY{p}{[}\PY{n}{gridn}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{ch}\PY{p}{,} \PY{n}{cn}\PY{p}{,}     \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{cdn0}\PY{p}{)}
        \PY{c+c1}{\PYZsh{} propagate n before dudt}
        \PY{n}{lincomb4\PYZus{}cuda}\PY{p}{[}\PY{n}{gridn}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{cn}\PY{p}{,} \PY{n}{cdn0}\PY{p}{,} \PY{n}{cdn0}\PY{p}{,} \PY{n}{cdn0}\PY{p}{,}\PYZbs{}
                        \PY{n}{one}\PY{p}{,} \PY{p}{(}\PY{n}{p32}\PY{o}{+}\PY{n}{beta}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{beta}\PY{o}{+}\PY{n}{beta}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{p}{(}\PY{n}{beta}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{n}{cn}\PY{p}{)}
        
        \PY{n}{dvdt\PYZus{}x}\PY{p}{[}\PY{n}{gridv}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{ch}\PY{p}{,} \PY{n}{cn}\PY{p}{,} \PY{n}{cf}\PY{p}{,} \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{cdv0}\PY{p}{,}\PYZbs{}
                                  \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
        
        \PY{n}{dudt\PYZus{}x}\PY{p}{[}\PY{n}{gridu}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{ch}\PY{p}{,} \PY{n}{cn}\PY{p}{,} \PY{n}{cf}\PY{p}{,} \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{cdu0}\PY{p}{,}\PYZbs{}
                                  \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
        
        
        
        
        \PY{c+c1}{\PYZsh{} create the tuples }
        \PY{n}{cdu} \PY{o}{=} \PY{p}{(}\PY{n}{cdu0}\PY{p}{,} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{cdu0}\PY{p}{)}\PY{p}{,} \PYZbs{}
               \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{cdu0}\PY{p}{)}\PY{p}{,} \PYZbs{}
               \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{cdu0}\PY{p}{)} \PY{p}{)}
        
        \PY{n}{cdv} \PY{o}{=} \PY{p}{(}\PY{n}{cdv0}\PY{p}{,}  \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{cdv0}\PY{p}{)}\PY{p}{,}\PYZbs{}
               \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{cdv0}\PY{p}{)}\PY{p}{,} \PYZbs{}
               \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{cdv0}\PY{p}{)}\PY{p}{)}
        
        \PY{n}{cdn} \PY{o}{=} \PY{p}{(}\PY{n}{cdn0}\PY{p}{,} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{cdn0}\PY{p}{)}\PY{p}{,}\PYZbs{}
               \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{cdn0}\PY{p}{)}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} initialize the tuples on the device}
        \PY{k}{for} \PY{n}{d} \PY{o+ow}{in} \PY{n}{cdn}\PY{p}{:}
            \PY{n}{d}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=}  \PY{n}{cdn}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}
        
        \PY{k}{for} \PY{n}{d} \PY{o+ow}{in} \PY{n}{cdv}\PY{p}{:}
            \PY{n}{d}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}
        
        \PY{k}{for} \PY{n}{d} \PY{o+ow}{in} \PY{n}{cdu}\PY{p}{:}
            \PY{n}{d}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{cdu}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{p}{,}\PY{p}{:}\PY{p}{]}
        
        \PY{n}{du0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{u}\PY{p}{)}
        \PY{n}{dv0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{v}\PY{p}{)}
        \PY{n}{dn0} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{n}\PY{p}{)}
        
           
        \PY{n}{dndt\PYZus{}drive\PYZus{}numba}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dn0}\PY{p}{)}  
        \PY{n}{dn} \PY{o}{=} \PY{p}{(}\PY{n}{dn0}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dn0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dn0}\PY{p}{)}\PY{p}{)}
        
        
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{dndt + lincom  check}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n}{n} \PY{o}{=} \PY{n}{n} \PY{o}{+} \PY{p}{(}\PY{p}{(}\PY{n}{p32}\PY{o}{+}\PY{n}{beta}\PY{p}{)}\PY{o}{*} \PY{n}{dn}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}} \PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{beta}\PY{o}{+}\PY{n}{beta}\PY{p}{)}\PY{o}{*} \PY{n}{dn}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{+} \PY{p}{(}\PY{n}{beta}\PY{p}{)}\PY{o}{*} \PY{n}{dn}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{dt}
        
        
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{ lincom  cuda \PYZhy{} numba err}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{cn}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{o}{\PYZhy{}}\PY{n}{n}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        
               
               
        \PY{n}{dudt\PYZus{}drive\PYZus{}numba}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{du0}\PY{p}{,} \PYZbs{}
                         \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
        \PY{n}{du} \PY{o}{=} \PY{p}{(}\PY{n}{du0}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{du0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{du0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{du0}\PY{p}{)}\PY{p}{)}
        
        \PY{n}{dvdt\PYZus{}drive\PYZus{}numba}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dv0}\PY{p}{,}\PYZbs{}
                                  \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
        \PY{n}{dv} \PY{o}{=} \PY{p}{(}\PY{n}{dv0}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}\PY{p}{)}
        
        
        
        \PY{c+c1}{\PYZsh{} verify that transpose of U is V of transpose}
        \PY{n}{temp} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{u}\PY{p}{)}
        \PY{n}{dudt\PYZus{}x}\PY{p}{[}\PY{n}{gridu}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{ch}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{cn}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{f}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{cv}\PY{o}{.}\PY{n}{T}\PY{p}{,}  \PY{n}{cu}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{temp}\PY{p}{,}\PYZbs{}
                                  \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{transpose check cuda}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{cdv0}\PY{o}{\PYZhy{}}\PY{n}{temp}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{T}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{cdv0}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{cdv0}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{cdu(transposed inputs transpose}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{float32}\PY{p}{(}\PY{n}{temp}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{T}\PY{p}{)}
        
        
        \PY{n}{temp} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros\PYZus{}like}\PY{p}{(}\PY{n}{u}\PY{p}{)}
        \PY{n}{dudt\PYZus{}drive\PYZus{}numba}\PY{p}{(}\PY{n}{h}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{n}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{f}\PY{o}{.}\PY{n}{T}\PY{p}{,}  \PY{n}{v}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{u}\PY{o}{.}\PY{n}{T}\PY{p}{,} \PY{n}{dy}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{temp}\PY{p}{,}\PYZbs{}
                                  \PY{n}{grav}\PY{p}{,} \PY{n}{cori}\PY{p}{,} \PY{n}{advx}\PY{p}{,} \PY{n}{advy}\PY{p}{,} \PY{n}{attn}\PY{p}{,}\PY{n}{nu}\PY{p}{,}\PY{n}{mu}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{transpose numba check}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(} \PY{n}{dv0}\PY{o}{\PYZhy{}}\PY{n}{temp}\PY{o}{.}\PY{n}{T}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{dv0}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{dv0}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{du(transposed inputs) transposed}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{n}{temp}\PY{o}{.}\PY{n}{T}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{ \PYZhy{}\PYZhy{}\PYZhy{}}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}       
               
               
        
        
        \PY{n}{v1} \PY{o}{=} \PY{n}{v}\PY{o}{+} \PY{p}{(}\PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{gamma}\PY{o}{+}\PY{n}{eps}\PY{o}{+}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+}\PY{p}{(}\PY{n}{p5}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PYZbs{}
                 \PY{o}{+}\PY{n}{gamma}\PY{o}{*}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{+}\PY{n}{eps}\PY{o}{*}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{)}\PY{o}{*}\PY{n}{dt}
        \PY{n}{temp} \PY{o}{=} \PY{n}{nb}\PY{o}{.}\PY{n}{cuda}\PY{o}{.}\PY{n}{device\PYZus{}array\PYZus{}like}\PY{p}{(}\PY{n}{v}\PY{p}{)}
        \PY{n}{lincomb5\PYZus{}cuda}\PY{p}{[}\PY{n}{gridv}\PY{p}{,}\PY{n}{threadblock}\PY{p}{]}\PY{p}{(}\PY{n}{cv}\PY{p}{,} \PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{3}\PY{p}{]}\PY{p}{,}\PYZbs{}
                        \PY{n}{one}\PY{p}{,} \PY{p}{(}\PY{n}{p5}\PY{o}{+}\PY{n}{gamma}\PY{o}{+}\PY{n}{eps}\PY{o}{+}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{p}{(}\PY{n}{p5}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{gamma}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{o}{\PYZhy{}}\PY{n}{eps}\PY{p}{)}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PYZbs{}
                                      \PY{n}{gamma}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{n}{eps}\PY{o}{*}\PY{n}{dt}\PY{p}{,} \PY{n}{temp}\PY{p}{)}
        
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{lincomb check V}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{v1}\PY{o}{\PYZhy{}}\PY{n}{temp}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}      
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{v1}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{temp}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        
        
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{genfb cuda cross check}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        
        \PY{n}{tcdu}\PY{p}{,}\PY{n}{tcdv}\PY{p}{,}\PY{n}{tcdn} \PY{o}{=}\PY{n}{genfb\PYZus{}py}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{cnorig}\PY{p}{,} \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{cf}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,}\PYZbs{}
                      \PY{n}{cdu}\PY{p}{,}\PY{n}{cdv}\PY{p}{,}\PY{n}{cdn}\PY{p}{,} \PY{n}{gridu}\PY{p}{,}\PY{n}{gridv}\PY{p}{,}\PY{n}{gridn}\PY{p}{,} \PY{n}{threadblock}\PY{p}{,}\PYZbs{}
                      \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{0.281105}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{0.013}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.0880}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,} \PYZbs{}
                      \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt\PYZus{}drive\PYZus{}cuda}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt\PYZus{}drive\PYZus{}cuda}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt\PYZus{}drive\PYZus{}cuda}\PY{p}{,} \PYZbs{}
                      \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PYZbs{}
                        \PY{p}{)}
        \PY{n}{tn}\PY{p}{,}\PY{n}{tu}\PY{p}{,}\PY{n}{tv}\PY{p}{,}\PY{n}{tdu}\PY{p}{,}\PY{n}{tdv}\PY{p}{,}\PY{n}{tdn} \PY{o}{=}  \PY{n}{genfb}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{norig}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,}\PYZbs{}
                      \PY{n}{du}\PY{p}{,}\PY{n}{dv}\PY{p}{,}\PY{n}{dn}\PY{p}{,}\PYZbs{}
                      \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{0.281105}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{0.013}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.0880}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,} \PYZbs{}
                      \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PYZbs{}
                      \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PYZbs{}
                        \PY{p}{)}
        
        \PY{n}{norig}\PY{p}{[}\PY{p}{:}\PY{p}{]} \PY{o}{=}\PY{n}{tn}
        \PY{n}{uorig}\PY{p}{[}\PY{p}{:}\PY{p}{]} \PY{o}{=}\PY{n}{tu}
        \PY{n}{vorig}\PY{p}{[}\PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{n}{tv}  \PY{c+c1}{\PYZsh{} track the in\PYZhy{}place updates}
        
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{numba\PYZhy{}cuda cv check}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{tv}\PY{o}{\PYZhy{}}\PY{n}{cv}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{diff}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{tv}\PY{o}{\PYZhy{}}\PY{n}{cv}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}print(tv.copy\PYZus{}to\PYZus{}host())}
        \PY{c+c1}{\PYZsh{}print(v1)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{cdv0}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{cdv0}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{cdv new}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{c+c1}{\PYZsh{}tcdv[3][0,0]= 99.0}
        \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{tcdv}\PY{p}{:}
            \PY{n+nb}{print} \PY{p}{(}\PY{n}{i}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{p}{)}
        
        
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{genfb numba check}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}  \PY{c+c1}{\PYZsh{} not working yet becaus need to evolve n too!}
        
        
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{cv check}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{v1}\PY{o}{\PYZhy{}}\PY{n}{tv}\PY{p}{)}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{diff}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{v1}\PY{o}{\PYZhy{}}\PY{n}{tv}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{genfb v}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{tv}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{manual v}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{v1}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{dv new}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{tdv}\PY{p}{:}
            \PY{n+nb}{print} \PY{p}{(}\PY{n}{i}\PY{p}{)}
            \PY{n+nb}{print}\PY{p}{(}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{dv0}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{dv0}\PY{p}{)}
        
        \PY{n}{n}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v} \PY{o}{=} \PY{n}{tn}\PY{p}{,}\PY{n}{tu}\PY{p}{,}\PY{n}{tv}  \PY{c+c1}{\PYZsh{} propaget side effects of in\PYZhy{}place cuda ops}
        
        \PY{k}{del} \PY{n}{temp}\PY{p}{,}\PY{n}{v1}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{=======}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{du}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{du}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{cdu}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{cdu}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{diff}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{du}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{cdu}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{dv}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{cdv}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{diff}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{diff d0 d1}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{diff cd0 dc1}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{o}{\PYZhy{}}\PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{= state var check==}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{n}\PY{o}{\PYZhy{}}\PY{n}{cn}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{u}\PY{o}{\PYZhy{}}\PY{n}{cu}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{v}\PY{o}{\PYZhy{}}\PY{n}{cv}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{f}\PY{o}{\PYZhy{}}\PY{n}{cf}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{n}{h}\PY{o}{\PYZhy{}}\PY{n}{ch}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{)}
        
        
        
        \PY{n}{fnum}\PY{o}{=}\PY{l+m+mi}{4000}
        
        \PY{k}{def} \PY{n+nf}{chart}\PY{p}{(}\PY{n}{tag}\PY{p}{,}\PY{n}{fnum}\PY{p}{,}\PY{n}{cdn}\PY{p}{,}\PY{n}{cdu}\PY{p}{,}\PY{n}{cdv}\PY{p}{,}\PY{n}{dn}\PY{p}{,}\PY{n}{du}\PY{p}{,}\PY{n}{dv}\PY{p}{)}\PY{p}{:}    
            \PY{n}{plt}\PY{o}{.}\PY{n}{figure}\PY{p}{(}\PY{n}{fnum}\PY{p}{)}
            \PY{n}{plt}\PY{o}{.}\PY{n}{clf}\PY{p}{(}\PY{p}{)}
            \PY{n}{z1} \PY{o}{=} \PY{p}{(}\PY{p}{(}\PY{n}{cdn}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{,}\PY{n}{dn} \PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{n}{cdu}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{,}\PY{n}{du}\PY{p}{)}\PY{p}{,}\PY{p}{(}\PY{n}{cdv}\PY{o}{.}\PY{n}{copy\PYZus{}to\PYZus{}host}\PY{p}{(}\PY{p}{)}\PY{p}{,}\PY{n}{dv}\PY{p}{)}\PY{p}{)}
            \PY{k}{for} \PY{n}{i}\PY{p}{,}\PY{n}{z2} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{z1}\PY{p}{)}\PY{p}{:}
                
                \PY{n}{m} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{z2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{z2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{/}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{z2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{o}{+}\PY{n}{np}\PY{o}{.}\PY{n}{abs}\PY{p}{(}\PY{n}{z2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}\PY{o}{+}\PY{l+m+mf}{1E\PYZhy{}2}\PY{p}{)}\PY{p}{)}
                \PY{n+nb}{print}\PY{p}{(}\PY{n}{tag}\PY{p}{,} \PY{n}{fnum}\PY{o}{\PYZhy{}}\PY{l+m+mi}{4000}\PY{p}{,}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{type }\PY{l+s+s2}{\PYZdq{}}\PY{p}{,}\PY{n}{i}\PY{p}{,}\PY{n}{m}\PY{p}{)}
                \PY{k}{if} \PY{p}{(}\PY{n}{m}\PY{o}{\PYZgt{}}\PY{l+m+mf}{1E\PYZhy{}7}\PY{p}{)}\PY{p}{:}
                    \PY{n+nb}{print}\PY{p}{(}\PY{n}{z2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{z2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}
                    \PY{n+nb}{print} \PY{p}{(}\PY{n}{z2}\PY{p}{)}
                    \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{++++++}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
                \PY{k}{for} \PY{n}{j}\PY{p}{,}\PY{n}{z3} \PY{o+ow}{in} \PY{n+nb}{enumerate}\PY{p}{(}\PY{n}{z2}\PY{p}{)}\PY{p}{:}
                        \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{,}\PY{n}{i}\PY{o}{*}\PY{l+m+mi}{3}\PY{o}{+}\PY{n}{j}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}
                        \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{z3}\PY{p}{)}
                \PY{n}{plt}\PY{o}{.}\PY{n}{subplot}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{,}\PY{n}{i}\PY{o}{*}\PY{l+m+mi}{3}\PY{o}{+}\PY{n}{j}\PY{o}{+}\PY{l+m+mi}{2}\PY{p}{)}
                \PY{n}{plt}\PY{o}{.}\PY{n}{imshow}\PY{p}{(}\PY{n}{z2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{\PYZhy{}}\PY{n}{z2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{)}       
            \PY{n}{plt}\PY{o}{.}\PY{n}{show}\PY{p}{(}\PY{p}{)}  
        \PY{k}{for} \PY{n}{k} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{:}   
            \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{=====  NUV ==========}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
            \PY{n}{chart}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{NUV}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{fnum}\PY{p}{,}\PY{n}{cn}\PY{p}{,}\PY{n}{cu}\PY{p}{,}\PY{n}{cv}\PY{p}{,}\PY{n}{n}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{)}
            \PY{n}{fnum}\PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
            \PY{n+nb}{print} \PY{p}{(}\PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{=====  DN Du DV ==========}\PY{l+s+s2}{\PYZdq{}}\PY{p}{)}
            \PY{n}{chart}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DN Du DV}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{fnum}\PY{p}{,}\PY{n}{cdn}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{cdu}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{cdv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{dn}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{du}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{n}{dv}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}
            \PY{n}{fnum}\PY{o}{+}\PY{o}{=}\PY{l+m+mi}{1}
           \PY{c+c1}{\PYZsh{} print (\PYZdq{}=====  DN Du DV ==========\PYZdq{})}
           \PY{c+c1}{\PYZsh{} chart(fnum,cdn[2],cdu[2],cdv[2],dn[2],du[2],dv[2])}
           \PY{c+c1}{\PYZsh{} fnum+=1}
        
        
            \PY{k}{for} \PY{n}{uu} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{:}
        
                \PY{n}{cdu}\PY{p}{,}\PY{n}{cdv}\PY{p}{,}\PY{n}{cdn} \PY{o}{=}\PY{n}{genfb\PYZus{}py}\PY{p}{(}\PY{n}{ch}\PY{p}{,} \PY{n}{cn}\PY{p}{,} \PY{n}{cu}\PY{p}{,} \PY{n}{cv}\PY{p}{,} \PY{n}{cf}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,}\PYZbs{}
                      \PY{n}{cdu}\PY{p}{,}\PY{n}{cdv}\PY{p}{,}\PY{n}{cdn}\PY{p}{,} \PY{n}{gridu}\PY{p}{,}\PY{n}{gridv}\PY{p}{,}\PY{n}{gridn}\PY{p}{,} \PY{n}{threadblock}\PY{p}{,}\PYZbs{}
                      \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{0.281105}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{0.013}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.0880}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,} \PYZbs{}
                      \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt\PYZus{}drive\PYZus{}cuda}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt\PYZus{}drive\PYZus{}cuda}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt\PYZus{}drive\PYZus{}cuda}\PY{p}{,} \PYZbs{}
                      \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PYZbs{}
                        \PY{p}{)}
        
                \PY{n}{n}\PY{p}{,}\PY{n}{u}\PY{p}{,}\PY{n}{v}\PY{p}{,}\PY{n}{du}\PY{p}{,}\PY{n}{dv}\PY{p}{,}\PY{n}{dn} \PY{o}{=}  \PY{n}{genfb}\PY{p}{(}\PY{n}{h}\PY{p}{,} \PY{n}{n}\PY{p}{,} \PY{n}{u}\PY{p}{,} \PY{n}{v}\PY{p}{,} \PY{n}{f}\PY{p}{,} \PY{n}{dt}\PY{p}{,} \PY{n}{dx}\PY{p}{,} \PY{n}{dy}\PY{p}{,}\PYZbs{}
                      \PY{n}{du}\PY{p}{,}\PY{n}{dv}\PY{p}{,}\PY{n}{dn}\PY{p}{,}\PYZbs{}
                      \PY{n}{beta}\PY{o}{=}\PY{l+m+mf}{0.281105}\PY{p}{,} \PY{n}{eps}\PY{o}{=}\PY{l+m+mf}{0.013}\PY{p}{,} \PY{n}{gamma}\PY{o}{=}\PY{l+m+mf}{0.0880}\PY{p}{,} \PY{n}{mu}\PY{o}{=}\PY{n}{mu}\PY{p}{,} \PY{n}{nu}\PY{o}{=}\PY{n}{nu}\PY{p}{,} \PYZbs{}
                      \PY{n}{dudt\PYZus{}x}\PY{o}{=}\PY{n}{dudt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dvdt\PYZus{}x}\PY{o}{=}\PY{n}{dvdt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PY{n}{dndt\PYZus{}x}\PY{o}{=}\PY{n}{dndt\PYZus{}drive\PYZus{}numba}\PY{p}{,} \PYZbs{}
                      \PY{n}{grav}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{cori}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advx}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{advy}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{attn}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}\PYZbs{}
                        \PY{p}{)}
\end{Verbatim}



    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
